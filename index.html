<!DOCTYPE html>
<html lang="tr" class="h-full">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content" />
  <title>AI Chat + Research v18</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a0a0a">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.puter.com/v2/"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }
    });
  </script>
  <style>
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    html {
      font-size: 14px;
    }

    @media (min-width: 1536px) {
      html {
        font-size: 15px;
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .mono {
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    /* Sidebar */
    .sidebar {
      background: #0a0a0a;
      border-right: 1px solid #1a1a1a;
    }

    .sidebar-item {
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .sidebar-item:hover {
      background: #1a1a1a;
    }

    .sidebar-item.active {
      background: #1e1e1e;
    }

    /* Header */
    .top-header {
      background: #0f0f0f;
      border-bottom: 1px solid #1a1a1a;
    }

    /* Messages */
    .msg-user-bubble {
      background: #2563eb;
      border-radius: 20px 20px 4px 20px;
    }

    .msg-ai-block {
      color: #e2e8f0;
    }

    body.hide-thinking .thinking-block { display: none !important; }

    /* Thinking block */
    .thinking-block {
      background: #111;
      border: 1px solid #222;
      border-radius: 12px;
    }

    .thinking-block summary {
      cursor: pointer;
      user-select: none;
    }

    .thinking-block[open] summary svg:last-child {
      transform: rotate(180deg);
    }

    /* Live thinking animation */
    @keyframes thinking-glow {

      0%,
      100% {
        border-color: #222;
      }

      50% {
        border-color: #7c3aed44;
      }
    }

    .thinking-block.live {
      animation: thinking-glow 2s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .animate-spin {
      animation: spin 2s linear infinite;
    }

    /* Code blocks */
    .code-container {
      background: #0d1117;
      border: 1px solid #21262d;
      border-radius: 10px;
      overflow: hidden;
      margin: 12px 0;
    }

    .code-header {
      background: #161b22;
      padding: 8px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #21262d;
    }

    .code-header span {
      font-size: 11px;
      color: #8b949e;
      font-weight: 600;
      text-transform: uppercase;
      font-family: 'JetBrains Mono', monospace;
    }

    .code-body {
      padding: 16px;
      overflow-x: auto;
    }

    .code-body pre {
      margin: 0;
      font-size: 13px;
      line-height: 1.6;
      color: #c9d1d9;
      white-space: pre;
      font-family: 'JetBrains Mono', ui-monospace, monospace;
    }

    .code-btn {
      background: none;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 4px 10px;
      color: #8b949e;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .code-btn:hover {
      background: #21262d;
      color: #e6edf3;
    }

    /* Animations */
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: slideUp 0.25s ease-out forwards;
    }

    @keyframes pulse-dot {

      0%,
      100% {
        opacity: 0.3;
      }

      50% {
        opacity: 1;
      }
    }

    .dot-pulse {
      animation: pulse-dot 1.2s infinite;
    }

    .dot-pulse:nth-child(2) {
      animation-delay: 0.15s;
    }

    .dot-pulse:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes live-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(0.8); }
    }
    .live-pulse-dot {
      animation: live-pulse 1s ease-in-out infinite;
    }
    .fmt-btn.active {
      border-color: #3b82f6;
      color: #fff;
      background: rgba(59,130,246,0.15);
    }

    /* Input area */
    .input-box {
      background: #111;
      border: 1px solid #222;
      border-radius: 24px;
      transition: border-color 0.2s;
    }

    .input-box:focus-within {
      border-color: #333;
    }

    /* ===== ADAPTIVE MOBILE SYSTEM ===== */
    /* Dynamic viewport height (handles mobile browser chrome) */
    :root {
      --vh: 1vh;
      --app-height: 100vh;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --header-h: 56px;
      --input-area-h: auto;
    }

    @supports (height: 100dvh) {
      :root {
        --app-height: 100dvh;
      }
    }

    /* Tablet: 768px - 1024px */
    @media (max-width: 1024px) and (min-width: 769px) {
      .top-header {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }

      #chat-window {
        padding-left: 1rem;
        padding-right: 1rem;
      }

      #header-action-btns button {
        padding: 6px 8px;
        font-size: 10px;
      }
    }

    /* Mobile: <= 768px */
    @media (max-width: 768px) {

      html,
      body {
        height: var(--app-height);
        height: 100dvh;
        overflow: hidden;
      }

      body {
        padding-top: var(--safe-top);
        padding-bottom: var(--safe-bottom);
        padding-left: var(--safe-left);
        padding-right: var(--safe-right);
      }

      /* Sidebar */
      #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 85%;
        max-width: 320px;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      #sidebar.mobile-open {
        transform: translateX(0);
        display: flex;
      }

      /* Header - iOS style with blur */
      .top-header {
        height: clamp(52px, 8vh, 60px);
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        --header-h: clamp(52px, 8vh, 60px);
        position: relative;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        background: rgba(13, 13, 13, 0.88) !important;
      }

      .top-header .flex.items-center.gap-3 {
        gap: 0.5rem;
      }

      /* Center model selector on mobile */
      #mobile-selector-wrap {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 9999px !important;
        padding: 7px 14px !important;
      }

      /* Show mobile-more-btn on mobile */
      #mobile-more-btn {
        display: flex !important;
      }

      /* Hide version label, keep search btn */
      .top-header span.font-mono {
        display: none;
      }

      /* Chat window */
      #chat-window {
        padding: 0.75rem 1rem 10rem 1rem;
      }

      /* Welcome screen iOS sizing */
      #welcome-icon {
        width: 80px;
        height: 80px;
        border-radius: 22px;
        margin-bottom: 24px;
      }

      #welcome-icon-svg {
        width: 40px;
        height: 40px;
      }

      #welcome-title {
        font-size: clamp(1.6rem, 7vw, 2.2rem);
        margin-bottom: 12px;
        padding: 0 8px;
      }

      #welcome-sub {
        font-size: 14px;
        margin-bottom: 32px;
        color: #6b7280;
      }

      #welcome-cards {
        gap: 10px;
      }

      .welcome-card {
        border-radius: 20px !important;
        background: rgba(255, 255, 255, 0.04) !important;
        border-color: rgba(255, 255, 255, 0.07) !important;
        padding: 16px !important;
      }

      /* Canvas full-screen on mobile */
      .canvas-panel {
        position: fixed !important;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100% !important;
        min-width: 0 !important;
        max-width: 100% !important;
        z-index: 90;
      }

      /* Messages */
      .msg-user-bubble {
        max-width: 90% !important;
      }

      /* Input area - iOS gradient background */
      .absolute.bottom-0 {
        padding: 0 !important;
        padding-bottom: 0 !important;
        background: linear-gradient(to top, #0d0d0d 55%, #0d0d0d 70%, rgba(13,13,13,0.0) 100%) !important;
      }

      .absolute.bottom-0 > div {
        padding: 8px 12px 12px !important;
        padding-bottom: calc(12px + var(--safe-bottom)) !important;
        max-width: 100% !important;
      }

      /* iOS card input box */
      .input-box {
        flex-wrap: wrap !important;
        padding: 12px 8px 6px 12px !important;
        background: #171717 !important;
        border: 1px solid #2a2a2a !important;
        border-radius: 28px !important;
        gap: 2px !important;
        align-items: center !important;
        min-height: unset;
      }

      /* Textarea - full width top row */
      #user-input {
        order: 1;
        flex: 1 1 100% !important;
        padding: 0 4px 10px !important;
        min-height: 36px;
        font-size: 15px !important;
        color: #d1d5db;
      }

      /* Action buttons - bottom row */
      #upload-btn, #screen-capture-btn, #mic-btn, #ocr-btn {
        order: 2;
        width: 38px;
        height: 38px;
        min-width: 38px;
        min-height: 38px;
      }

      /* Voice btn - pushed right */
      #voice-conv-btn {
        order: 2;
        width: 38px;
        height: 38px;
        min-width: 38px;
        min-height: 38px;
        margin-left: auto;
      }

      /* Send / Stop - right of voice */
      #send-btn,
      #stop-btn {
        order: 2;
        width: 44px;
        height: 44px;
        min-width: 44px;
        min-height: 44px;
        border-radius: 20px !important;
      }

      /* Format bar - iOS pill style */
      #format-bar {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        flex-wrap: nowrap !important;
        padding-bottom: 2px;
        gap: 6px !important;
        margin-bottom: 8px !important;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      #format-bar::-webkit-scrollbar {
        display: none;
      }

      #format-bar .fmt-btn {
        border-radius: 9999px !important;
        padding: 6px 14px !important;
        font-size: 11px !important;
        white-space: nowrap;
        flex-shrink: 0;
        border-color: #333 !important;
      }

      .fmt-bar-label {
        font-size: 11px !important;
        white-space: nowrap;
        flex-shrink: 0;
        opacity: 0.6;
      }

      /* Mobile action chips scroll */
      .flex.sm\\:hidden.items-center.gap-1 {
        gap: 6px !important;
        padding-bottom: 0 !important;
        margin-bottom: 8px !important;
      }

      /* File preview on mobile */
      #file-preview-container {
        border-radius: 16px !important;
      }

      /* Code blocks */
      .code-container {
        margin: 8px 0;
      }

      .code-body {
        padding: 10px;
      }

      .code-body pre {
        font-size: clamp(10px, 2.5vw, 13px);
      }

      /* Images */
      .prose img {
        max-height: 240px !important;
      }

      /* Message bubbles - rounder on mobile */
      .msg-user-bubble {
        border-radius: 22px 22px 6px 22px !important;
      }

      /* Mobile quick-action chips - hidden for cleaner look, replaced by format bar */
      .flex.sm\\:hidden.items-center.gap-1.mb-2 {
        display: none !important;
      }

      /* Canvas tabs on mobile - pill style */
      .canvas-tabs {
        background: #1a1a1a;
        border-radius: 12px;
        padding: 3px;
        border: 1px solid #252525;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .canvas-tabs .canvas-tab {
        border-radius: 9px !important;
        padding: 6px 12px !important;
        font-size: 11px !important;
      }

      /* Modals - must account for dynamic viewport */
      #settings-modal>div:last-child {
        max-height: 85vh;
        max-height: 85dvh;
        overflow-y: auto;
      }

      /* Compare mode exit */
      .compare-live-exit {
        top: 4px;
        right: 4px;
        font-size: 9px;
        padding: 4px 8px;
      }

      /* Slide Preview Modal */
      #slide-preview-modal > div:first-child {
        padding: 10px 12px;
        gap: 8px;
      }
      #slide-preview-title {
        font-size: 12px;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #slide-preview-count {
        display: none;
      }
      #slide-preview-dl-btn {
        padding: 7px 10px;
        font-size: 11px;
      }
      #slide-preview-grid {
        padding: 10px;
        gap: 10px;
        grid-template-columns: 1fr !important;
      }

      /* Canvas Diff View */
      #canvas-diff-view {
        padding: 10px !important;
        font-size: 11px !important;
      }

      /* Canvas tabs - 4 tabs on mobile: smaller padding */
      .canvas-tabs .canvas-tab {
        padding: 5px 9px;
        font-size: 11px;
        gap: 3px;
      }
      .canvas-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Settings modal prompt library */
      #slide-preview-modal .flex.items-center.justify-between {
        flex-wrap: wrap;
        gap: 6px;
      }
    }

    /* Small phones: <= 640px */
    @media (max-width: 640px) {
      #model-a {
        min-width: 70px !important;
        font-size: clamp(10px, 2.8vw, 12px) !important;
      }

      .top-header .bg-\[\#1a1a1a\] {
        padding: 3px 6px !important;
      }

      #welcome-msg h2 {
        font-size: clamp(1.1rem, 5vw, 1.5rem);
      }

      #welcome-msg p {
        font-size: clamp(0.75rem, 3vw, 0.9rem);
      }

      #welcome-msg .grid {
        gap: 6px;
        grid-template-columns: 1fr !important;
      }

      #welcome-msg button {
        padding: 10px !important;
      }

      .absolute.bottom-0 {
        padding: 0.4rem !important;
        padding-bottom: calc(0.4rem + var(--safe-bottom)) !important;
      }

      .input-box {
        padding: 4px !important;
      }

      /* Slide preview - full single column */
      #slide-preview-grid {
        padding: 8px !important;
        gap: 8px !important;
      }

      /* Prompt library save button - wrap on small phones */
      .prompt-lib-header {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 4px;
      }

      /* Diff view smaller font */
      #canvas-diff-view {
        font-size: 10px !important;
        padding: 8px !important;
      }
    }

    /* Very small phones (< 375px, e.g. iPhone SE, Galaxy Fold) */
    @media (max-width: 374px) {
      .top-header {
        height: 40px;
        padding: 0 4px;
      }

      #model-a {
        min-width: 60px !important;
        font-size: 9px !important;
      }

      #menu-btn {
        padding: 4px;
      }

      #menu-btn svg {
        width: 16px;
        height: 16px;
      }

      #send-btn,
      #stop-btn {
        width: 38px;
        height: 38px;
        min-width: 38px;
        min-height: 38px;
      }

      #upload-btn,
      #mic-btn {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
      }

      #user-input {
        min-height: 36px;
        font-size: 15px !important;
        padding: 6px 8px;
      }

      .input-box {
        gap: 2px !important;
      }

      #chat-window {
        padding: 0.5rem 0.25rem 8rem 0.25rem;
      }

      .msg-user-bubble {
        max-width: 95% !important;
        font-size: 13px;
      }

      .code-body pre {
        font-size: 9px;
      }

      /* Slide preview ultra-compact header */
      #slide-preview-modal > div:first-child {
        padding: 8px 10px;
      }
      #slide-preview-title {
        font-size: 11px;
        max-width: 90px;
      }
      #slide-preview-dl-btn {
        padding: 6px 8px;
        font-size: 10px;
      }

      /* Canvas tabs: icon-only on very small screens */
      .canvas-tabs .canvas-tab {
        padding: 6px 7px !important;
        font-size: 0 !important;
        gap: 0 !important;
      }
      .canvas-tabs .canvas-tab svg {
        width: 13px !important;
        height: 13px !important;
        flex-shrink: 0;
      }
    }

    /* Short screens / landscape phones */
    @media (max-height: 500px) {
      .top-header {
        height: 36px;
      }

      #welcome-msg {
        padding: 8px;
      }

      #welcome-msg .w-16 {
        width: 32px;
        height: 32px;
        margin-bottom: 8px;
      }

      #welcome-msg .w-16 svg {
        width: 16px;
        height: 16px;
      }

      #welcome-msg h2 {
        font-size: 1rem;
        margin-bottom: 4px;
      }

      #welcome-msg p {
        font-size: 0.75rem;
        margin-bottom: 8px;
      }

      #welcome-msg .grid {
        display: none;
      }

      #chat-window {
        padding-top: 0.25rem;
        padding-bottom: 7rem;
      }

      .absolute.bottom-0 {
        padding: 0.25rem !important;
      }
    }

    /* Landscape orientation on mobile */
    @media (max-height: 500px) and (orientation: landscape) {
      #sidebar {
        width: 50%;
        max-width: 280px;
      }

      #chat-window {
        padding-bottom: 5rem;
      }

      .absolute.bottom-0 {
        padding: 0.25rem 1rem !important;
      }

      .input-box {
        min-height: 36px;
      }

      #user-input {
        min-height: 30px;
      }
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Markdown prose */
    .prose p {
      margin: 0.5em 0;
    }

    .prose ul,
    .prose ol {
      margin: 0.5em 0;
      padding-left: 1.5em;
    }

    .prose li {
      margin: 0.25em 0;
    }

    .prose h1,
    .prose h2,
    .prose h3 {
      margin: 0.75em 0 0.25em;
      font-weight: 700;
    }

    .prose h1 {
      font-size: 1.3em;
    }

    .prose h2 {
      font-size: 1.15em;
    }

    .prose h3 {
      font-size: 1.05em;
    }

    .prose a {
      color: #60a5fa;
      text-decoration: underline;
    }

    .prose strong {
      color: #f1f5f9;
    }

    .prose blockquote {
      border-left: 3px solid #334155;
      padding-left: 12px;
      color: #94a3b8;
      margin: 0.5em 0;
    }

    .prose table {
      border-collapse: collapse;
      margin: 0.5em 0;
    }

    .prose th,
    .prose td {
      border: 1px solid #334155;
      padding: 6px 12px;
      font-size: 13px;
    }

    .prose th {
      background: #1e293b;
    }

    /* Light Mode */
    body.light-mode {
      background-color: #ffffff;
      color: #1a1a2e;
    }

    body.light-mode ::-webkit-scrollbar-thumb {
      background: #c4c4c4;
    }

    /* Sidebar */
    body.light-mode .sidebar {
      background: #f7f7f8;
      border-right-color: #e5e5e5;
    }

    body.light-mode .sidebar-item {
      color: #555;
    }

    body.light-mode .sidebar-item:hover {
      background: #ebebeb;
      color: #111;
    }

    body.light-mode .sidebar-item.active {
      background: #e2e2e2;
      color: #111;
    }

    body.light-mode #new-chat-btn {
      background: #e8e8e8;
      border-color: #ddd;
      color: #111;
    }

    body.light-mode #new-chat-btn:hover {
      background: #ddd;
    }

    body.light-mode #settings-btn,
    body.light-mode #reset-btn {
      color: #888;
    }

    body.light-mode #settings-btn:hover {
      color: #333;
      background: #eee;
    }

    body.light-mode #reset-btn:hover {
      color: #dc2626;
      background: #fef2f2;
    }

    body.light-mode #search-input {
      background: #efefef;
      border-color: #ddd;
      color: #333;
    }

    body.light-mode #search-input::placeholder {
      color: #aaa;
    }

    body.light-mode .sidebar .border-t {
      border-color: #e5e5e5;
    }

    body.light-mode .text-neutral-600 {
      color: #999 !important;
    }

    /* Header */
    body.light-mode .top-header {
      background: #ffffff;
      border-bottom-color: #e5e5e5;
    }

    body.light-mode .top-header select {
      color: #1a1a1a;
    }

    body.light-mode .top-header .bg-\[\\#1a1a1a\],
    body.light-mode [class*="bg-[#1a1a1a]"] {
      background: #f0f0f0 !important;
      border-color: #ddd !important;
    }

    body.light-mode .top-header button {
      color: #777;
    }

    body.light-mode .top-header button:hover {
      color: #333;
    }

    body.light-mode .top-header .text-neutral-500 {
      color: #777 !important;
    }

    /* Main area */
    body.light-mode main {
      background: #ffffff;
    }

    body.light-mode .bg-\[\\#0f0f0f\] {
      background: #ffffff !important;
    }

    /* Messages */
    body.light-mode .msg-user-bubble {
      background: #2563eb;
      color: #fff;
    }

    body.light-mode .msg-ai-block {
      color: #374151;
    }

    body.light-mode .msg-ai-block .text-neutral-500 {
      color: #888 !important;
    }

    /* Thinking block */
    body.light-mode .thinking-block {
      background: #f9f9fb;
      border-color: #e5e5e5;
    }

    body.light-mode .thinking-block summary {
      color: #666;
    }

    body.light-mode .thinking-block summary:hover {
      color: #333;
    }

    body.light-mode .thinking-block .border-t {
      border-color: #e5e5e5;
    }

    body.light-mode .thinking-block .text-neutral-500 {
      color: #888 !important;
    }

    /* Code blocks */
    body.light-mode .code-container {
      background: #f6f8fa;
      border-color: #d8dee4;
    }

    body.light-mode .code-header {
      background: #eff2f5;
      border-bottom-color: #d8dee4;
    }

    body.light-mode .code-header span {
      color: #656d76;
    }

    body.light-mode .code-body pre {
      color: #24292f;
    }

    body.light-mode .code-btn {
      border-color: #d0d7de;
      color: #656d76;
    }

    body.light-mode .code-btn:hover {
      background: #e5e9ed;
      color: #24292f;
    }

    /* Input area */
    body.light-mode .input-box {
      background: #ffffff;
      border-color: #d8d8d8;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
    }

    body.light-mode .input-box:focus-within {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
    }

    body.light-mode #user-input {
      color: #1a1a1a;
    }

    body.light-mode #user-input::placeholder {
      color: #aaa;
    }

    body.light-mode #upload-btn,
    body.light-mode #mic-btn {
      color: #999;
    }

    body.light-mode #upload-btn:hover {
      color: #333;
    }

    body.light-mode #mic-btn:hover {
      color: #dc2626;
    }

    #voice-conv-btn.vc-active {
      color: #22c55e;
      background: rgba(34, 197, 94, 0.12);
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3);
    }

    #voice-conv-btn.vc-listening {
      color: #22c55e;
      background: rgba(34, 197, 94, 0.18);
      animation: vcPulse 1s ease-in-out infinite;
    }

    @keyframes vcPulse {
      0%, 100% { box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3); }
      50% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.1); }
    }

    #ocr-btn.ocr-active {
      color: #f59e0b;
      background: rgba(245, 158, 11, 0.12);
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3);
    }

    #ocr-btn.ocr-processing {
      color: #f59e0b;
      animation: ocrPulse 0.8s ease-in-out infinite;
    }

    @keyframes ocrPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    #voice-overlay {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 9999;
      background: linear-gradient(to top, #0a0a0a 0%, rgba(10,10,10,0.97) 80%, transparent 100%);
      padding: 28px 24px 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      border-top: 1px solid #1a1a1a;
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.32,0.72,0,1);
    }

    #voice-overlay.visible {
      transform: translateY(0);
    }

    .voice-bars {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 40px;
    }

    .voice-bar {
      width: 4px;
      background: #22c55e;
      border-radius: 2px;
      transition: height 0.1s ease;
    }

    .voice-bar.ai-bar {
      background: #3b82f6;
    }

    @keyframes barListen {
      0%, 100% { height: 6px; }
      50% { height: 32px; }
    }

    @keyframes barSpeak {
      0%, 100% { height: 8px; }
      50% { height: 36px; }
    }

    .voice-overlay-state-listening .voice-bar {
      animation: barListen 0.6s ease-in-out infinite;
    }

    .voice-overlay-state-listening .voice-bar:nth-child(2) { animation-delay: 0.1s; }
    .voice-overlay-state-listening .voice-bar:nth-child(3) { animation-delay: 0.2s; }
    .voice-overlay-state-listening .voice-bar:nth-child(4) { animation-delay: 0.1s; }
    .voice-overlay-state-listening .voice-bar:nth-child(5) { animation-delay: 0s; }

    .voice-overlay-state-speaking .voice-bar.ai-bar {
      animation: barSpeak 0.4s ease-in-out infinite;
    }

    .voice-overlay-state-speaking .voice-bar.ai-bar:nth-child(2) { animation-delay: 0.05s; }
    .voice-overlay-state-speaking .voice-bar.ai-bar:nth-child(3) { animation-delay: 0.1s; }
    .voice-overlay-state-speaking .voice-bar.ai-bar:nth-child(4) { animation-delay: 0.15s; }
    .voice-overlay-state-speaking .voice-bar.ai-bar:nth-child(5) { animation-delay: 0.08s; }

    #voice-interim {
      font-size: 13px;
      color: #94a3b8;
      text-align: center;
      min-height: 20px;
      font-style: italic;
      max-width: 480px;
      transition: opacity 0.2s;
    }

    body.light-mode .from-\[\\#0f0f0f\] {
      --tw-gradient-from: #ffffff !important;
    }

    body.light-mode .via-\[\\#0f0f0f\]\/95 {
      --tw-gradient-stops: var(--tw-gradient-from), rgba(255, 255, 255, 0.95), var(--tw-gradient-to) !important;
    }

    /* Welcome */
    body.light-mode #welcome-msg h2 {
      color: #111;
    }

    body.light-mode #welcome-msg p {
      color: #888;
    }

    body.light-mode #welcome-msg button {
      background: #f5f5f5;
      border-color: #e5e5e5;
    }

    body.light-mode #welcome-msg button:hover {
      background: #eee;
    }

    body.light-mode #welcome-msg .text-neutral-400 {
      color: #555 !important;
    }

    /* File preview */
    body.light-mode #file-preview-container {
      background: #f7f7f8;
      border-color: #e5e5e5;
    }

    /* Prose */
    body.light-mode .prose strong {
      color: #111;
    }

    body.light-mode .prose a {
      color: #2563eb;
    }

    body.light-mode .prose blockquote {
      border-left-color: #d0d7de;
      color: #666;
    }

    body.light-mode .prose th {
      background: #f0f3f6;
    }

    body.light-mode .prose th,
    body.light-mode .prose td {
      border-color: #d8dee4;
    }

    /* Modals */
    body.light-mode #settings-modal>div:last-child,
    body.light-mode #settings-modal>div:last-child,
    body.light-mode [id$="-modal-content"] {
      background: #ffffff !important;
      border-color: #e5e5e5 !important;
    }

    body.light-mode #settings-modal select,
    body.light-mode #settings-modal input,
    body.light-mode #settings-modal select,
    body.light-mode #settings-modal input,
    body.light-mode #settings-modal textarea {
      background: #f7f7f8 !important;
      border-color: #e0e0e0 !important;
      color: #1a1a1a !important;
    }

    body.light-mode #settings-modal h3 {
      color: #111 !important;
    }

    body.light-mode #settings-modal label span {
      color: #333 !important;
    }

    body.light-mode .bg-white\/\[0\.02\] {
      background: #f7f7f8 !important;
      border-color: #e5e5e5 !important;
    }

    /* Dot pulse light */
    body.light-mode .dot-pulse {
      background: #2563eb;
    }

    /* Canvas Panel */
    .canvas-panel {
      width: 50%;
      min-width: 400px;
      max-width: 60%;
      background: #0a0a0a;
      border-left: 1px solid #1a1a1a;
      display: flex;
      flex-direction: column;
      transition: width 0.3s;
    }

    .canvas-toolbar-btn {
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 8px;
      transition: all 0.15s;
    }

    .canvas-toolbar-btn:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.06);
    }

    .canvas-panel.hidden {
      display: none;
    }

    .canvas-header {
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      border-bottom: 1px solid #1a1a1a;
      background: #0f0f0f;
      flex-shrink: 0;
    }

    .canvas-tabs {
      display: flex;
      gap: 2px;
      background: #1a1a1a;
      border-radius: 8px;
      padding: 2px;
    }

    .canvas-tab {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 12px;
      color: #777;
      cursor: pointer;
      border: none;
      background: none;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.15s;
    }

    .canvas-tab:hover {
      color: #ccc;
    }

    .canvas-tab.active {
      background: #2a2a2a;
      color: #fff;
    }

    .header-canvas-tabs {
      display: flex;
      gap: 2px;
      background: #1a1a1a;
      border-radius: 8px;
      padding: 2px;
      border: 1px solid #222;
    }

    .header-canvas-tabs .canvas-tab {
      padding: 6px 12px;
      font-size: 11px;
    }

    .canvas-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .canvas-file-tree {
      width: 220px;
      border-right: 1px solid #1a1a1a;
      overflow-y: auto;
      padding: 12px 0;
      background: #0a0a0a;
    }

    .canvas-file-tree .ft-title {
      font-size: 11px;
      font-weight: 700;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 8px 16px;
    }

    .canvas-file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 16px 6px 20px;
      cursor: pointer;
      font-size: 12px;
      color: #888;
      transition: all 0.1s;
    }

    .canvas-file-item:hover {
      background: #1a1a1a;
      color: #ddd;
    }

    .canvas-file-item.active {
      background: #1e1e1e;
      color: #fff;
    }

    .canvas-file-item.folder {
      color: #aaa;
      font-weight: 600;
      padding-left: 16px;
    }

    .canvas-file-icon {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .ft-icon-html {
      background: #e44d26;
      color: #fff;
    }

    .ft-icon-css {
      background: #264de4;
      color: #fff;
    }

    .ft-icon-js {
      background: #f7df1e;
      color: #000;
    }

    .ft-icon-ts {
      background: #3178c6;
      color: #fff;
    }

    .ft-icon-tsx {
      background: #61dafb;
      color: #000;
    }

    .ft-icon-json {
      background: #5b5b5b;
      color: #fff;
    }

    .ft-icon-py {
      background: #3776ab;
      color: #fff;
    }

    .ft-icon-cpp {
      background: #00599c;
      color: #fff;
    }

    .ft-icon-c {
      background: #a8b9cc;
      color: #000;
    }

    .ft-icon-h {
      background: #7a8a99;
      color: #fff;
    }

    .ft-icon-hpp {
      background: #5e7a99;
      color: #fff;
    }

    .ft-icon-java {
      background: #b07219;
      color: #fff;
    }

    .ft-icon-rs {
      background: #dea584;
      color: #000;
    }

    .ft-icon-go {
      background: #00add8;
      color: #fff;
    }

    .ft-icon-rb {
      background: #cc342d;
      color: #fff;
    }

    .ft-icon-php {
      background: #777bb4;
      color: #fff;
    }

    .ft-icon-sh {
      background: #4eaa25;
      color: #fff;
    }

    .ft-icon-md {
      background: #555;
      color: #fff;
    }

    .ft-icon-folder {
      background: none;
      color: #f0c36d;
      font-size: 14px;
    }

    .ft-icon-default {
      background: #444;
      color: #fff;
    }

    .canvas-file-content {
      flex: 1;
      overflow: auto;
      background: #0d1117;
    }

    .canvas-file-content pre {
      margin: 0;
      padding: 20px;
      font-size: 13px;
      line-height: 1.7;
      color: #c9d1d9;
      white-space: pre;
      font-family: 'JetBrains Mono', ui-monospace, monospace;
    }

    .canvas-preview {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #0a0a0a;
    }

    .canvas-preview iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #fff;
    }

    .canvas-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      color: #555;
      padding: 40px;
      text-align: center;
    }

    .canvas-empty-icon {
      font-size: 48px;
      opacity: 0.3;
    }

    .canvas-quick-files {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 12px;
    }

    .canvas-quick-file {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid #333;
      color: #aaa;
      background: #111;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }

    .canvas-quick-file:hover {
      background: #1a1a1a;
      color: #fff;
      border-color: #555;
    }

    .canvas-building {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .canvas-building-blocks {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .canvas-building-blocks div {
      width: 32px;
      height: 32px;
      background: #333;
      border-radius: 4px;
      animation: pulse-dot 1.5s infinite;
    }

    .canvas-building-blocks div:nth-child(2) {
      animation-delay: 0.2s;
    }

    .canvas-building-blocks div:nth-child(3) {
      animation-delay: 0.4s;
    }

    .canvas-building-blocks div:nth-child(4) {
      animation-delay: 0.1s;
    }

    .canvas-building-blocks div:nth-child(5) {
      animation-delay: 0.3s;
      height: 24px;
    }

    .canvas-building-blocks div:nth-child(6) {
      animation-delay: 0.5s;
    }

    /* Deep Research */
    .research-step {
      padding: 8px 16px;
      margin: 4px 0;
      border-left: 2px solid #6366f1;
      font-size: 12px;
      color: #94a3b8;
    }

    .research-step.done {
      border-left-color: #22c55e;
    }

    .research-step .step-title {
      font-weight: 600;
      color: #c4b5fd;
      margin-bottom: 2px;
    }

    .research-step.done .step-title {
      color: #86efac;
    }

    /* Canvas Light Mode */
    body.light-mode .canvas-panel {
      background: #fafafa;
      border-left-color: #e5e5e5;
    }

    body.light-mode .canvas-header {
      background: #fff;
      border-bottom-color: #e5e5e5;
    }

    body.light-mode .canvas-tabs {
      background: #f0f0f0;
    }

    body.light-mode .canvas-tab {
      color: #888;
    }

    body.light-mode .canvas-tab.active {
      background: #fff;
      color: #111;
    }

    body.light-mode .canvas-file-tree {
      background: #fafafa;
      border-right-color: #e5e5e5;
    }

    body.light-mode .canvas-file-item {
      color: #666;
    }

    body.light-mode .canvas-file-item:hover {
      background: #f0f0f0;
      color: #111;
    }

    body.light-mode .canvas-file-item.active {
      background: #e8e8e8;
      color: #111;
    }

    body.light-mode .canvas-file-content {
      background: #f6f8fa;
    }

    body.light-mode .canvas-file-content pre {
      color: #24292f;
    }

    body.light-mode .canvas-preview {
      background: #fafafa;
    }

    body.light-mode .canvas-quick-file {
      background: #fff;
      border-color: #ddd;
      color: #555;
    }

    body.light-mode .canvas-quick-file:hover {
      background: #f5f5f5;
      color: #111;
    }

    /* Message action buttons */
    .msg-actions {
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity 0.15s;
      margin-top: 4px;
    }

    .msg-wrap:hover .msg-actions {
      opacity: 1;
    }

    .msg-action-btn {
      background: none;
      border: 1px solid transparent;
      border-radius: 6px;
      padding: 3px 8px;
      color: #666;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 3px;
      transition: all 0.15s;
    }

    .msg-action-btn:hover {
      color: #ccc;
      background: rgba(255, 255, 255, 0.05);
      border-color: #333;
    }

    .msg-action-btn svg {
      width: 12px;
      height: 12px;
    }

    body.light-mode .msg-action-btn {
      color: #999;
    }

    body.light-mode .msg-action-btn:hover {
      color: #333;
      background: #f0f0f0;
      border-color: #ddd;
    }

    /* Stop button */
    .stop-btn {
      background: #dc2626 !important;
    }

    .stop-btn:hover {
      background: #b91c1c !important;
    }

    /* Drag-drop overlay */
    .drag-overlay {
      position: fixed;
      inset: 0;
      background: rgba(37, 99, 235, 0.12);
      border: 3px dashed #2563eb;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .drag-overlay-inner {
      background: #111;
      border: 2px solid #2563eb;
      border-radius: 20px;
      padding: 40px 60px;
      text-align: center;
    }

    /* Prompt templates */
    .prompt-chip {
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid #222;
      color: #aaa;
      background: #111;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .prompt-chip:hover {
      background: #1a1a1a;
      color: #fff;
      border-color: #444;
    }

    body.light-mode .prompt-chip {
      background: #fff;
      border-color: #ddd;
      color: #555;
    }

    body.light-mode .prompt-chip:hover {
      background: #f5f5f5;
      color: #111;
    }

    /* Pin indicator */
    .pin-icon {
      color: #f59e0b;
      font-size: 10px;
    }

    /* Folder header */
    .folder-header {
      padding: 6px 16px;
      font-size: 10px;
      font-weight: 700;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .folder-header:hover {
      color: #888;
    }

    /* Font size classes */
    body.font-sm {
      font-size: 12px !important;
    }

    body.font-md {
      font-size: 14px !important;
    }

    body.font-lg {
      font-size: 16px !important;
    }

    body.font-sm #chat-window,
    body.font-sm .compare-live-body,
    body.font-sm .prose,
    body.font-sm .msg-user-bubble,
    body.font-sm #user-input {
      font-size: 12px !important;
    }

    body.font-md #chat-window,
    body.font-md .compare-live-body,
    body.font-md .prose,
    body.font-md .msg-user-bubble,
    body.font-md #user-input {
      font-size: 14px !important;
    }

    body.font-lg #chat-window,
    body.font-lg .compare-live-body,
    body.font-lg .prose,
    body.font-lg .msg-user-bubble,
    body.font-lg #user-input {
      font-size: 16px !important;
    }

    body.font-sm .msg-ai-block,
    body.font-sm .compare-live-msg-ai {
      font-size: 12px !important;
    }

    body.font-md .msg-ai-block,
    body.font-md .compare-live-msg-ai {
      font-size: 14px !important;
    }

    body.font-lg .msg-ai-block,
    body.font-lg .compare-live-msg-ai {
      font-size: 16px !important;
    }

    /* Export modal */
    .export-menu {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: #111;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 6px;
      margin-bottom: 4px;
      min-width: 160px;
      z-index: 10;
    }

    .export-menu button {
      width: 100%;
      text-align: left;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      color: #aaa;
      background: none;
      border: none;
      cursor: pointer;
      transition: all 0.1s;
    }

    .export-menu button:hover {
      background: #1a1a1a;
      color: #fff;
    }

    body.light-mode .export-menu {
      background: #fff;
      border-color: #e5e5e5;
    }

    body.light-mode .export-menu button {
      color: #666;
    }

    body.light-mode .export-menu button:hover {
      background: #f5f5f5;
      color: #111;
    }

    /* Mobile improvements - actions/compare */
    @media (max-width: 768px) {
      .msg-actions {
        opacity: 1;
      }

      .msg-action-btn {
        padding: 4px 6px;
        font-size: 9px;
      }

      .prompt-chip {
        padding: 6px 10px;
        font-size: 11px;
      }

      #prompt-templates-modal .grid {
        grid-template-columns: 1fr !important;
      }

      .compare-container {
        flex-direction: column !important;
      }

      .compare-panel {
        width: 100% !important;
        border-left: none !important;
        border-top: 1px solid #222;
      }

      .canvas-terminal {
        height: 250px !important;
      }

      .canvas-file-tree {
        width: 140px;
        font-size: 11px;
      }

      .selection-menu {
        flex-wrap: wrap;
        max-width: 90vw;
      }

      .chat-search-bar {
        right: 8px;
        left: 8px;
      }

      .chat-search-bar input {
        width: 100%;
      }

      .thinking-block {
        margin-left: 0;
        margin-right: 0;
      }

      .thinking-block summary {
        font-size: 11px;
        padding: 6px 10px;
      }

      .thinking-block .max-h-60 {
        max-height: 150px;
      }
    }

    /* Terminal */
    .canvas-terminal {
      height: 100%;
      background: #0d0d0d;
    }

    .canvas-terminal .xterm {
      height: 100%;
      padding: 8px;
    }

    /* Multi-model Comparison */
    .compare-container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .compare-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .compare-panel+.compare-panel {
      border-left: 1px solid #222;
    }

    .compare-header {
      padding: 10px 16px;
      background: #0f0f0f;
      border-bottom: 1px solid #1a1a1a;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
    }

    .compare-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      font-size: 13px;
      line-height: 1.7;
    }

    .compare-badge {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
    }

    body.light-mode .compare-panel+.compare-panel {
      border-left-color: #e5e5e5;
    }

    body.light-mode .compare-header {
      background: #fff;
      border-bottom-color: #e5e5e5;
    }

    /* In-chat search */
    .chat-search-bar {
      position: absolute;
      top: 60px;
      right: 20px;
      z-index: 30;
      background: #111;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .chat-search-bar input {
      background: none;
      border: none;
      outline: none;
      color: #eee;
      font-size: 13px;
      width: 200px;
    }

    .chat-search-bar .count {
      font-size: 10px;
      color: #666;
      white-space: nowrap;
    }

    body.light-mode .chat-search-bar {
      background: #fff;
      border-color: #ddd;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    body.light-mode .chat-search-bar input {
      color: #111;
    }

    /* Text selection menu */
    .selection-menu {
      position: fixed;
      z-index: 200;
      background: #111;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 4px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      display: flex;
      gap: 2px;
    }

    .selection-menu button {
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      color: #aaa;
      background: none;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }

    .selection-menu button:hover {
      background: #1a1a1a;
      color: #fff;
    }

    body.light-mode .selection-menu {
      background: #fff;
      border-color: #ddd;
    }

    body.light-mode .selection-menu button {
      color: #555;
    }

    body.light-mode .selection-menu button:hover {
      background: #f5f5f5;
      color: #111;
    }

    /* Bookmark */
    .msg-bookmark {
      color: #555;
      cursor: pointer;
      transition: color 0.15s;
    }

    .msg-bookmark:hover,
    .msg-bookmark.active {
      color: #f59e0b;
    }

    /* Timestamp */
    .msg-timestamp {
      font-size: 9px;
      color: #555;
      margin-top: 2px;
    }

    /* Accent colors */
    :root {
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --accent-glow: rgba(37, 99, 235, 0.2);
    }

    body.accent-green {
      --accent: #16a34a;
      --accent-hover: #15803d;
      --accent-glow: rgba(22, 163, 74, 0.2);
    }

    body.accent-purple {
      --accent: #7c3aed;
      --accent-hover: #6d28d9;
      --accent-glow: rgba(124, 58, 237, 0.2);
    }

    body.accent-red {
      --accent: #dc2626;
      --accent-hover: #b91c1c;
      --accent-glow: rgba(220, 38, 38, 0.2);
    }

    body.accent-amber {
      --accent: #d97706;
      --accent-hover: #b45309;
      --accent-glow: rgba(217, 119, 6, 0.2);
    }

    body.accent-cyan {
      --accent: #0891b2;
      --accent-hover: #0e7490;
      --accent-glow: rgba(8, 145, 178, 0.2);
    }

    .msg-user-bubble,
    #send-btn,
    .accent-bg {
      background: var(--accent) !important;
    }

    .accent-bg:hover {
      background: var(--accent-hover) !important;
    }

    /* Token counter */
    .token-count {
      font-size: 9px;
      color: #444;
      font-family: monospace;
    }

    /* Side-by-side Compare Mode */
    .compare-live-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .compare-live-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .compare-live-panel+.compare-live-panel {
      border-left: 1px solid #222;
    }

    .compare-live-header {
      height: 44px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      border-bottom: 1px solid #1a1a1a;
      background: #0a0a0a;
      flex-shrink: 0;
    }

    .compare-live-header select {
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      color: #ddd;
      outline: none;
      cursor: pointer;
      flex: 1;
      min-width: 0;
    }

    .compare-live-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .compare-live-msg-user {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 12px;
    }

    .compare-live-msg-user>div {
      background: var(--accent);
      color: white;
      padding: 8px 14px;
      border-radius: 16px 16px 4px 16px;
      max-width: 85%;
      font-size: 13px;
      word-break: break-word;
    }

    .compare-live-msg-ai {
      margin-bottom: 16px;
    }

    .compare-live-msg-ai .prose {
      line-height: 1.7;
    }

    .compare-live-typing {
      display: flex;
      gap: 4px;
      padding: 8px 0;
    }

    .compare-live-typing>div {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #555;
    }

    .compare-live-exit {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 5;
    }

    body.light-mode .compare-live-panel+.compare-live-panel {
      border-left-color: #e5e5e5;
    }

    body.light-mode .compare-live-header {
      background: #fafafa;
      border-bottom-color: #e5e5e5;
    }

    body.light-mode .compare-live-header select {
      background: #fff;
      border-color: #ddd;
      color: #333;
    }

    body.light-mode .compare-live-msg-ai {
      color: #374151;
    }

    @media (max-width: 768px) {
      .compare-live-container {
        flex-direction: column;
      }

      .compare-live-panel+.compare-live-panel {
        border-left: none;
        border-top: 1px solid #222;
      }

      .compare-live-panel {
        min-height: 40%;
      }

      .compare-live-header select {
        font-size: 11px;
        padding: 3px 6px;
      }
    }

    /* ===== NOTEPAD PANEL ===== */
    .notepad-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 300px;
      background: #0a0a0a;
      border-left: 1px solid #1a1a1a;
      display: flex;
      flex-direction: column;
      z-index: 40;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    .notepad-panel.open { transform: translateX(0); }
    .notepad-header {
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      border-bottom: 1px solid #1a1a1a;
      flex-shrink: 0;
    }
    .notepad-body { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
    .notepad-item {
      background: #111;
      border: 1px solid #1e1e1e;
      border-radius: 10px;
      padding: 10px 28px 10px 12px;
      font-size: 12px;
      color: #ccc;
      line-height: 1.6;
      position: relative;
    }
    .notepad-item .note-del { position: absolute; top: 6px; right: 8px; color: #444; cursor: pointer; font-size: 15px; transition: color 0.1s; line-height: 1; }
    .notepad-item .note-del:hover { color: #ef4444; }
    .notepad-item .note-ts { font-size: 9px; color: #555; margin-bottom: 4px; }
    .notepad-textarea { width: 100%; background: #111; border: 1px solid #222; border-radius: 10px; padding: 10px 12px; color: #ddd; font-size: 12px; resize: none; outline: none; transition: border-color 0.2s; min-height: 80px; font-family: inherit; }
    .notepad-textarea:focus { border-color: #333; }
    body.light-mode .notepad-panel { background: #fafafa; border-left-color: #e5e5e5; }
    body.light-mode .notepad-header { border-bottom-color: #e5e5e5; }
    body.light-mode .notepad-item { background: #fff; border-color: #e5e5e5; color: #333; }
    body.light-mode .notepad-textarea { background: #fff; border-color: #ddd; color: #333; }
    @media (max-width: 768px) { .notepad-panel { width: 100%; z-index: 110; } }

    /* ===== GLOBAL SEARCH MODAL ===== */
    .global-search-result-item { display: block; width: 100%; text-align: left; padding: 10px 12px; border-radius: 10px; background: rgba(255,255,255,0.02); border: 1px solid #1e1e1e; transition: all 0.15s; cursor: pointer; }
    .global-search-result-item:hover { background: rgba(255,255,255,0.05); border-color: #333; }
    body.light-mode .global-search-result-item { background: #f9f9f9; border-color: #e5e5e5; }
    body.light-mode .global-search-result-item:hover { background: #f0f0f0; }

    /* ===== SLIDE & REPORT MODALS ===== */
    .feature-modal-select { width: 100%; background: #0a0a0a; border: 1px solid #222; border-radius: 12px; padding: 10px 14px; font-size: 13px; outline: none; color: #ddd; transition: border-color 0.2s; cursor: pointer; appearance: none; }
    .feature-modal-select:focus { border-color: #3b82f6; }
    .feature-modal-input { width: 100%; background: #0a0a0a; border: 1px solid #222; border-radius: 12px; padding: 10px 14px; font-size: 13px; outline: none; color: #ddd; transition: border-color 0.2s; }
    .feature-modal-input:focus { border-color: #3b82f6; }
    body.light-mode .feature-modal-select, body.light-mode .feature-modal-input { background: #fff; border-color: #ddd; color: #333; }

    /* Edit message inline */
    .edit-msg-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 60; display: flex; align-items: center; justify-content: center; padding: 16px; }
    .edit-msg-box { background: #111; border: 1px solid #222; border-radius: 20px; padding: 20px; width: 100%; max-width: 600px; box-shadow: 0 24px 60px rgba(0,0,0,0.6); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
</head>

<body class="bg-[#0a0a0a] text-slate-200 flex overflow-hidden" style="height: 100vh; height: 100dvh;">
  <!-- Sidebar Overlay (mobile) -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-[90] hidden"></div>
  <!-- Drag-Drop Overlay -->
  <div id="drag-overlay" class="drag-overlay hidden">
    <div class="drag-overlay-inner"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#2563eb"
        stroke-width="1.5" class="mx-auto mb-3">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="17 8 12 3 7 8" />
        <line x1="12" y1="3" x2="12" y2="15" />
      </svg>
      <div class="text-lg font-bold text-blue-400">Dosyalari birakin</div>
      <div class="text-sm text-neutral-500 mt-1">Resim,
        video veya PDF</div>
    </div>
  </div>
  <!-- Sidebar -->
  <aside id="sidebar" class="w-64 sidebar flex-col hidden md:flex shrink-0 z-[100]">
    <div class="p-4">
      <!-- Close btn mobile -->
      <div class="flex items-center justify-between md:hidden mb-3"><span
          class="text-xs font-bold text-neutral-500 uppercase tracking-widest">Menu</span><button id="close-sidebar-btn"
          class="p-1.5 text-neutral-400 hover:text-white"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg></button></div><button id="new-chat-btn"
        class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white text-sm font-semibold transition-all border border-white/5"><svg
          width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>Yeni Sohbet </button>
      <div class="flex gap-2 mt-3"><button id="settings-btn"
          class="flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg text-[11px] font-bold text-neutral-500 hover:text-white hover:bg-white/5 transition-all"><svg
            width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.6 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
          </svg>Ayarlar </button><button id="export-chat-btn"
          class="flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg text-[11px] font-bold text-neutral-500 hover:text-emerald-400 hover:bg-emerald-500/5 transition-all"
          title="Sohbeti Dis Aktar"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>Aktar </button><button id="reset-btn"
          class="flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg text-[11px] font-bold text-neutral-500 hover:text-red-400 hover:bg-red-500/5 transition-all">Sifirla
        </button></div>
      <div class="flex gap-2 mt-1"><button onclick="importChatFromFile()"
          class="flex-1 flex items-center justify-center gap-1 py-2 rounded-lg text-[10px] font-bold text-neutral-600 hover:text-blue-400 hover:bg-blue-500/5 transition-all"
          title="JSON Aktar"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>Ice Aktar </button><button onclick="openStatsModal()"
          class="flex-1 flex items-center justify-center gap-1 py-2 rounded-lg text-[10px] font-bold text-neutral-600 hover:text-purple-400 hover:bg-purple-500/5 transition-all"
          title="Istatistikler"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M18 20V10" />
            <path d="M12 20V4" />
            <path d="M6 20v-6" />
          </svg>Istatistik </button></div>
    </div>
    <!-- Chat history -->
    <div class="px-4 mt-1">
      <div class="flex items-center justify-between mb-2"><span
          class="text-[10px] font-bold text-neutral-600 uppercase tracking-widest">Gecmis</span><input id="search-input"
          oninput="searchChats()" type="text" placeholder="Ara..."
          class="bg-white/5 border border-white/5 rounded-md px-2 py-1 text-[10px] outline-none focus:border-neutral-600 w-20 transition-all text-neutral-400">
      </div>
      <div id="chat-list" class="space-y-0.5 overflow-y-auto pr-1"
        style="max-height: calc(var(--app-height, 100vh) - 320px);"></div>
    </div>
    <!-- Auth + Provider button -->
    <div class="mt-auto border-t border-[#1a1a1a]">
      <!-- Auth: signed in state -->
      <div id="github-user-panel" class="hidden px-4 pt-3 pb-2">
        <div class="flex items-center gap-3 px-3 py-2.5 bg-[#1a1a1a] rounded-xl">
          <div class="w-8 h-8 rounded-full shrink-0 overflow-hidden bg-[#24292e] flex items-center justify-center">
            <img id="auth-avatar-img" src="" alt="" class="w-full h-full object-cover hidden" onerror="this.classList.add('hidden');document.getElementById('auth-avatar-fallback').classList.remove('hidden')"/>
            <div id="auth-avatar-fallback" class="w-full h-full flex items-center justify-center">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="text-neutral-400"><path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/></svg>
            </div>
          </div>
          <div class="flex-1 min-w-0">
            <div id="github-user-name" class="text-xs font-semibold text-neutral-200 truncate"></div>
            <div id="github-user-email" class="text-[10px] text-neutral-500 truncate"></div>
          </div>
          <button onclick="signOutGithub()" title="Cikis Yap" class="shrink-0 p-1.5 rounded-lg text-neutral-500 hover:text-red-400 hover:bg-red-500/10 transition-all">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          </button>
        </div>
      </div>
      <!-- Auth: signed out state -->
      <div id="github-signin-panel" class="px-4 pt-3 pb-2 flex flex-col gap-2">
        <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-2.5 px-4 py-2.5 rounded-xl bg-white hover:bg-neutral-100 text-neutral-800 text-xs font-semibold transition-all shadow-sm">
          <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Google ile Giris Yap
        </button>
        <button onclick="signInWithGithub()" class="w-full flex items-center justify-center gap-2.5 px-4 py-2.5 rounded-xl bg-[#24292e] hover:bg-[#2f363d] text-white text-xs font-semibold transition-all shadow-sm">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"/></svg>
          GitHub ile Giris Yap
        </button>
      </div>
      <div class="px-4 pb-3">
        <button id="login-btn" class="w-full items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold transition-all" style="display: none;">Puter ile Giris Yap</button>
        <div id="status" class="text-[9px] text-blue-400/80 font-medium truncate text-center mt-1">Puter.ai Aktif</div>
      </div>
    </div>
  </aside>
  <!-- Main -->
  <main class="flex-1 flex flex-col min-w-0 relative bg-[#0f0f0f]" style="min-height: 0;">
    <!-- Header -->
    <header class="h-14 flex items-center px-5 justify-between top-header z-20 shrink-0">
      <div class="flex items-center gap-3 min-w-0 overflow-hidden"><button id="menu-btn"
          class="md:hidden p-2 text-neutral-400 hover:text-white shrink-0"><svg width="20" height="20"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg></button>
        <!-- Model selector -->
        <div id="mobile-selector-wrap" class="flex items-center gap-2 bg-[#1a1a1a] rounded-xl px-3 py-1.5 border border-[#222] shrink-0">
          <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_6px_rgba(34,197,94,0.4)]"></div><select id="model-a"
            class="bg-transparent text-[12px] outline-none font-semibold text-neutral-200 cursor-pointer min-w-[140px] appearance-none"></select><svg
            width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
            class="text-neutral-500 pointer-events-none">
            <path d="M6 9l6 6 6-6" />
          </svg>
        </div>
        <!-- Action buttons - hidden when canvas is open -->
        <div id="header-action-btns" class="hidden sm:flex items-center gap-0.5"><button onclick="openCompareMode()"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-orange-400 hover:bg-orange-500/5 transition-all"
            title="Model Karsilastir">Karsilastir</button><button onclick="openPromptTemplates()"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-amber-400 hover:bg-amber-500/5 transition-all"
            title="Sablonlar">Sablonlar</button><button onclick="openPersonaGallery()"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-pink-400 hover:bg-pink-500/5 transition-all"
            title="Personalar">Personalar</button><button onclick="injectPrompt('web-search')"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-cyan-400 hover:bg-cyan-500/5 transition-all"
            title="Web">Web</button><button onclick="injectPrompt('deep-research')"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-purple-400 hover:bg-purple-500/5 transition-all"
            title="Deep Research">Deep Research</button><button onclick="injectPrompt('image-gen')"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-emerald-400 hover:bg-emerald-500/5 transition-all"
            title="Gorsel">Gorsel</button><button onclick="injectPrompt('video-gen')"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-blue-400 hover:bg-blue-500/5 transition-all"
            title="Video">Video</button><button onclick="startAgentMode()"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-rose-400 hover:bg-rose-500/5 transition-all"
            title="Ajan Modu"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" class="inline mr-0.5">
              <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z" />
              <path d="M12 6v6l4 2" />
            </svg>Ajan </button><div class="w-px h-4 bg-[#222] mx-1"></div><button onclick="openGlobalSearch()"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-blue-400 hover:bg-blue-500/5 transition-all"
            title="Tum Sohbetlerde Ara"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-0.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Ara</button><button onclick="toggleNotepad()"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-yellow-400 hover:bg-yellow-500/5 transition-all"
            title="Not Defteri"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-0.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Not</button><button onclick="openSlideModal()"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-teal-400 hover:bg-teal-500/5 transition-all"
            title="Sunum Olustur"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-0.5"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>Slayt</button><button onclick="openReportModal()"
            class="px-3 py-1.5 rounded-lg text-[11px] font-semibold text-neutral-500 hover:text-orange-400 hover:bg-orange-500/5 transition-all"
            title="Detayli Rapor Olustur"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-0.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>Rapor</button></div>
        <div id="header-canvas-tabs" class="header-canvas-tabs hidden sm:flex ml-2"><button class="canvas-tab active"
            onclick="switchCanvasTab('preview')" id="header-canvas-preview"><svg width="12" height="12"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M2 12h20" />
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
            </svg>Preview </button><button class="canvas-tab" onclick="switchCanvasTab('code')"
            id="header-canvas-code"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <polyline points="16 18 22 12 16 6" />
              <polyline points="8 6 2 12 8 18" />
            </svg>Code </button><button class="canvas-tab" onclick="switchCanvasTab('terminal')"
            id="header-canvas-terminal"><svg width="12" height="12" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2">
              <polyline points="4 17 10 11 4 5" />
              <line x1="12" y1="19" x2="20" y2="19" />
            </svg>Terminal </button><button class="canvas-tab" onclick="switchCanvasTab('diff')" id="header-canvas-diff"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Diff </button></div>
      </div>
      <div class="flex items-center gap-2">
        <!-- Mobile: more options button -->
        <button id="mobile-more-btn" onclick="openExportModal()" class="hidden md:hidden w-9 h-9 items-center justify-center rounded-full text-neutral-400 hover:text-white hover:bg-white/10 transition-all" style="display:none" title="Secenekler"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg></button>
        <button id="canvas-toggle-btn" onclick="toggleCanvasPanel()"
          class="p-2 rounded-lg text-neutral-500 hover:text-teal-400 hover:bg-teal-500/5 transition-all hidden"
          title="Canvas Ac / Kapat"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/></svg></button><button onclick="toggleChatSearch()"
          class="p-2 rounded-lg text-neutral-500 hover:text-white hover:bg-white/5 transition-all"
          title="Sohbette Ara (Ctrl+F)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
          </svg></button><span class="text-[10px] font-mono text-neutral-600 tracking-wider hidden md:inline">v18</span>
        <button id="header-github-btn" onclick="signInWithGithub()" title="GitHub ile Giris Yap" class="hidden w-8 h-8 items-center justify-center rounded-full bg-white/5 hover:bg-white/10 transition-all shrink-0" style="display:none">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"/></svg>
        </button>
        <div id="header-avatar-btn" class="hidden w-8 h-8 rounded-full bg-[#24292e] cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all shrink-0 overflow-hidden items-center justify-center" onclick="toggleGithubMenu()" style="display:none">
          <img id="header-avatar-img" src="" alt="" class="hidden w-full h-full object-cover"/>
          <div id="header-avatar-fallback" class="w-full h-full flex items-center justify-center">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="text-neutral-400"><path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/></svg>
          </div>
        </div>
        <!-- Header GitHub dropdown menu -->
        <div id="header-github-menu" class="hidden absolute right-4 top-14 w-56 bg-[#1a1a1a] border border-[#2a2a2a] rounded-2xl shadow-2xl p-2 z-50">
          <div class="px-3 py-2 border-b border-[#2a2a2a] mb-1">
            <div id="hmenu-name" class="text-xs font-semibold text-neutral-200 truncate"></div>
            <div id="hmenu-email" class="text-[10px] text-neutral-500 truncate mt-0.5"></div>
          </div>
          <button onclick="signOutGithub()" class="w-full flex items-center gap-2.5 px-3 py-2 rounded-xl text-xs text-neutral-400 hover:text-red-400 hover:bg-red-500/10 transition-all">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Cikis Yap
          </button>
        </div>
      </div>
    </header>
    <!-- Chat Messages -->
    <div id="chat-window" class="flex-1 overflow-y-auto px-4 md:px-8 py-6 space-y-5 pb-44 scroll-smooth">
      <div id="welcome-msg" class="h-full flex flex-col items-center justify-center text-center max-w-xl mx-auto px-4">
        <div id="welcome-icon"
          class="w-16 h-16 bg-gradient-to-br from-blue-600 via-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mb-6 shadow-2xl shadow-blue-600/20">
          <svg id="welcome-icon-svg" width="32" height="32" class="text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
          </svg>
        </div>
        <h2 id="welcome-title" class="text-3xl font-bold text-white tracking-tight mb-3">Nasil yardimci olabilirim?</h2>
        <p id="welcome-sub" class="text-neutral-500 text-base mb-8 max-w-xs leading-relaxed">Kod yazabilir, arastirma yapabilir veya gorsel uretebilirim.</p>
        <div id="welcome-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full"><button
            onclick="document.getElementById('user-input').value='Bana modern bir hava durumu uygulamasi kodu yaz (HTML/Tailwind)'; document.getElementById('user-input').focus()"
            class="welcome-card p-4 bg-white/[0.03] hover:bg-white/[0.06] border border-white/[0.06] rounded-2xl text-left transition-all active:scale-[0.98]">
            <div class="text-blue-400 font-bold text-[10px] mb-1.5 uppercase tracking-widest">Kodlama</div>
            <div class="text-neutral-300 text-sm font-medium">Modern hava durumu uygulamasi</div>
          </button><button
            onclick="document.getElementById('user-input').value='Yapay zekanin 2026 vizyonu hakkinda derin bir analiz yap'; document.getElementById('user-input').focus()"
            class="welcome-card p-4 bg-white/[0.03] hover:bg-white/[0.06] border border-white/[0.06] rounded-2xl text-left transition-all active:scale-[0.98]">
            <div class="text-purple-400 font-bold text-[10px] mb-1.5 uppercase tracking-widest">Arastirma</div>
            <div class="text-neutral-300 text-sm font-medium">AI'nin 2026 vizyonunu analiz et</div>
          </button></div>
      </div>
    </div>
    <!-- Side-by-Side Compare Mode -->
    <div id="compare-live" class="hidden compare-live-container" style="position:relative;"><button
        onclick="exitCompareMode()"
        class="compare-live-exit px-2 py-1 rounded-lg text-[10px] font-bold text-neutral-500 hover:text-red-400 hover:bg-red-500/10 border border-[#222] transition-all"
        title="Karsilastirma modundan cik"> Kapat</button>
      <div class="compare-live-panel">
        <div class="compare-live-header"><span
            class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-blue-600/20 text-blue-400">A</span><select
            id="compare-live-model-a"></select></div>
        <div id="compare-live-chat-a" class="compare-live-body"></div>
      </div>
      <div class="compare-live-panel">
        <div class="compare-live-header"><span
            class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-purple-600/20 text-purple-400">B</span><select
            id="compare-live-model-b"></select></div>
        <div id="compare-live-chat-b" class="compare-live-body"></div>
      </div>
    </div>
    <!-- Input Area -->
    <div
      class="absolute bottom-0 left-0 right-0 p-5 bg-gradient-to-t from-[#0f0f0f] via-[#0f0f0f]/95 to-transparent z-10">
      <div class="max-w-3xl mx-auto">
        <!-- Mobile action buttons -->
        <div class="flex sm:hidden items-center gap-1 mb-2 overflow-x-auto pb-1 scrollbar-hide"
          style="-webkit-overflow-scrolling: touch;"><button onclick="openCompareMode()"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-orange-400 bg-white/5 border border-white/5 transition-all shrink-0">Karsilastir</button><button
            onclick="openPromptTemplates()"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-amber-400 bg-white/5 border border-white/5 transition-all shrink-0">Sablonlar</button><button
            onclick="openPersonaGallery()"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-pink-400 bg-white/5 border border-white/5 transition-all shrink-0">Personalar</button><button
            onclick="injectPrompt('web-search')"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-cyan-400 bg-white/5 border border-white/5 transition-all shrink-0">Web</button><button
            onclick="injectPrompt('deep-research')"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-purple-400 bg-white/5 border border-white/5 transition-all shrink-0">Research</button><button
            onclick="injectPrompt('image-gen')"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-emerald-400 bg-white/5 border border-white/5 transition-all shrink-0">Gorsel</button><button
            onclick="injectPrompt('video-gen')"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-blue-400 bg-white/5 border border-white/5 transition-all shrink-0">Video</button><button
            onclick="startAgentMode()"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-rose-400 bg-white/5 border border-white/5 transition-all shrink-0">Ajan</button><button
            onclick="openGlobalSearch()"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-blue-400 bg-white/5 border border-white/5 transition-all shrink-0">Ara</button><button
            onclick="toggleNotepad()"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-yellow-400 bg-white/5 border border-white/5 transition-all shrink-0">Not</button><button
            onclick="openSlideModal()"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-teal-400 bg-white/5 border border-white/5 transition-all shrink-0">Slayt</button><button
            onclick="openReportModal()"
            class="px-2 py-1 rounded-lg text-[clamp(9px,2.5vw,11px)] font-semibold text-neutral-500 hover:text-orange-400 bg-white/5 border border-white/5 transition-all shrink-0">Rapor</button>
        </div>
        <div id="live-screen-preview"
          class="hidden mb-3 p-3 bg-[#0d1f18] rounded-xl border border-emerald-800/50 animate-in">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full bg-emerald-400 live-pulse-dot"></span>
              <span class="text-[11px] font-bold text-emerald-400">Canli Ekran Aktif</span>
            </div>
            <button onclick="stopLiveScreen()"
              class="text-neutral-500 hover:text-red-400 text-xs transition-colors px-2 py-0.5 rounded hover:bg-red-500/10">Durdur</button>
          </div>
          <video id="live-screen-video" class="w-full max-h-32 object-contain rounded-lg bg-black/30"
            autoplay muted playsinline></video>
          <div class="text-[9px] text-emerald-700 mt-1.5">Her mesajinizda ekranin anlk grnts otomatik eklenir</div>
        </div>
        <div id="file-preview-container"
          class="hidden flex flex-wrap gap-2 mb-3 px-3 py-2 bg-[#111] rounded-xl border border-[#222] animate-in">
        </div>
        <div id="format-bar" class="flex items-center gap-1.5 mb-2 flex-wrap">
          <span class="fmt-bar-label text-[10px] text-neutral-600 mr-0.5 uppercase tracking-wider font-semibold">Format:</span>
          <button type="button" data-fmt="bullets" onclick="toggleFormat('bullets')"
            class="fmt-btn px-2.5 py-1 rounded-lg text-[10px] font-semibold border border-[#2a2a2a] text-neutral-500 hover:text-white hover:border-neutral-600 transition-all">Madde madde</button>
          <button type="button" data-fmt="summary" onclick="toggleFormat('summary')"
            class="fmt-btn px-2.5 py-1 rounded-lg text-[10px] font-semibold border border-[#2a2a2a] text-neutral-500 hover:text-white hover:border-neutral-600 transition-all">Ozet</button>
          <button type="button" data-fmt="detailed" onclick="toggleFormat('detailed')"
            class="fmt-btn px-2.5 py-1 rounded-lg text-[10px] font-semibold border border-[#2a2a2a] text-neutral-500 hover:text-white hover:border-neutral-600 transition-all">Detayli</button>
        </div>
        <div class="input-box flex items-end gap-2 p-2.5"><button id="upload-btn"
            class="w-10 h-10 rounded-xl flex items-center justify-center text-neutral-500 hover:text-white hover:bg-white/5 transition-all shrink-0"
            title="Dosya Yukle"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path
                d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" />
            </svg></button><button id="screen-capture-btn"
            class="w-10 h-10 rounded-xl flex items-center justify-center text-neutral-500 hover:text-emerald-400 hover:bg-white/5 transition-all shrink-0"
            title="Ekrani Cek"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
              <line x1="8" y1="21" x2="16" y2="21" />
              <line x1="12" y1="17" x2="12" y2="21" />
            </svg></button><button id="mic-btn"
            class="w-10 h-10 rounded-xl flex items-center justify-center text-neutral-500 hover:text-red-400 hover:bg-white/5 transition-all shrink-0"
            title="Sesle Yaz"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
              <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
              <line x1="12" y1="19" x2="12" y2="23" />
              <line x1="8" y1="23" x2="16" y2="23" />
            </svg></button><button id="ocr-btn"
            class="w-10 h-10 rounded-xl flex items-center justify-center text-neutral-500 hover:text-amber-400 hover:bg-white/5 transition-all shrink-0"
            title="OCR Modu - Resimden Metin Cikar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <path d="M7 8h2v2H7z" fill="currentColor" opacity="0.5"/>
              <path d="M11 8h6M11 12h6M7 16h10"/>
            </svg></button><button id="voice-conv-btn"
            class="w-10 h-10 rounded-xl flex items-center justify-center text-neutral-500 hover:text-green-400 hover:bg-white/5 transition-all shrink-0"
            title="Sesli Konusma Modu"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
              <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
              <line x1="12" y1="19" x2="12" y2="23" />
              <line x1="8" y1="23" x2="16" y2="23" />
              <circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.4" />
            </svg></button><input type="file" id="file-input" class="hidden" multiple
            accept="image/*,video/*,.pdf" /><textarea id="user-input" rows="1" autocomplete="off"
            placeholder="Mesajinizi buraya yazin..."
            class="flex-1 bg-transparent px-3 py-2.5 outline-none text-neutral-200 placeholder:text-neutral-600 text-sm resize-none max-h-48 min-h-[40px]"></textarea><button
            id="send-btn"
            class="bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 rounded-xl flex items-center justify-center transition-all active:scale-90 shrink-0"><svg
              id="send-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2.5">
              <line x1="22" y1="2" x2="11" y2="13" />
              <polygon points="22 2 15 22 11 13 2 9 22 2" />
            </svg></button><button id="stop-btn"
            class="stop-btn text-white w-10 h-10 rounded-xl flex items-center justify-center transition-all active:scale-90 shrink-0"
            style="display:none;"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="6" width="12" height="12" rx="2" />
            </svg></button></div>
      </div>
    </div>
  </main>

  <!-- Voice Overlay -->
  <div id="voice-overlay">
    <div id="voice-bars-container" class="voice-bars">
      <div class="voice-bar" style="height:6px"></div>
      <div class="voice-bar" style="height:10px"></div>
      <div class="voice-bar" style="height:18px"></div>
      <div class="voice-bar" style="height:10px"></div>
      <div class="voice-bar" style="height:6px"></div>
      <div style="width:12px"></div>
      <div class="voice-bar ai-bar" style="height:8px"></div>
      <div class="voice-bar ai-bar" style="height:14px"></div>
      <div class="voice-bar ai-bar" style="height:22px"></div>
      <div class="voice-bar ai-bar" style="height:14px"></div>
      <div class="voice-bar ai-bar" style="height:8px"></div>
    </div>
    <div id="voice-overlay-label" class="text-sm font-semibold text-neutral-300">Sesli Asistan Aktif</div>
    <div id="voice-interim" class=""></div>
    <button onclick="toggleVoiceConv()" class="mt-1 px-5 py-2 rounded-full text-sm font-semibold bg-red-500/15 text-red-400 border border-red-500/30 hover:bg-red-500/25 transition-all">Kapat</button>
  </div>

  <!-- Canvas Panel -->
  <aside id="canvas-panel" class="canvas-panel hidden">
    <div class="canvas-header">
      <div class="canvas-tabs sm:hidden"><button class="canvas-tab active" onclick="switchCanvasTab('preview')"
          id="canvas-tab-preview"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M2 12h20" />
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
          </svg>Preview </button><button class="canvas-tab" onclick="switchCanvasTab('code')" id="canvas-tab-code"><svg
            width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="16 18 22 12 16 6" />
            <polyline points="8 6 2 12 8 18" />
          </svg>Code </button><button class="canvas-tab" onclick="switchCanvasTab('terminal')"
          id="canvas-tab-terminal"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polyline points="4 17 10 11 4 5" />
            <line x1="12" y1="19" x2="20" y2="19" />
          </svg>Terminal </button><button class="canvas-tab" onclick="switchCanvasTab('diff')" id="canvas-tab-diff"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Diff </button></div>
      <div class="flex items-center gap-2">
        <div class="flex items-center mr-1"><button onclick="undoCanvas()" id="canvas-hist-back" disabled
            style="opacity:0.3"
            class="p-1 rounded text-neutral-400 hover:text-white hover:bg-white/10 transition-all cursor-pointer disabled:cursor-not-allowed disabled:hover:bg-transparent"
            title="Geri Al (Onceki Versiyon)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2">
              <path d="m12 19-7-7 7-7" />
              <path d="M19 12H5" />
            </svg></button><button onclick="redoCanvas()" id="canvas-hist-fwd" disabled style="opacity:0.3"
            class="p-1 rounded text-neutral-400 hover:text-white hover:bg-white/10 transition-all cursor-pointer disabled:cursor-not-allowed disabled:hover:bg-transparent"
            title="Ileri Al (Sonraki Versiyon)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2">
              <path d="m12 5 7 7-7 7" />
              <path d="M5 12h14" />
            </svg></button></div><button onclick="deployCanvasProject()" id="deploy-canvas-btn"
          class="text-[11px] text-emerald-500 hover:text-emerald-400 flex items-center gap-1 px-2 py-1 rounded-md hover:bg-emerald-500/10 transition-all font-bold"
          title="Projeyi Yayina Al (Hosting)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2l.5-.5a2.12 2.12 0 0 0-3-3l-.5.5Z" />
            <path
              d="m12 15-3-3a22 22 0 0 1 3.81-12.39L13 2.5a2.53 2.53 0 0 1 3.5 0l3 3a2.53 2.53 0 0 1 0 3.5L19.39 9.2A22 22 0 0 1 12 15Z" />
            <path d="m9 15 6 6" />
          </svg>Yayina Al </button><button onclick="downloadCanvasProject()"
          class="text-[11px] text-neutral-500 hover:text-white flex items-center gap-1 px-2 py-1 rounded-md hover:bg-white/5 transition-all"
          title="Projeyi Indir"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>Download </button><button onclick="openCanvasInNewTab()"
          class="text-[11px] text-neutral-500 hover:text-white flex items-center gap-1 px-2 py-1 rounded-md hover:bg-white/5 transition-all"
          title="Yeni Sekmede Ac"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            <polyline points="15 3 21 3 21 9" />
            <line x1="10" y1="14" x2="21" y2="3" />
          </svg></button><button onclick="closeCanvas()"
          class="text-[11px] text-neutral-500 hover:text-white p-1 rounded-md hover:bg-white/5 transition-all"
          title="Kapat"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg></button>
      </div>
    </div>
    <div class="canvas-body">
      <!-- Preview Tab -->
      <div id="canvas-preview-view" class="canvas-preview w-full">
        <div id="canvas-preview-empty" class="canvas-empty">
          <div class="canvas-building">
            <div class="canvas-building-blocks">
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
            </div>
          </div>
          <div style="margin-top:16px">
            <div class="text-lg font-bold text-neutral-300 mb-1">Start exploring the generated code</div>
            <div class="text-sm text-neutral-600">Click a file below or select from the file tree</div>
          </div>
          <div class="canvas-quick-files" id="canvas-quick-files"></div>
        </div><iframe id="canvas-iframe" class="hidden w-full h-full"></iframe>
      </div>
      <!-- Code Tab -->
      <div id="canvas-code-view" class="hidden w-full flex">
        <div class="canvas-file-tree" id="canvas-file-tree">
          <div class="ft-title flex justify-between items-center"><span>Files</span><button
              onclick="connectLocalFolder()" title="Klasor Bagla (Bilgisayarina Kaydet)"
              class="text-blue-400 hover:text-white transition-colors"><svg width="14" height="14" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
              </svg></button></div>
        </div>
        <div class="canvas-file-content flex-1" id="canvas-file-viewer">
          <pre id="canvas-code-pre">Select a file to view its content</pre>
        </div>
      </div>
      <!-- Terminal Tab -->
      <div id="canvas-terminal-view" class="hidden w-full canvas-terminal">
        <div id="terminal-container" class="w-full h-full"></div>
      </div>
      <!-- Diff Tab -->
      <div id="canvas-diff-view" class="hidden w-full" style="background:#0d1117;padding:16px;font-family:'JetBrains Mono',monospace;font-size:clamp(10px,1.5vw,12px);line-height:1.7;overflow:auto;-webkit-overflow-scrolling:touch;">
        <div id="canvas-diff-content" style="color:#8b949e;text-align:center;padding:40px 0;">Diff gormek icin onceki bir versiyon olmalidir. Geri al/ileri al dusmeleri ile versiyonlar arasinda gecis yapin.</div>
      </div>
    </div>
  </aside>
  <!-- Notepad Side Panel -->
  <aside id="notepad-panel" class="notepad-panel">
    <div class="notepad-header">
      <div class="flex items-center gap-2">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#eab308" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        <span class="text-sm font-bold text-white">Not Defteri</span>
      </div>
      <button onclick="toggleNotepad()" class="text-neutral-500 hover:text-white text-lg leading-none">&times;</button>
    </div>
    <div id="notepad-body" class="notepad-body"></div>
  </aside>
  <!-- Chat Search Bar -->
  <div id="chat-search-bar" class="chat-search-bar hidden"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"
      stroke="#666" stroke-width="2">
      <circle cx="11" cy="11" r="8" />
      <line x1="21" y1="21" x2="16.65" y2="16.65" />
    </svg><input id="chat-search-input" type="text" placeholder="Mesajlarda ara..."
      oninput="searchInChat(this.value)"><span id="chat-search-count" class="count"></span><button
      onclick="toggleChatSearch()" class="text-neutral-500 hover:text-white text-sm">&times;
    </button></div>
  <!-- Selection Context Menu -->
  <div id="selection-menu" class="selection-menu hidden"><button
      onclick="selectionAction('translate')">Cevir</button><button
      onclick="selectionAction('explain')">Acikla</button><button
      onclick="selectionAction('summarize')">Ozetle</button><button onclick="selectionAction('copy')">Kopyala</button>
  </div>
  <!-- Multi-Model Compare Modal -->
  <div id="compare-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div
      class="bg-[#111] border border-[#222] p-6 rounded-2xl w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-base font-bold text-white">Model Karsilastirma</h3><button onclick="closeCompareModal()"
          class="text-neutral-500 hover:text-white text-lg">&times;
        </button>
      </div>
      <div class="space-y-4">
        <div><label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider ml-1">Model
            A</label><select id="compare-model-a"
            class="w-full bg-[#0a0a0a] border border-[#222] rounded-xl p-3 mt-1.5 text-sm outline-none focus:border-blue-500 text-neutral-200"></select>
        </div>
        <div><label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider ml-1">Model
            B</label><select id="compare-model-b"
            class="w-full bg-[#0a0a0a] border border-[#222] rounded-xl p-3 mt-1.5 text-sm outline-none focus:border-blue-500 text-neutral-200"></select>
        </div>
        <div><label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider ml-1">Prompt</label><textarea
            id="compare-prompt" rows="3"
            class="w-full bg-[#0a0a0a] border border-[#222] rounded-xl p-3 mt-1.5 text-sm outline-none focus:border-blue-500 text-neutral-200 resize-none"
            placeholder="Karsilastirilacak soruyu yazin..."></textarea></div>
      </div><button onclick="runComparison()"
        class="w-full accent-bg text-white py-3 rounded-xl text-sm font-bold transition-all mt-5">Karsilastir
      </button>
    </div>
  </div>
  <!-- Compare Results -->
  <div id="compare-results" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex flex-col">
    <div class="flex items-center justify-between px-5 py-3 border-b border-[#222]">
      <h3 class="text-sm font-bold text-white">Model Karsilastirma Sonucu</h3><button onclick="closeCompareResults()"
        class="text-neutral-500 hover:text-white text-lg">&times;
      </button>
    </div>
    <div class="compare-container flex-1 overflow-hidden">
      <div class="compare-panel">
        <div class="compare-header"><span class="compare-badge bg-blue-600/20 text-blue-400">A</span><span
            id="compare-label-a" class="text-neutral-300">Model A</span><span id="compare-time-a"
            class="text-[10px] text-neutral-600 ml-auto"></span></div>
        <div class="compare-body prose text-neutral-300" id="compare-output-a">
          <div class="flex items-center gap-2 text-neutral-600">
            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full dot-pulse"></div>Bekleniyor...
          </div>
        </div>
      </div>
      <div class="compare-panel">
        <div class="compare-header"><span class="compare-badge bg-purple-600/20 text-purple-400">B</span><span
            id="compare-label-b" class="text-neutral-300">Model B</span><span id="compare-time-b"
            class="text-[10px] text-neutral-600 ml-auto"></span></div>
        <div class="compare-body prose text-neutral-300" id="compare-output-b">
          <div class="flex items-center gap-2 text-neutral-600">
            <div class="w-1.5 h-1.5 bg-purple-500 rounded-full dot-pulse"></div>Bekleniyor...
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Chat Stats Modal -->
  <div id="stats-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div
      class="bg-[#111] border border-[#222] p-6 rounded-2xl w-full max-w-sm shadow-2xl transform scale-95 transition-transform duration-200 max-h-[90vh] max-h-[90dvh] overflow-y-auto">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-base font-bold text-white">Sohbet Istatistikleri</h3><button onclick="closeStatsModal()"
          class="text-neutral-500 hover:text-white text-lg">&times;
        </button>
      </div>
      <div id="stats-content" class="space-y-3"></div>
    </div>
  </div>
  <!-- Prompt Templates Modal -->
  <div id="prompt-templates-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div
      class="bg-[#111] border border-[#222] p-6 rounded-2xl w-full max-w-2xl shadow-2xl transform scale-95 transition-transform duration-200 max-h-[90vh] max-h-[90dvh] overflow-y-auto">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-base font-bold text-white">Prompt Sablonlari</h3><button onclick="closePromptTemplates()"
          class="text-neutral-500 hover:text-white text-lg">&times;
        </button>
      </div>
      <div id="prompt-templates-grid" class="grid grid-cols-2 gap-3 max-h-[60vh] max-h-[60dvh] overflow-y-auto pr-1">
      </div>
    </div>
  </div>
  <!-- Persona Gallery Modal -->
  <div id="persona-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div
      class="bg-[#111] border border-[#222] p-6 rounded-2xl w-full max-w-2xl shadow-2xl transform scale-95 transition-transform duration-200 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-base font-bold text-white">Persona (Rol) Galerisi</h3><button onclick="closePersonaGallery()"
          class="text-neutral-500 hover:text-white text-lg">&times;
        </button>
      </div>
      <div id="persona-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto pr-1"></div>
      <div class="mt-4 pt-4 border-t border-[#222] space-y-3">
        <div class="text-[10px] font-bold text-neutral-500 uppercase tracking-wider">Ozel Persona Olustur</div>
        <input id="custom-persona-name" type="text" placeholder="Persona adi (orn: Pazarlama Uzmani)" class="feature-modal-input" />
        <textarea id="custom-persona-prompt" rows="3" placeholder="Sistem talimatini yaz... (orn: Sen bir pazarlama uzmansn...)" class="feature-modal-input resize-none" style="border-radius:12px;"></textarea>
        <button onclick="saveCustomPersona()" class="w-full bg-blue-600/15 hover:bg-blue-600/25 text-blue-400 py-2.5 rounded-xl text-sm font-bold transition-all border border-blue-500/20">Kaydet ve Aktiflestir</button>
        <button onclick="clearPersona()" class="w-full bg-red-600/10 hover:bg-red-600/20 text-red-400 py-2.5 rounded-xl text-sm font-bold transition-all border border-red-500/20">Aktif Rolu Sifirla</button>
      </div>
    </div>
  </div>
  <!-- Export Menu Modal -->
  <div id="export-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div
      class="bg-[#111] border border-[#222] p-6 rounded-2xl w-full max-w-sm shadow-2xl transform scale-95 transition-transform duration-200">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-base font-bold text-white">Sohbeti Dis Aktar</h3><button onclick="closeExportModal()"
          class="text-neutral-500 hover:text-white text-lg">&times;
        </button>
      </div>
      <div class="space-y-2"><button onclick="shareChat()"
          class="w-full flex items-center gap-3 p-3 bg-white/[0.02] rounded-xl border border-[#222] hover:bg-white/[0.04] transition-colors text-left">
          <div
            class="w-8 h-8 rounded-lg bg-blue-600/10 flex items-center justify-center text-blue-400">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
          </div>
          <div>
            <div class="text-sm text-neutral-300 font-medium">Link Olarak Paylas</div>
            <div class="text-[10px] text-neutral-600">URL'yi panoya kopyala</div>
          </div>
        </button><button onclick="exportChat('md')"
          class="w-full flex items-center gap-3 p-3 bg-white/[0.02] rounded-xl border border-[#222] hover:bg-white/[0.04] transition-colors text-left">
          <div
            class="w-8 h-8 rounded-lg bg-blue-600/10 flex items-center justify-center text-blue-400 text-xs font-bold">
            MD</div>
          <div>
            <div class="text-sm text-neutral-300 font-medium">Markdown</div>
            <div class="text-[10px] text-neutral-600">.md dosyasi olarak indir</div>
          </div>
        </button><button onclick="exportChat('json')"
          class="w-full flex items-center gap-3 p-3 bg-white/[0.02] rounded-xl border border-[#222] hover:bg-white/[0.04] transition-colors text-left">
          <div
            class="w-8 h-8 rounded-lg bg-green-600/10 flex items-center justify-center text-green-400 text-xs font-bold">
            {}

          </div>
          <div>
            <div class="text-sm text-neutral-300 font-medium">JSON</div>
            <div class="text-[10px] text-neutral-600">Ham veri olarak indir</div>
          </div>
        </button><button onclick="exportChat('txt')"
          class="w-full flex items-center gap-3 p-3 bg-white/[0.02] rounded-xl border border-[#222] hover:bg-white/[0.04] transition-colors text-left">
          <div
            class="w-8 h-8 rounded-lg bg-purple-600/10 flex items-center justify-center text-purple-400 text-xs font-bold">
            TXT</div>
          <div>
            <div class="text-sm text-neutral-300 font-medium">Duz Metin</div>
            <div class="text-[10px] text-neutral-600">.txt dosyasi olarak indir</div>
          </div>
        </button><button onclick="exportChatPDF()"
          class="w-full flex items-center gap-3 p-3 bg-white/[0.02] rounded-xl border border-[#222] hover:bg-white/[0.04] transition-colors text-left">
          <div class="w-8 h-8 rounded-lg bg-red-600/10 flex items-center justify-center text-red-400">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
          </div>
          <div>
            <div class="text-sm text-neutral-300 font-medium">PDF</div>
            <div class="text-[10px] text-neutral-600">Yazdirilabilir PDF olarak ac</div>
          </div>
        </button></div>
    </div>
  </div>
  <!-- Shortcuts Help Modal -->
  <div id="shortcuts-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div
      class="bg-[#111] border border-[#222] p-6 rounded-2xl w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200 max-h-[90vh] max-h-[90dvh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-base font-bold text-white">Klavye Kisayollari</h3><button onclick="closeShortcutsHelp()"
          class="text-neutral-500 hover:text-white text-lg">&times;
        </button>
      </div>
      <div class="space-y-1.5 text-sm">
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span class="text-neutral-400">Yeni
            sohbet</span><kbd class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">Ctrl+N</kbd>
        </div>
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span class="text-neutral-400">Mesaj kutusuna
            odaklan</span><kbd class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">/
            veya Ctrl+/</kbd></div>
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span class="text-neutral-400">Sohbet
            ara</span><kbd class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">Ctrl+K</kbd>
        </div>
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span class="text-neutral-400">Mesajda
            ara</span><kbd class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">Ctrl+F</kbd>
        </div>
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span
            class="text-neutral-400">Ayarlar</span><kbd
            class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">Ctrl+,
          </kbd></div>
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span class="text-neutral-400">Dis
            aktar</span><kbd class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">Ctrl+E</kbd>
        </div>
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span
            class="text-neutral-400">Sablonlar</span><kbd
            class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">Ctrl+T</kbd>
        </div>
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span class="text-neutral-400">Karsilastirma
            modu</span><kbd class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">Ctrl+M</kbd>
        </div>
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span class="text-neutral-400">Bu pencereyi
            ac</span><kbd class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">Ctrl+?</kbd>
        </div>
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span class="text-neutral-400">Kapat /
            Iptal</span><kbd class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">Escape</kbd>
        </div>
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span class="text-neutral-400">Mesaj
            gonder</span><kbd class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">Enter</kbd>
        </div>
        <div class="flex justify-between p-2 rounded-lg bg-white/[0.02]"><span class="text-neutral-400">Satir
            atlama</span><kbd
            class="text-[11px] bg-[#222] px-2 py-0.5 rounded font-mono text-neutral-300">Shift+Enter</kbd>
        </div>
      </div>
    </div>
  </div>
  <!-- Image Lightbox Modal -->
  <div id="lightbox-modal"
    class="hidden fixed inset-0 bg-black/95 z-[60] flex items-center justify-center cursor-zoom-out"
    onclick="if(e=event, e.target===this)closeLightbox()"><button onclick="closeLightbox()"
      class="absolute top-4 right-4 text-white/70 hover:text-white text-2xl z-10 w-10 h-10 flex items-center justify-center rounded-full bg-black/40 hover:bg-black/60 transition-all">&times;
    </button><button onclick="downloadLightboxImage()"
      class="absolute top-4 right-16 text-white/70 hover:text-white z-10 w-10 h-10 flex items-center justify-center rounded-full bg-black/40 hover:bg-black/60 transition-all"
      title="Indir"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" y1="15" x2="12" y2="3" />
      </svg></button><img id="lightbox-img" src=""
      class="max-w-[95vw] max-h-[95vh] object-contain rounded-lg shadow-2xl transition-transform duration-200"
      style="transform: scale(1);" /></div>
  <!-- Global Search Modal -->
  <div id="global-search-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div class="bg-[#111] border border-[#222] rounded-2xl w-full max-w-xl shadow-2xl overflow-hidden" style="max-height:85vh;">
      <div class="p-4 border-b border-[#1e1e1e] flex items-center gap-3">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input id="global-search-input" type="text" placeholder="Tum sohbetlerde ara..." oninput="runGlobalSearch()" class="flex-1 bg-transparent outline-none text-sm text-neutral-200 placeholder:text-neutral-600" />
        <span id="global-search-count" class="text-[10px] text-neutral-600 shrink-0"></span>
        <button onclick="closeGlobalSearch()" class="text-neutral-500 hover:text-white text-lg leading-none ml-1">&times;</button>
      </div>
      <div id="global-search-results" class="overflow-y-auto p-3 space-y-2" style="max-height:65vh;">
        <div class="text-neutral-600 text-sm text-center py-8">Aramak istediginiz kelimeyi girin...</div>
      </div>
    </div>
  </div>
  <!-- Slide Maker Modal -->
  <div id="slide-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div class="bg-[#111] border border-[#222] p-6 rounded-2xl w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200">
      <div class="flex justify-between items-center mb-5">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-xl bg-teal-600/20 flex items-center justify-center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2dd4bf" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg></div>
          <h3 class="text-base font-bold text-white">Sunum Olustur</h3>
        </div>
        <button onclick="closeSlideModal()" class="text-neutral-500 hover:text-white text-lg">&times;</button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-1.5">Konu</label>
          <input id="slide-topic" type="text" placeholder="orn: Yapay Zekanin Gelecegi, Iklim Krizi, Blockchain..." class="feature-modal-input" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-1.5">Slayt Sayisi</label>
            <select id="slide-count" class="feature-modal-select">
              <option value="5">5 Slayt</option>
              <option value="8" selected>8 Slayt</option>
              <option value="10">10 Slayt</option>
              <option value="12">12 Slayt</option>
              <option value="15">15 Slayt</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-1.5">Stil</label>
            <select id="slide-style" class="feature-modal-select">
              <option value="modern" selected>Modern</option>
              <option value="corporate">Kurumsal</option>
              <option value="creative">Yaratici</option>
              <option value="academic">Akademik</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-1.5">Cikti Formati</label>
            <select id="slide-format" class="feature-modal-select" onchange="updateSlideFormatHint(this.value)">
              <option value="html" selected>HTML (Tarayici)</option>
              <option value="pptx">PPTX (PowerPoint)</option>
            </select>
          </div>
          <div>
            <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-1.5">Dil</label>
            <select id="slide-lang" class="feature-modal-select">
              <option value="tr" selected>Turkce</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
        <div>
          <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-1.5">Arastirma Modu</label>
          <div class="grid grid-cols-2 gap-2">
            <label id="slide-quick-btn" class="flex items-center gap-2 p-2.5 rounded-xl border border-blue-500/40 bg-blue-600/15 cursor-pointer transition-all" onclick="setSlideResearch('quick')">
              <input type="radio" name="slide-research" value="quick" checked class="accent-blue-500 shrink-0" />
              <div><div class="text-xs font-bold text-blue-300">Hizli</div><div class="text-[10px] text-neutral-500">Anlk cevap</div></div>
            </label>
            <label id="slide-deep-btn" class="flex items-center gap-2 p-2.5 rounded-xl border border-[#333] cursor-pointer transition-all" onclick="setSlideResearch('deep')">
              <input type="radio" name="slide-research" value="deep" class="accent-amber-500 shrink-0" />
              <div><div class="text-xs font-bold text-neutral-300">Derin Arastirma</div><div class="text-[10px] text-neutral-500">Web + detayli analiz</div></div>
            </label>
          </div>
        </div>
        <div id="slide-format-hint" class="text-[10px] text-teal-600 px-1"></div>
      </div>
      <button onclick="generateSlides()" class="w-full mt-5 py-3 rounded-xl text-sm font-bold text-white transition-all" style="background:#0d9488">Sunumu Olustur</button>
    </div>
  </div>
  <!-- Slide Preview Modal -->
  <div id="slide-preview-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-[55] flex flex-col">
    <div class="flex items-center justify-between px-5 py-3 border-b border-[#222] shrink-0 gap-2">
      <div class="flex items-center gap-2 min-w-0 flex-1">
        <div class="w-7 h-7 shrink-0 rounded-lg bg-teal-600/20 flex items-center justify-center"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#2dd4bf" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg></div>
        <h3 class="text-sm font-bold text-white truncate" id="slide-preview-title">Sunum Onizlemesi</h3>
        <span id="slide-preview-count" class="text-[10px] text-neutral-500 bg-[#1a1a1a] px-2 py-0.5 rounded-full shrink-0 hidden sm:inline"></span>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        <button onclick="downloadPptxFromPreview()" id="slide-preview-dl-btn" class="flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-bold text-white transition-all whitespace-nowrap" style="background:#0d9488;min-height:36px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span class="hidden xs:inline">PPTX </span>Indir</button>
        <button onclick="closeSlidePreview()" class="w-9 h-9 flex items-center justify-center rounded-lg text-neutral-500 hover:text-white hover:bg-white/10 text-lg leading-none transition-all">&times;</button>
      </div>
    </div>
    <div id="slide-preview-grid" class="flex-1 overflow-y-auto p-5 grid gap-4" style="grid-template-columns:repeat(auto-fill,minmax(min(280px,100%),1fr));align-content:start;"></div>
  </div>
  <!-- Report Maker Modal -->
  <div id="report-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div class="bg-[#111] border border-[#222] p-6 rounded-2xl w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-200">
      <div class="flex justify-between items-center mb-5">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-xl bg-orange-600/20 flex items-center justify-center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fb923c" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg></div>
          <h3 class="text-base font-bold text-white">Detayli Rapor Olustur</h3>
        </div>
        <button onclick="closeReportModal()" class="text-neutral-500 hover:text-white text-lg">&times;</button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-1.5">Konu / Baslik</label>
          <input id="report-topic" type="text" placeholder="orn: E-Ticaretin Turkiye'deki Buyumesi 2024-2025" class="feature-modal-input" />
        </div>
        <div>
          <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-1.5">Rapor Turu</label>
          <select id="report-type" class="feature-modal-select">
            <option value="academic" selected>Akademik Makale</option>
            <option value="business">Is / Ynetim Raporu</option>
            <option value="technical">Teknik Dokumantasyon</option>
            <option value="research">Arastirma Raporu</option>
            <option value="analysis">Pazar Analizi</option>
          </select>
        </div>
        <div>
          <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-1.5">Ek Bolumler (Opsiyonel)</label>
          <input id="report-sections" type="text" placeholder="orn: SWOT analizi, rakip analizi..." class="feature-modal-input" />
        </div>
        <div>
          <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-1.5">Hedef Uzunluk</label>
          <select id="report-length" class="feature-modal-select">
            <option value="short">Kisa (~800 kelime)</option>
            <option value="medium" selected>Orta (~1500 kelime)</option>
            <option value="long">Uzun (~3000 kelime)</option>
            <option value="comprehensive">Kapsamli (~5000 kelime)</option>
          </select>
        </div>
        <div>
          <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-1.5">Arastirma Modu</label>
          <div class="grid grid-cols-2 gap-2">
            <label id="report-quick-btn" class="flex items-center gap-2 p-2.5 rounded-xl border border-blue-500/40 bg-blue-600/15 cursor-pointer transition-all" onclick="setReportResearch('quick')">
              <input type="radio" name="report-research" value="quick" checked class="accent-blue-500 shrink-0" />
              <div><div class="text-xs font-bold text-blue-300">Hizli</div><div class="text-[10px] text-neutral-500">Anlk cevap</div></div>
            </label>
            <label id="report-deep-btn" class="flex items-center gap-2 p-2.5 rounded-xl border border-[#333] cursor-pointer transition-all" onclick="setReportResearch('deep')">
              <input type="radio" name="report-research" value="deep" class="accent-amber-500 shrink-0" />
              <div><div class="text-xs font-bold text-neutral-300">Derin Arastirma</div><div class="text-[10px] text-neutral-500">Web + detayli analiz</div></div>
            </label>
          </div>
        </div>
      </div>
      <button onclick="generateReport()" class="w-full mt-5 py-3 rounded-xl text-sm font-bold text-white transition-all" style="background:#ea580c">Raporu Olustur</button>
    </div>
  </div>
  <!-- Edit Message Modal -->
  <div id="edit-msg-modal" class="hidden edit-msg-overlay">
    <div class="edit-msg-box">
      <div class="flex items-center justify-between mb-4">
        <span class="text-sm font-bold text-white">Mesaji Duzenle</span>
        <button onclick="closeEditModal()" class="text-neutral-500 hover:text-white text-lg">&times;</button>
      </div>
      <textarea id="edit-msg-textarea" rows="5" class="notepad-textarea mb-4" style="min-height:100px;width:100%;"></textarea>
      <div class="flex gap-3">
        <button onclick="closeEditModal()" class="flex-1 py-2.5 rounded-xl text-sm font-bold border border-[#333] text-neutral-400 hover:text-white hover:border-neutral-500 transition-all">Iptal</button>
        <button onclick="confirmEditMessage()" class="flex-1 py-2.5 rounded-xl text-sm font-bold text-white transition-all" style="background:var(--accent)">Gonder</button>
      </div>
    </div>
  </div>
  <!-- Settings Modal -->
  <div id="settings-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div
      class="bg-[#111] border border-[#222] p-6 rounded-2xl w-full max-w-lg shadow-2xl transform scale-95 transition-transform duration-200 max-h-[90vh] max-h-[90dvh] overflow-y-auto">
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-base font-bold text-white">Ayarlar</h3><button onclick="closeSettings()"
          class="text-neutral-500 hover:text-white text-lg">&times;
        </button>
      </div>
      <div class="space-y-3 max-h-[70vh] overflow-y-auto pr-1">
        <!-- Stream --><label
          class="flex items-center justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222] cursor-pointer hover:bg-white/[0.04] transition-colors"><span
            class="text-sm text-neutral-300">Stream (Akis) Modu</span><input id="pref-stream" type="checkbox"
            class="accent-blue-600 w-4 h-4"></label>
        <!-- Theme --><label
          class="flex items-center justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222] cursor-pointer hover:bg-white/[0.04] transition-colors"><span
            class="text-sm text-neutral-300">Acik Tema (Light Mode)</span><input id="pref-theme" type="checkbox"
            class="accent-blue-600 w-4 h-4"></label>
        <!-- Auto theme --><label
          class="flex items-center justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222] cursor-pointer hover:bg-white/[0.04] transition-colors"><div><span
            class="text-sm text-neutral-300">Otomatik Tema</span><div class="text-[10px] text-neutral-600 mt-0.5">07:00-20:00 acik, gece karanlik</div></div><input id="pref-auto-theme" type="checkbox"
            class="accent-blue-600 w-4 h-4"></label>
        <!-- Font size -->
        <div class="p-3 bg-white/[0.02] rounded-xl border border-[#222]"><label
            class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-2">Yazi
            Boyutu</label>
          <div class="flex gap-2"><button onclick="setFontSize('sm')" id="font-sm-btn"
              class="flex-1 py-2 rounded-lg text-xs font-bold border border-[#222] text-neutral-400 hover:text-white hover:border-blue-500 transition-all">Kucuk</button><button
              onclick="setFontSize('md')" id="font-md-btn"
              class="flex-1 py-2 rounded-lg text-xs font-bold border border-[#222] text-neutral-400 hover:text-white hover:border-blue-500 transition-all">Orta</button><button
              onclick="setFontSize('lg')" id="font-lg-btn"
              class="flex-1 py-2 rounded-lg text-xs font-bold border border-[#222] text-neutral-400 hover:text-white hover:border-blue-500 transition-all">Buyuk</button>
          </div>
        </div>
        <!-- Max tokens -->
        <div class="p-3 bg-white/[0.02] rounded-xl border border-[#222]">
          <div class="flex justify-between items-center mb-2"><label
              class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider">Max
              Token</label><span id="max-token-val" class="text-[10px] text-blue-400 font-mono">4096</span></div>
          <input id="pref-max-tokens" type="range" min="256" max="16384" step="256" value="4096"
            class="w-full accent-blue-600" oninput="$('max-token-val').textContent=this.value">
        </div>
        <!-- Accent Color -->
        <div class="p-3 bg-white/[0.02] rounded-xl border border-[#222]">
          <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-2">Tema
            Rengi</label>
          <div class="flex gap-2"><button onclick="setAccent('blue')" data-accent-color="blue"
              class="w-8 h-8 rounded-full bg-blue-600 border-2 border-transparent hover:border-white transition-all"
              title="Mavi"></button><button onclick="setAccent('green')" data-accent-color="green"
              class="w-8 h-8 rounded-full bg-green-600 border-2 border-transparent hover:border-white transition-all"
              title="Yesil"></button><button onclick="setAccent('purple')" data-accent-color="purple"
              class="w-8 h-8 rounded-full bg-purple-600 border-2 border-transparent hover:border-white transition-all"
              title="Mor"></button><button onclick="setAccent('red')" data-accent-color="red"
              class="w-8 h-8 rounded-full bg-red-600 border-2 border-transparent hover:border-white transition-all"
              title="Kirmizi"></button><button onclick="setAccent('amber')" data-accent-color="amber"
              class="w-8 h-8 rounded-full bg-amber-600 border-2 border-transparent hover:border-white transition-all"
              title="Amber"></button><button onclick="setAccent('cyan')" data-accent-color="cyan"
              class="w-8 h-8 rounded-full bg-cyan-600 border-2 border-transparent hover:border-white transition-all"
              title="Cyan"></button></div>
        </div>
        <!-- Notification sound --><label
          class="flex items-center justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222] cursor-pointer hover:bg-white/[0.04] transition-colors"><span
            class="text-sm text-neutral-300">Bildirim Sesi</span><input id="pref-notify-sound" type="checkbox"
            class="accent-blue-600 w-4 h-4"></label>
        <!-- Show Thinking --><label
          class="flex items-center justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222] cursor-pointer hover:bg-white/[0.04] transition-colors">
          <div><span class="text-sm text-neutral-300">Dusunme Surecini
              Goster</span>
            <div class="text-[10px] text-neutral-600 mt-0.5">Modelin
              dusunme/reasoning adimlarini goster (destekleyen modellerde)
            </div>
          </div><input id="pref-show-thinking" type="checkbox" class="accent-purple-600 w-4 h-4">
        </label><label
          class="flex items-center justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222] cursor-pointer hover:bg-white/[0.04] transition-colors"><span
            class="text-sm text-neutral-300">Kisa ve direkt cevap
            ver</span><input id="pref-short" type="checkbox" class="accent-blue-600 w-4 h-4"></label><label
          class="flex items-center justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222] cursor-pointer hover:bg-white/[0.04] transition-colors"><span
            class="text-sm text-neutral-300">Gereksiz aciklamalari atla
            (Kod icin)</span><input id="pref-no-lecture" type="checkbox" class="accent-blue-600 w-4 h-4"></label><label
          class="flex items-center justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222] cursor-pointer hover:bg-white/[0.04] transition-colors"><span
            class="text-sm text-neutral-300">Her zaman Turkce
            yanitla</span><input id="pref-turkish" type="checkbox" class="accent-blue-600 w-4 h-4"></label>
        <div class="p-3 bg-white/[0.02] rounded-xl border border-[#222]">
          <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-2">Ses Stili</label>
          <div class="grid grid-cols-3 gap-2" id="voice-style-group">
            <button type="button" data-style="samimi" onclick="selectVoiceStyle('samimi')"
              class="voice-style-btn py-2.5 px-2 rounded-xl text-xs font-semibold border border-[#333] text-neutral-400 hover:text-white hover:border-blue-500 transition-all text-center">
              <div class="text-base mb-0.5">&#x1F917;</div>
              <div>Samimi</div>
              <div class="text-[9px] font-normal text-neutral-500 mt-0.5">Sicak & dogal</div>
            </button>
            <button type="button" data-style="profesyonel" onclick="selectVoiceStyle('profesyonel')"
              class="voice-style-btn py-2.5 px-2 rounded-xl text-xs font-semibold border border-[#333] text-neutral-400 hover:text-white hover:border-blue-500 transition-all text-center">
              <div class="text-base mb-0.5">&#x1F454;</div>
              <div>Profesyonel</div>
              <div class="text-[9px] font-normal text-neutral-500 mt-0.5">Net & otoriter</div>
            </button>
            <button type="button" data-style="zkusagi" onclick="selectVoiceStyle('zkusagi')"
              class="voice-style-btn py-2.5 px-2 rounded-xl text-xs font-semibold border border-[#333] text-neutral-400 hover:text-white hover:border-blue-500 transition-all text-center">
              <div class="text-base mb-0.5">&#x26A1;</div>
              <div>Z Kusagi</div>
              <div class="text-[9px] font-normal text-neutral-500 mt-0.5">Hizli & enerjik</div>
            </button>
          </div>
          <input type="hidden" id="pref-voice-style" value="samimi">
        </div>
        <div class="p-3 bg-white/[0.02] rounded-xl border border-[#222]">
          <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider block mb-2">Oturum
            Modu</label><select id="pref-auth-mode"
            class="w-full bg-[#0a0a0a] border border-[#222] rounded-lg p-2 text-sm outline-none focus:border-blue-500 transition-colors text-neutral-300">
            <option value="local">Local Storage (Misafir)</option>
            <option value="puter">Puter Hesabi (Bulut)</option>
          </select>
        </div>
        <div>
          <div class="flex items-center justify-between gap-2 ml-1 mb-1.5 flex-wrap">
            <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider shrink-0">Ozel Sistem Talimati</label>
            <button onclick="saveSystemPromptToLibrary()" class="text-[9px] text-blue-400 hover:text-blue-300 font-bold uppercase tracking-wider px-2 py-1 rounded border border-blue-500/30 hover:bg-blue-500/10 transition-all whitespace-nowrap" style="min-height:28px">+ Kaydet</button>
          </div>
          <textarea id="pref-custom" rows="3"
            class="w-full bg-[#0a0a0a] border border-[#222] rounded-xl p-3 text-sm outline-none focus:border-blue-500 transition-colors resize-none text-neutral-300"
            placeholder="Orn: Samimi ama profesyonel ol."></textarea>
        </div>
        <!-- System Prompt Library -->
        <div class="p-3 bg-white/[0.02] rounded-xl border border-[#222]">
          <div class="prompt-lib-header flex items-center justify-between mb-2">
            <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider">Kaydedilmis Promptlar</label>
            <span id="prompt-library-count" class="text-[9px] text-neutral-600">0 prompt</span>
          </div>
          <div id="prompt-library-list" class="space-y-1.5 max-h-36 overflow-y-auto">
            <div class="text-[11px] text-neutral-600 text-center py-3">Henuz kaydedilmis prompt yok.<br>Yukardaki alana yaz ve "+ Kutuphanye Kaydet"e bas.</div>
          </div>
        </div>
        <!-- Provider Section -->
        <div class="border-t border-[#333] pt-4 mt-4"><label
            class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider ml-1 block mb-2">Provider
            Ayarlari</label>
          <div class="space-y-4">
            <div><label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider ml-1">Aktif
                Provider</label><select id="provider-select"
                class="w-full bg-[#0a0a0a] border border-[#222] rounded-xl p-3 mt-1.5 text-sm outline-none focus:border-blue-500 transition-colors text-neutral-200">
                <option value="puter">Puter.js (Varsayilan)</option>
                <option value="anthropic">Anthropic (Messages API)
                </option>
                <option value="custom">Custom Provider
                  (OpenAI-Compatible)</option>
              </select></div>
            <!-- Custom Fields -->
            <div id="fields-custom" class="provider-fields hidden space-y-4">
              <div>
                <div class="flex justify-between items-center ml-1">
                  <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider">Base
                    URL</label><select id="preconfigured-urls"
                    class="text-[9px] text-blue-400 bg-transparent outline-none cursor-pointer">
                    <option value="">Hizli Sec...</option>
                    <optgroup label="Bulut Servisleri">
                      <option value="google">Google</option>
                      <option value="claude">Claude</option>
                      <option value="chatgpt">ChatGPT</option>
                      <option value="kimi">Kimi</option>
                      <option value="deepseek">DeepSeek</option>
                      <option value="openrouter">OpenRouter</option>
                      <option value="z.ai">Z.ai</option>
                      <option value="minimax">MiniMax</option>
                    </optgroup>
                    <optgroup label="Dogrudan Servisler">
                      <option value="gemini-local">Gemini API</option>
                      <option value="codex-local">Codex / Custom API
                      </option>
                    </optgroup>
                  </select>
                </div><input type="text" id="custom-url" placeholder="https://api.openai.com/v1"
                  class="w-full bg-[#0a0a0a] border border-[#222] rounded-xl p-3 mt-1.5 text-sm outline-none focus:border-green-500 transition-colors mono text-neutral-300">
              </div>
              <div><label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider ml-1">API
                  Key</label><input type="password" id="custom-token" placeholder="sk-..."
                  class="w-full bg-[#0a0a0a] border border-[#222] rounded-xl p-3 mt-1.5 text-sm outline-none focus:border-green-500 transition-colors mono text-neutral-300">
              </div>
              <div>
                <div class="flex justify-between items-center ml-1">
                  <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider">Model
                    ID</label><button onclick="manualFetchCustomModels(this)"
                    class="text-[9px] text-blue-400 hover:text-blue-300 font-bold uppercase">Yenile</button>
                </div><input type="text" id="custom-model-id" list="custom-models-list" placeholder="gpt-4"
                  class="w-full bg-[#0a0a0a] border border-[#222] rounded-xl p-3 mt-1.5 text-sm outline-none focus:border-green-500 transition-colors mono text-neutral-300"><datalist
                  id="custom-models-list"></datalist>
              </div>
            </div>
            <!-- Anthropic Fields -->
            <div id="fields-anthropic" class="provider-fields hidden space-y-4">
              <div class="flex items-center justify-between px-1">
                <span class="text-[10px] text-neutral-500 italic">Anthropic
                  Messages API</span>
                <div class="flex gap-2"><button onclick="checkAnthropicHealth(this)"
                    class="text-[9px] text-green-400 hover:text-green-300 font-bold uppercase">Health</button><button
                    onclick="checkAnthropicLimits(this)"
                    class="text-[9px] text-orange-400 hover:text-orange-300 font-bold uppercase">Limits</button>
                </div>
              </div>
              <div><label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider ml-1">Base
                  URL</label><input type="text" id="anthropic-url" placeholder="http://localhost:8080"
                  class="w-full bg-[#0a0a0a] border border-[#222] rounded-xl p-3 mt-1.5 text-sm outline-none focus:border-red-500 transition-colors mono text-neutral-300">
              </div>
              <div><label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider ml-1">API
                  Key (Opsiyonel)</label><input type="password" id="anthropic-token" placeholder="anthropic_api_key..."
                  class="w-full bg-[#0a0a0a] border border-[#222] rounded-xl p-3 mt-1.5 text-sm outline-none focus:border-red-500 transition-colors mono text-neutral-300">
              </div>
              <div>
                <div class="flex justify-between items-center ml-1">
                  <label class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider">Model
                    ID</label>
                  <div class="flex gap-2"><button onclick="refreshTokenAnthropic(this)"
                      class="text-[9px] text-purple-400 hover:text-purple-300 font-bold uppercase">Refresh</button><button
                      onclick="manualFetchAnthropicModels(this)"
                      class="text-[9px] text-blue-400 hover:text-blue-300 font-bold uppercase">Modelleri
                      Al</button></div>
                </div><input type="text" id="anthropic-model-id" list="anthropic-models-list"
                  placeholder="claude-3-5-sonnet-20241022"
                  class="w-full bg-[#0a0a0a] border border-[#222] rounded-xl p-3 mt-1.5 text-sm outline-none focus:border-red-500 transition-colors mono text-neutral-300"><datalist
                  id="anthropic-models-list"></datalist>
              </div>
            </div>
          </div>
        </div>
      </div><button onclick="saveSettings()"
        class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl text-sm font-bold transition-all mt-5">Kaydet
      </button>
    </div>
  </div>
  <!-- Reset Modal -->
  <div id="reset-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <div class="bg-[#111] border border-[#222] p-6 rounded-2xl w-full max-w-sm shadow-2xl transform scale-95 transition-transform duration-200">
      <h3 class="text-base font-bold text-white mb-2">Verileri Sifirla</h3>
      <p class="text-xs text-neutral-400 mb-5">Ne kadarini silmek istiyorsun?</p>
      <div class="space-y-2">
        <button onclick="resetLocalOnly()" class="w-full flex flex-col items-start px-4 py-3 rounded-xl bg-[#1a1a1a] hover:bg-[#222] border border-[#2a2a2a] hover:border-yellow-500/40 transition-all text-left group">
          <span class="text-xs font-semibold text-neutral-200 group-hover:text-yellow-400 transition-colors">Sadece yerel depoyu temizle</span>
          <span class="text-[10px] text-neutral-500 mt-0.5">localStorage silinir. Hesabindaki sohbetler korunur.</span>
        </button>
        <button onclick="resetEverything()" class="w-full flex flex-col items-start px-4 py-3 rounded-xl bg-[#1a1a1a] hover:bg-[#222] border border-[#2a2a2a] hover:border-red-500/40 transition-all text-left group">
          <span class="text-xs font-semibold text-neutral-200 group-hover:text-red-400 transition-colors">Her seyi sil</span>
          <span class="text-[10px] text-neutral-500 mt-0.5">localStorage + Supabase'deki tum sohbetler kalici olarak silinir.</span>
        </button>
      </div>
      <button onclick="closeResetModal()" class="w-full mt-3 py-2 rounded-xl text-xs text-neutral-500 hover:text-neutral-300 hover:bg-white/5 transition-all">Vazgec</button>
    </div>
  </div>
  <script>
    // ---- Supabase Config
    const SUPABASE_URL = 'https://vvdkslzqhqhatcesxwqu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2ZGtzbHpxaHFoYXRjZXN4d3F1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NDcxMzMsImV4cCI6MjA4NzUyMzEzM30.I4-RwiYNhwUtX6EPyp8U-zQ0Z6Uvk5novSD1I5X-Ge4';
    let supabaseClient = null;
    let githubUser = null;

    function initSupabase() {
      if (typeof supabase !== 'undefined' && supabase.createClient) {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        supabaseClient.auth.onAuthStateChange((event, session) => {
          (() => {
            const prevUser = githubUser;
            githubUser = session?.user || null;
            updateGithubAuthUI(githubUser);
            if (githubUser && !prevUser) {
              loadChatsFromSupabase();
            } else if (!githubUser && prevUser) {
              clearChatsFromUI();
            }
          })();
        });
        supabaseClient.auth.getSession().then(({ data }) => {
          githubUser = data?.session?.user || null;
          updateGithubAuthUI(githubUser);
          if (githubUser) loadChatsFromSupabase();
        });
      }
    }

    async function loadChatsFromSupabase() {
      if (!supabaseClient || !githubUser) return;
      const { data, error } = await supabaseClient
        .from('chats')
        .select('*')
        .eq('user_id', githubUser.id)
        .order('updated_at', { ascending: false });
      if (error) { console.error('Supabase load error:', error); return; }
      if (data && data.length > 0) {
        chats = data.map(r => ({
          id: r.id,
          title: r.title,
          messages: r.messages || [],
          pinned: r.pinned || false,
          folder: r.folder || undefined,
          canvas: r.canvas || null
        }));
        localStorage.setItem(KEY_CHATS, JSON.stringify(chats));
        renderChatList();
        if (chats.length > 0) loadChat(chats[0].id);
      }
    }

    async function syncChatsToSupabase() {
      if (!supabaseClient || !githubUser) return;
      const rows = chats.map(c => ({
        id: c.id,
        user_id: githubUser.id,
        title: c.title || '',
        messages: (c.messages || []).filter(m => !(typeof m.content === 'string' && m.content.startsWith('__PPTX_DOWNLOAD__'))),
        pinned: c.pinned || false,
        folder: c.folder || null,
        canvas: c.canvas || null,
        updated_at: new Date().toISOString()
      }));
      if (rows.length === 0) return;
      const { error } = await supabaseClient.from('chats').upsert(rows, { onConflict: 'id' });
      if (error) console.error('Supabase sync error:', error);
    }

    async function deleteChatFromSupabase(id) {
      if (!supabaseClient || !githubUser) return;
      await supabaseClient.from('chats').delete().eq('id', id).eq('user_id', githubUser.id);
    }

    async function deleteAllChatsFromSupabase() {
      if (!supabaseClient || !githubUser) return;
      await supabaseClient.from('chats').delete().eq('user_id', githubUser.id);
    }

    function clearChatsFromUI() {
      chats = [];
      currentChatId = null;
      localStorage.removeItem(KEY_CHATS);
      if (typeof renderChatList === 'function') renderChatList();
      if (typeof renderMessages === 'function') renderMessages([]);
      if (typeof showWelcome === 'function') showWelcome();
    }

    async function signInWithGoogle() {
      if (!supabaseClient) { alert('Supabase baslatlamad.'); return; }
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.origin, queryParams: { access_type: 'offline', prompt: 'consent' } }
      });
      if (error) { console.error('Google OAuth error:', error); alert('Giris hatasi: ' + error.message); }
    }

    async function signInWithGithub() {
      if (!supabaseClient) { alert('Supabase baslatlamad.'); return; }
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'github',
        options: { redirectTo: window.location.origin }
      });
      if (error) { console.error('GitHub OAuth error:', error); alert('Giris hatasi: ' + error.message); }
    }

    async function signOutGithub() {
      if (!supabaseClient) return;
      closeGithubMenu();
      await supabaseClient.auth.signOut();
      githubUser = null;
      updateGithubAuthUI(null);
    }

    function updateGithubAuthUI(user) {
      const userPanel = document.getElementById('github-user-panel');
      const signinPanel = document.getElementById('github-signin-panel');
      const headerGithubBtn = document.getElementById('header-github-btn');
      const headerAvatarBtn = document.getElementById('header-avatar-btn');

      if (user) {
        const name = user.user_metadata?.full_name || user.user_metadata?.user_name || user.user_metadata?.name || user.email || '';
        const email = user.email || '';
        const avatar = user.user_metadata?.avatar_url || user.user_metadata?.picture || '';

        const nameEl = document.getElementById('github-user-name');
        const emailEl = document.getElementById('github-user-email');
        const hmenuName = document.getElementById('hmenu-name');
        const hmenuEmail = document.getElementById('hmenu-email');
        if (nameEl) nameEl.textContent = name;
        if (emailEl) emailEl.textContent = email;
        if (hmenuName) hmenuName.textContent = name;
        if (hmenuEmail) hmenuEmail.textContent = email;

        const avatarImg = document.getElementById('auth-avatar-img');
        const avatarFallback = document.getElementById('auth-avatar-fallback');
        const headerAvatarImg = document.getElementById('header-avatar-img');
        const headerAvatarFallback = document.getElementById('header-avatar-fallback');
        if (avatar) {
          if (avatarImg) { avatarImg.src = avatar; avatarImg.classList.remove('hidden'); }
          if (avatarFallback) avatarFallback.classList.add('hidden');
          if (headerAvatarImg) { headerAvatarImg.src = avatar; headerAvatarImg.classList.remove('hidden'); }
          if (headerAvatarFallback) headerAvatarFallback.classList.add('hidden');
        } else {
          if (avatarImg) avatarImg.classList.add('hidden');
          if (avatarFallback) avatarFallback.classList.remove('hidden');
          if (headerAvatarImg) headerAvatarImg.classList.add('hidden');
          if (headerAvatarFallback) headerAvatarFallback.classList.remove('hidden');
        }

        if (userPanel) userPanel.classList.remove('hidden');
        if (signinPanel) signinPanel.classList.add('hidden');
        if (headerGithubBtn) headerGithubBtn.style.display = 'none';
        if (headerAvatarBtn) headerAvatarBtn.style.display = 'flex';
      } else {
        if (userPanel) userPanel.classList.add('hidden');
        if (signinPanel) signinPanel.classList.remove('hidden');
        if (headerGithubBtn) headerGithubBtn.style.display = 'flex';
        if (headerAvatarBtn) headerAvatarBtn.style.display = 'none';
      }
    }

    function toggleGithubMenu() {
      const menu = document.getElementById('header-github-menu');
      if (menu) menu.classList.toggle('hidden');
    }

    function closeGithubMenu() {
      const menu = document.getElementById('header-github-menu');
      if (menu) menu.classList.add('hidden');
    }

    document.addEventListener('click', (e) => {
      const menu = document.getElementById('header-github-menu');
      const avatarBtn = document.getElementById('header-avatar-btn');
      if (menu && !menu.classList.contains('hidden') && !menu.contains(e.target) && !avatarBtn?.contains(e.target)) {
        menu.classList.add('hidden');
      }
    });

    // ---- State
    const KEY_CHATS = 'p_chats_v11';
    const KEY_PROVIDERS = 'p_providers_v11';
    const KEY_PREFS = 'prefs_v11';
    const KEY_STYLE = 'style_v11';

    const PRECONFIGURED_PROVIDERS = {
      "google": "https://generativelanguage.googleapis.com/v1beta/openai",
      "claude": "https://api.anthropic.com/v1",
      "chatgpt": "https://api.openai.com/v1",
      "kimi": "https://api.moonshot.cn/v1",
      "deepseek": "https://api.deepseek.com",
      "openrouter": "https://openrouter.ai/api/v1",
      "z.ai": "https://api.zeroone.ai/v1",
      "minimax": "https://api.minimax.chat/v1",
      "gemini-local": "http://localhost:8080/v1",
      "codex-local": "http://localhost:3000/v1"
    }

      ;

    const IMAGE_MODELS = ['flux-1.1-pro',
      'flux-1.1-pro-ultra',
      'flux-dev',
      'flux-schnell',
      'flux-pro',
      'imagen-4.0-ultra',
      'imagen-4.0-preview',
      'imagen-4.0-fast',
      'dall-e-3-hd',
      'dall-e-3',
      'dall-e-2',
      'stable-diffusion-3.5-large',
      'stable-diffusion-xl',
      'ideogram-3.0',
      'midjourney-v7',
      'gemini-3-pro-image-preview',
      'gpt-image-1.5',
      'black-forest-labs/FLUX.1-pro',
      'black-forest-labs/FLUX.1-schnell',
      'gemini-2.0-flash-exp',
      'gemini-1.5-flash',
      'gemini-1.5-pro'
    ];

    const VIDEO_MODELS = ['sora-2',
      'sora-2-pro',
      'luma-dream-machine',
      'runway-gen-3',
      'kling-1.5',
      'pika-2.0',
      'stable-video-diffusion',
      'cogvideo-5b',
      'haiper-video-v2'
    ];

    let chats = JSON.parse(localStorage.getItem(KEY_CHATS) || '[]');
    let currentChatId = null;

    let providerSettings = JSON.parse(localStorage.getItem(KEY_PROVIDERS) || JSON.stringify({

      active: 'puter',
      authMode: 'local',
      custom: {
        token: '', baseUrl: '', modelId: ''
      }

      ,
      anthropic: {
        token: '', baseUrl: 'http://localhost:8080', modelId: 'claude-3-5-sonnet-20241022'
      }
    }));

    if (!providerSettings.anthropic) providerSettings.anthropic = {
      token: '', baseUrl: 'http://localhost:8080', modelId: 'claude-3-5-sonnet-20241022'
    }

      ;

    if (!providerSettings.custom) providerSettings.custom = {
      token: '', baseUrl: '', modelId: ''
    }

      ;

    // Migrate: if old active provider was removed, default to puter
    if (['copilot', 'hf', 'g4f'].includes(providerSettings.active)) {
      providerSettings.active = 'puter';
    }

    let prefs = JSON.parse(localStorage.getItem(KEY_PREFS) || '{"modelA":"gpt-4o-mini","stream":true,"maxTokens":4096,"fontSize":"md","accent":"blue","notifySound":false,"showThinking":true}');
    // Migrate: ensure showThinking exists in saved prefs
    if (prefs.showThinking === undefined) prefs.showThinking = true;
    let _noCanvas = false;
    let _pptxMode = false;
    let stylePrefs = JSON.parse(localStorage.getItem(KEY_STYLE) || '{"short":true,"noLecture":true,"turkish":true,"custom":"","voiceStyle":"samimi"}');
    let availableModels = [];
    let customModels = [];
    let puterReady = false;
    let selectedFiles = [];
    let currentAbortController = null;
    let isGenerating = false;
    let compareActive = false;
    let compareMessagesA = [];
    let compareMessagesB = [];
    let memory = JSON.parse(localStorage.getItem('ai_memory') || '{}');
    let bookmarks = JSON.parse(localStorage.getItem('ai_bookmarks') || '[]');
    let canvasTerminal = null;
    let canvasTerminalFit = null;

    const PROMPT_TEMPLATES = [{
      icon: '', title: 'Ceviri', color: 'text-cyan-400', prompt: 'Su metni Ingilizceye cevir: '
    }

      ,
    {
      icon: '', title: 'Ozet Cikar', color: 'text-blue-400', prompt: 'Su metni ozetle: '
    }

      ,
    {
      icon: '', title: 'Kod Review', color: 'text-green-400', prompt: 'Su kodu incele, hatalari ve iyilestirme noktalarini bul: '
    }

      ,
    {
      icon: '', title: 'Bug Fix', color: 'text-red-400', prompt: 'Bu koddaki hatayi bul ve duzelt: '
    }

      ,
    {
      icon: '', title: 'Email Yaz', color: 'text-purple-400', prompt: 'Profesyonel bir email yaz. Konu: '
    }

      ,
    {
      icon: '', title: 'Analiz', color: 'text-amber-400', prompt: 'Detayli bir analiz yap. Konu: '
    }

      ,
    {
      icon: '', title: 'UI/UX', color: 'text-pink-400', prompt: 'Modern bir arayuz tasarla (HTML/Tailwind): '
    }

      ,
    {
      icon: '', title: 'Acikla', color: 'text-indigo-400', prompt: 'Su konuyu basit ve anlasilir sekilde acikla: '
    }

      ,
    {
      icon: '', title: 'Test Yaz', color: 'text-teal-400', prompt: 'Su kod icin unit test yaz: '
    }

      ,
    {
      icon: '', title: 'Optimize Et', color: 'text-yellow-400', prompt: 'Su kodu performans acisindan optimize et: '
    }

      ,
    {
      icon: '', title: 'Guvenlik', color: 'text-rose-400', prompt: 'Su koddaki guvenlik acikliklaarini bul: '
    }

      ,
    {
      icon: '', title: 'Liste Olustur', color: 'text-emerald-400', prompt: 'Su konu hakkinda detayli bir liste olustur: '
    }

      ,
    ];

    const PERSONAS = [{
      icon: '', title: 'Senior Developer', prompt: 'Sen cok tecrubeli bir Senior Software Engineer\'sin. Yazdigin kodlar her zaman best-practice\'lere uygun, optimize edilmis ve temizdir. Kod verirken her zaman tam ve calisan hallerini ver.'
    }

      ,
    {
      icon: '', title: 'Ingilizce Ogretmeni', prompt: 'Sen native seviyesinde bir Ingilizce ogretmenisin. Kullaniciya sadece istedigi ceviri veya gramer kuralini vermekle kalma, ayni zamanda kelimenin etimolojisini ve ornek cumlelerini de ver.'
    }

      ,
    {
      icon: '', title: 'Metin Yazari (Copywriter)', prompt: 'Sen dahi bir reklam ve metin yazarisin. Urettigin metinler ikna edici, akici ve dikkat cekicidir. Kullanilan dil modern ve hedef kitleye yoneliktir.'
    }

      ,
    {
      icon: '', title: 'Siber Guvenlik Uzmani', prompt: 'Sen siber guvenlik ve penetrasyon testi uzmanisin. Inceledigin her kod parcasinda guvenlik acikliklari (SQLi, XSS, CSRF vb.) arar ve en guvenli yazilim mimarisini onerirsin.'
    }

      ,
    {
      icon: '', title: 'Universite Profesoru', prompt: 'Sen akademik duzeyde bilgili bir profesorsun. Aciklamalarin yuzeyel degil, derinlemesine, bilimsel temellere dayanan ve referansli olmalidir.'
    }

      ,
    {
      icon: '', title: 'Urun Yoneticisi (PM)', prompt: 'Sen tecrubeli bir Product Manager\'sin. Fikirleri is modeline, kullanici deneyimine ve pazara sunma stratejisine (GTM) donusturmekte uzmansin.'
    }

    ];

    // ---- Utils
    function debounce(fn, ms) {
      let t;

      return (...a) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...a), ms);
      }

        ;
    }

    function throttle(fn, ms) {
      let lock;

      return (...a) => {
        if (!lock) {
          fn(...a);
          lock = true;
          setTimeout(() => lock = false, ms);
        }
      }

        ;
    }

    const $ = (id) => document.getElementById(id);

    const setStatus = (t) => {
      if ($('status')) $('status').textContent = t;
    }

      ;

    const hideWelcome = () => {
      if ($('welcome-msg')) $('welcome-msg').style.display = 'none';
    }

      ;

    const showWelcome = () => {
      if ($('welcome-msg')) $('welcome-msg').style.display = 'flex';
    }

      ;
    const throttledRenderMessages = throttle((msgs) => renderMessages(msgs), 100);

    function saveAll() {
      debouncedSaveAll();
    }

    function _realSaveAll() {
      const chatsToSave = chats.map(c => ({
        ...c,
        messages: (c.messages || []).filter(m => !(typeof m.content === 'string' && m.content.startsWith('__PPTX_DOWNLOAD__')))
      }));
      localStorage.setItem(KEY_CHATS, JSON.stringify(chatsToSave));
      localStorage.setItem(KEY_PROVIDERS, JSON.stringify(providerSettings));
      localStorage.setItem(KEY_PREFS, JSON.stringify(prefs));
      localStorage.setItem(KEY_STYLE, JSON.stringify(stylePrefs));
      if (githubUser) syncChatsToSupabase();
    }

    const debouncedSaveAll = debounce(() => _realSaveAll(), 500);

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
    }

    function escapeJs(s) {
      return String(s).replace(/'/g, "\\'").replace(/\n/g, "\\n");
    }


    // ---- Response Format
    let activeFormat = null;
    const FORMAT_INSTRUCTIONS = {
      bullets:  'Cevabini madde madde, liste seklinde ver.',
      summary:  'Cevabini cok kisaca ve ozet olarak ver. Gereksiz detay ekleme.',
      detailed: 'Cevabini detayli, kapsamli ve aciklamali ver.'
    };

    function toggleFormat(fmt) {
      activeFormat = activeFormat === fmt ? null : fmt;
      document.querySelectorAll('.fmt-btn').forEach(btn => {
        const on = btn.dataset.fmt === activeFormat;
        btn.classList.toggle('active', on);
      });
    }

    // ---- System Prompt
    function buildSystemPrompt() {
      const r = [];
      if (stylePrefs.turkish) r.push("Turkce cevap ver.");
      if (stylePrefs.short) r.push("Kisa ve direkt cevap ver.");
      if (stylePrefs.noLecture) r.push("Kullanici kod istiyorsa sadece kodu ver, uzun aciklamalar yapma.");
      r.push("Kod verirken ```kod_dili``` formatini kullan.");
      const vs = stylePrefs.voiceStyle || 'samimi';
      if (vs === 'samimi') r.push("Samimi, sicak ve dogal bir dille yaz. Resmi olmayan ama saygi cercevesinde bir ton kullan.");
      if (vs === 'profesyonel') r.push("Profesyonel, net ve guvende veren bir dil kullan. Duzgunce yapi kurulmus, odakli cevaplar ver.");
      if (vs === 'zkusagi') r.push("Gen Z / Z kusagi gibi yaz: rahat, eglenceli, guncel slang kullan. Mesela 'ya', 'be', 'bro', 'literally', 'no cap', 'fr', 'slay' gibi. Ama anlaslr kal.");
      if (stylePrefs.custom && stylePrefs.custom.trim()) r.push(stylePrefs.custom.trim());
      if (activeFormat && FORMAT_INSTRUCTIONS[activeFormat]) r.push(FORMAT_INSTRUCTIONS[activeFormat]);
      const memCtx = buildMemoryContext();
      if (memCtx) r.push(memCtx);
      return r.join(" ");
    }

    // ---- Theme
    function toggleTheme() {
      const isLight = document.body.classList.toggle('light-mode');
      const icon = $('theme-icon');

      if (isLight) {
        icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
        document.body.style.backgroundColor = '#ffffff';
      }

      else {
        icon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
        document.body.style.backgroundColor = '';
      }

      // Update gradient overlay for input area
      const inputGradient = document.querySelector('.absolute.bottom-0 .bg-gradient-to-t, [class*="from-"]');

      if (inputGradient) {
        const parent = document.querySelector('.absolute.bottom-0');
        if (parent) parent.style.background = isLight ? 'linear-gradient(to top, #ffffff, rgba(255,255,255,0.95), transparent)' : '';
      }

      // Update model selector bg
      const modelSel = document.querySelector('.top-header [class*="bg-[#1a1a1a]"]');

      if (modelSel) {
        modelSel.style.background = isLight ? '#f0f0f0' : '';
        modelSel.style.borderColor = isLight ? '#ddd' : '';
      }

      localStorage.setItem('theme_mode', isLight ? 'light' : 'dark');
    }

    function applyAutoTheme() {
      if (!prefs.autoTheme) return;
      const hour = new Date().getHours();
      const wantLight = (hour >= 7 && hour < 20);
      const isLight = document.body.classList.contains('light-mode');
      if (wantLight !== isLight) toggleTheme();
    }

    // ---- Search
    function searchChats() {
      renderChatList($('search-input').value.toLowerCase());
    }

    // ---- Speech
    let recognition = null;
    let voiceConvMode = false;

    function setVoiceOverlayState(state) {
      const overlay = $('voice-overlay');
      const label = $('voice-overlay-label');
      if (!overlay) return;
      overlay.classList.remove('voice-overlay-state-listening', 'voice-overlay-state-speaking', 'voice-overlay-state-thinking');
      if (state === 'listening') {
        overlay.classList.add('voice-overlay-state-listening');
        if (label) label.textContent = 'Dinleniyor...';
      } else if (state === 'speaking') {
        overlay.classList.add('voice-overlay-state-speaking');
        if (label) label.textContent = 'Yapay Zeka Konusuyor';
      } else if (state === 'thinking') {
        if (label) label.textContent = 'Yanit Hazirlaniyor...';
      } else {
        if (label) label.textContent = 'Sesli Asistan Aktif';
      }
    }

    function toggleVoiceConv() {
      voiceConvMode = !voiceConvMode;
      const btn = $('voice-conv-btn');
      const overlay = $('voice-overlay');
      if (voiceConvMode) {
        btn.classList.add('vc-active');
        btn.classList.remove('text-neutral-500');
        if (overlay) overlay.classList.add('visible');
        setVoiceOverlayState('listening');
        setStatus('Sesli konusma modu aktif - Konusmaya baslayin');
        try { recognition && recognition.start(); } catch(e) {}
      } else {
        btn.classList.remove('vc-active');
        btn.classList.add('text-neutral-500');
        if (overlay) overlay.classList.remove('visible');
        setStatus('Sesli konusma modu kapandi');
        if (currentUtterance) { speechSynthesis.cancel(); currentUtterance = null; }
        try { recognition && recognition.stop(); } catch(e) {}
        const interim = $('voice-interim');
        if (interim) interim.textContent = '';
      }
    }

    function initSpeech() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        $('mic-btn').style.display = 'none';
        $('voice-conv-btn').style.display = 'none';
        return;
      }

      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = stylePrefs.turkish ? 'tr-TR' : 'en-US';
      recognition.continuous = false;
      recognition.interimResults = true;

      recognition.onstart = () => {
        $('mic-btn').classList.add('text-red-500');
        if (voiceConvMode) {
          $('voice-conv-btn').classList.add('vc-listening');
          setVoiceOverlayState('listening');
        }
        setStatus('Dinleniyor...');
      }

      recognition.onresult = (e) => {
        let interim = '';
        let final = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) final += e.results[i][0].transcript;
          else interim += e.results[i][0].transcript;
        }
        const interimEl = $('voice-interim');
        if (interimEl && voiceConvMode) {
          interimEl.textContent = interim || final || '';
        }
        if (final) {
          const inp = $('user-input');
          inp.value += (inp.value ? ' ' : '') + final;
          inp.dispatchEvent(new Event('input'));
          if (interimEl) interimEl.textContent = '';
          if (voiceConvMode && final.trim()) {
            setVoiceOverlayState('thinking');
            setTimeout(() => handleSend(), 300);
          }
        }
      }

      recognition.onerror = (e) => {
        if (e.error === 'no-speech' && voiceConvMode) {
          try { recognition.start(); } catch(err) {}
          return;
        }
        setStatus('Ses hatasi: ' + e.error);
        $('voice-conv-btn').classList.remove('vc-listening');
      }

      recognition.onend = () => {
        $('mic-btn').classList.remove('text-red-500');
        $('voice-conv-btn').classList.remove('vc-listening');
      }

      $('mic-btn').onclick = () => {
        try {
          recognition.start();
        }
        catch (e) {
          if (e.name === 'InvalidStateError') recognition.stop();
        }
      }

      $('voice-conv-btn').onclick = toggleVoiceConv;
    }

    // ---- Boot
    async function boot() {
      initSupabase();
      setStatus('Baslatiliyor...');
      loadSavedPrompts();
      initSpeech();
      initDragDrop();
      initKeyboardShortcuts();
      initClipboardPaste();
      initSelectionMenu();
      if (prefs.fontSize) setFontSize(prefs.fontSize);
      if (prefs.accent && prefs.accent !== 'blue') setAccent(prefs.accent);
      else updateAccentButtons('blue');
      if (!prefs.showThinking) document.body.classList.add('hide-thinking');

      if (typeof marked !== 'undefined') {
        marked.setOptions({
          highlight: function (code, lang) {
            if (typeof hljs !== 'undefined' && lang) {
              try {
                return hljs.highlight(code, {
                  language: lang
                }).value;
              }

              catch (e) { }
            }

            return code;
          }

          ,
          breaks: true, gfm: true
        });
      }

      if (prefs.autoTheme) { applyAutoTheme(); }
      else if (localStorage.getItem('theme_mode') === 'light') toggleTheme();
      loadSharedChat();

      if (providerSettings.authMode === 'puter') {
        if (!puter.auth.isSignedIn()) {
          setStatus('Giris yapmaniz gerekiyor.');
          $('login-btn').style.display = 'flex';

          $('login-btn').onclick = async () => {
            try {
              await puter.auth.signIn(); location.reload();
            }

            catch (e) {
              alert('Giris basarisiz.');
            }
          }

            ;
        }

        else {
          $('login-btn').style.display = 'none';
        }
      }

      try {
        const modelPromise = (typeof puter !== 'undefined' && puter.ai) ? puter.ai.listModels() : Promise.reject('puter not loaded');
        const timeoutPromise = new Promise((_, rej) => setTimeout(() => rej('timeout'), 8000));
        availableModels = await Promise.race([modelPromise, timeoutPromise]);

        if (!availableModels || availableModels.length === 0) {
          availableModels = [{
            id: 'gpt-4o-mini', name: 'GPT-4o Mini'
          }

            , {
            id: 'gpt-4o', name: 'GPT-4o'
          }

            , {
            id: 'claude-3-5-sonnet', name: 'Claude 3.5 Sonnet'
          }

          ];
        }

        puterReady = true;
        setStatus('Puter.ai hazir.');
      }

      catch (e) {
        availableModels = [{
          id: 'gpt-4o-mini', name: 'GPT-4o Mini'
        }

          , {
          id: 'gpt-4o', name: 'GPT-4o'
        }

        ];
        puterReady = true;
        setStatus('Puter baglanti hatasi (Fallback).');

        // Retry loading models in background after 3s
        setTimeout(async () => {
          try {
            if (typeof puter !== 'undefined' && puter.ai) {
              const models = await puter.ai.listModels();

              if (models && models.length > 0) {
                availableModels = models; await refreshModelDropdowns(); setStatus('Puter.ai hazir.');
              }
            }
          }

          catch (e2) { }
        }

          , 3000);
      }

      await refreshModelDropdowns();
      renderChatList();
      if (chats.length > 0) loadChat(chats[chats.length - 1].id);
      else showWelcome();

      $('menu-btn')?.addEventListener('click', toggleMobileSidebar);
      $('close-sidebar-btn')?.addEventListener('click', toggleMobileSidebar);
      $('sidebar-overlay')?.addEventListener('click', toggleMobileSidebar);

      // ---- Adaptive Viewport System ----
      initAdaptiveViewport();
    }

    function toggleMobileSidebar() {
      const s = $('sidebar'), o = $('sidebar-overlay');

      if (s.classList.contains('mobile-open')) {
        s.classList.remove('mobile-open'); o.classList.add('hidden');
      }

      else {
        s.classList.add('mobile-open'); o.classList.remove('hidden');
      }
    }

    // ---- Adaptive Viewport System ----
    function initAdaptiveViewport() {

      // 1) Set --vh custom property for accurate mobile viewport height
      function setVH() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', vh + 'px');
        document.documentElement.style.setProperty('--app-height', window.innerHeight + 'px');
      }

      setVH();
      window.addEventListener('resize', setVH);

      // 2) Use VisualViewport API for keyboard handling (iOS/Android)
      if (window.visualViewport) {
        let lastVPHeight = window.visualViewport.height;
        const inputArea = document.querySelector('.absolute.bottom-0');
        const chatWindow = $('chat-window');

        function onViewportResize() {
          const vp = window.visualViewport;
          const keyboardOpen = vp.height < window.innerHeight * 0.75;
          const offset = window.innerHeight - vp.height;

          if (inputArea) {
            if (keyboardOpen) {
              inputArea.style.transform = `translateY(-${offset - vp.offsetTop
                }

                px)`;

              // Scroll chat to bottom when keyboard opens
              if (chatWindow) {
                requestAnimationFrame(() => chatWindow.scrollTop = chatWindow.scrollHeight);
              }
            }

            else {
              inputArea.style.transform = '';
            }
          }

          lastVPHeight = vp.height;
        }

        window.visualViewport.addEventListener('resize', onViewportResize);
        window.visualViewport.addEventListener('scroll', onViewportResize);
      }

      // 3) Orientation change handler
      window.addEventListener('orientationchange', () => {
        setTimeout(() => {
          setVH();
          window.scrollTo(0, 0);
          document.body.scrollTop = 0;
        }

          , 200);
      });

      // 4) Prevent bounce scrolling on iOS
      document.body.addEventListener('touchmove', function (e) {
        if (e.target.closest('#chat-window, #sidebar, .canvas-body, .compare-live-body, .modal-scroll, [class*="overflow-y-auto"]')) return;
        if (e.target.closest('.input-box')) return;
        e.preventDefault();
      }

        , {
          passive: false
        });

      // 5) Log screen dimensions for debugging (can be removed later)
      if (window.innerWidth <= 768) {
        console.log('[AdaptiveViewport]', {
          innerW: window.innerWidth,
          innerH: window.innerHeight,
          screenW: screen.width,
          screenH: screen.height,
          dpr: window.devicePixelRatio,
          orientation: screen.orientation?.type || 'unknown'
        });
      }
    }

    async function refreshModelDropdowns() {
      const sel = $('model-a');
      if (!sel) return;
      sel.innerHTML = '<option disabled selected>Yukleniyor...</option>';
      let oldA = prefs.modelA || 'gpt-4o-mini';
      if (oldA === 'open_provider') oldA = 'gpt-4o-mini';
      const prov = providerSettings.active || 'puter';
      let html = '';

      if (prov === 'puter') {
        html += (availableModels.length > 0 ? availableModels : [{
          id: 'gpt-4o-mini'
        }

        ]).map(m => `<option value="${escapeHtml(m.id)}" >${escapeHtml(m.name || m.id)
          }

          </option>`).join('');
        html += '<option disabled></option><option disabled>GORSEL MODELLERI</option>';

        html += IMAGE_MODELS.map(m => `<option value="${escapeHtml(m)}" >${escapeHtml(m)
          }

          </option>`).join('');
        html += '<option disabled></option><option disabled>VIDEO MODELLERI</option>';

        html += VIDEO_MODELS.map(m => `<option value="${escapeHtml(m)}" >${escapeHtml(m)
          }

          </option>`).join('');
      }

      else if (prov === 'custom') {
        if (customModels.length === 0 && providerSettings.custom?.baseUrl) await fetchCustomModels();
        let optionsHtml = '';
        const savedId = providerSettings.custom?.modelId || 'gpt-4o';

        let modelsToRender = [...customModels];

        if (savedId && !modelsToRender.some(m => m.id === savedId)) {
          modelsToRender.unshift({
            id: savedId, name: savedId + ' (Manuel)'
          });
        }

        if (modelsToRender.length > 0) {
          optionsHtml += modelsToRender.map(m => `<option value="${escapeHtml(m.id)}" >${escapeHtml(m.name || m.id)
            }

          </option>`).join('');
        }

        else {
          optionsHtml += `<option value="${escapeHtml(savedId)}" >${escapeHtml(savedId)
            }

        </option>`;
        }

        optionsHtml += '<option disabled></option><option value="custom_manual_input">Yeni Model Ekle...</option>';
        html += optionsHtml;
      }

      else if (prov === 'anthropic') {
        const mId = providerSettings.anthropic?.modelId || 'claude-3-5-sonnet-20241022';

        html += `<option value="${escapeHtml(mId)}" >${escapeHtml(mId)
          }

      </option>`;
        html += '<option value="claude-3-5-sonnet-20241022">claude-3-5-sonnet</option>';
        html += '<option value="claude-3-opus-20240229">claude-3-opus</option>';
        html += '<option value="claude-3-haiku-20240307">claude-3-haiku</option>';
      }

      html += '<option disabled></option><option value="open_provider">Provider Degistir...</option>';
      sel.innerHTML = html;

      const exists = [...sel.options].some(o => o.value === oldA && !o.disabled);
      if (exists) sel.value = oldA;

      else {
        const fv = [...sel.options].find(o => !o.disabled && o.value !== 'open_provider'); if (fv) sel.value = fv.value;
      }

      prefs.modelA = sel.value;
      saveAll();

      sel.onchange = () => {
        if (sel.value === 'custom_manual_input') {
          const m = prompt('Manuel Model ID girin:');

          if (m) {
            providerSettings.custom.modelId = m.trim();
            saveAll();

            refreshModelDropdowns().then(() => {
              $('model-a').value = m.trim(); prefs.modelA = m.trim(); saveAll();
            });
          }

          else {
            sel.value = prefs.modelA;
          }

          return;
        }

        if (sel.value === 'open_provider') {
          sel.value = prefs.modelA; openProvider(); return;
        }

        prefs.modelA = sel.value;
        saveAll();
      }

        ;
    }

    // ---- Chat Management
    function createNewChat() {
      if (compareActive) exitCompareMode();
      const prevChat = chats.find(x => x.id === currentChatId);
      if (prevChat) prevChat.canvas = Object.keys(canvasFiles).length > 0 ? JSON.parse(JSON.stringify(canvasFiles)) : null;
      canvasFiles = {};
      canvasActiveFile = null;
      if (canvasOpen) closeCanvas();
      const c = { id: Date.now(), title: 'Yeni Sohbet', messages: [] };
      chats.push(c);
      currentChatId = c.id;
      saveAll(); renderChatList(); renderMessages([]); showWelcome();
      updateCanvasToggleBtn();
      $('user-input')?.focus();
    }

    function loadChat(id) {
      if (compareActive) exitCompareMode();
      const prevChat = chats.find(x => x.id === currentChatId);
      if (prevChat) prevChat.canvas = Object.keys(canvasFiles).length > 0 ? JSON.parse(JSON.stringify(canvasFiles)) : null;
      currentChatId = id;
      const c = chats.find(x => x.id === id);
      if (!c) return;
      canvasFiles = c.canvas ? JSON.parse(JSON.stringify(c.canvas)) : {};
      canvasActiveFile = Object.keys(canvasFiles)[0] || null;
      if (canvasOpen) {
        if (Object.keys(canvasFiles).length > 0) {
          renderCanvasFileTree();
          const htmlFile = Object.keys(canvasFiles).find(f => f.endsWith('.html'));
          if (htmlFile) { selectCanvasFile(htmlFile); updateCanvasPreview(canvasFiles[htmlFile]); switchCanvasTab('preview'); }
          else if (canvasActiveFile) selectCanvasFile(canvasActiveFile);
        } else {
          closeCanvas();
        }
      }
      updateCanvasToggleBtn();
      renderMessages(c.messages); renderChatList();
      if (c.messages.length === 0) showWelcome(); else hideWelcome();
      $('user-input')?.focus();
    }

    function deleteChat(id) {
      chats = chats.filter(c => c.id !== id);
      if (currentChatId === id) currentChatId = null;
      deleteChatFromSupabase(id);
      saveAll(); renderChatList();
      if (chats.length > 0) loadChat(chats[chats.length - 1].id);
      else {
        renderMessages([]); showWelcome();
      }
    }

    function renderChatList(query = "") {
      const list = $('chat-list');
      if (!list) return;
      list.innerHTML = '';
      const filtered = chats.filter(c => c.title.toLowerCase().includes(query) || (c.messages[0]?.content || "").toLowerCase().includes(query));
      const pinned = filtered.filter(c => c.pinned);
      const unpinned = filtered.filter(c => !c.pinned);

      // Pinned section
      if (pinned.length > 0) {
        const pinHeader = document.createElement('div');
        pinHeader.className = 'folder-header';
        pinHeader.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor" class="text-amber-500"><path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"/></svg> Sabitlenmis';
        list.appendChild(pinHeader);
      }

      [...pinned].reverse().forEach(c => list.appendChild(createChatRow(c)));

      // Folders
      const folders = [...new Set(unpinned.filter(c => c.folder).map(c => c.folder))];

      folders.forEach(folder => {
        const fHeader = document.createElement('div');
        fHeader.className = 'folder-header';

        fHeader.innerHTML = `<span></span> ${escapeHtml(folder)
          }

          `;
        list.appendChild(fHeader);
        unpinned.filter(c => c.folder === folder).reverse().forEach(c => list.appendChild(createChatRow(c)));
      });

      // Unfoldered
      const noFolder = unpinned.filter(c => !c.folder);

      if (folders.length > 0 && noFolder.length > 0) {
        const gHeader = document.createElement('div');
        gHeader.className = 'folder-header';
        gHeader.innerHTML = 'Genel';
        list.appendChild(gHeader);
      }

      [...noFolder].reverse().forEach(c => list.appendChild(createChatRow(c)));
    }

    function createChatRow(c) {
      const row = document.createElement('div');

      row.className = `sidebar-item flex justify-between items-center group text-[12px] ${c.id === currentChatId ? 'active text-neutral-200' : 'text-neutral-500'
        }

      `;

      row.innerHTML = `<span class="truncate font-medium flex items-center gap-1" >${c.pinned ? '<span class="pin-icon"></span>' : ''
        }

      ${escapeHtml(c.title)
        }

      </span> <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity" > <button onclick="event.stopPropagation(); togglePin(${c.id})" class="text-neutral-700 hover:text-amber-400 text-[10px] px-1" title="Sabitle" >${c.pinned ? '' : ''
        }

      </button> <button onclick="event.stopPropagation(); promptFolder(${c.id})" class="text-neutral-700 hover:text-blue-400 text-[10px] px-1" title="Klasor" ></button> <button onclick="event.stopPropagation(); deleteChat(${c.id})" class="text-neutral-700 hover:text-red-400 text-xs px-1" >&times; </button> </div>`;
      row.onclick = () => loadChat(c.id);
      return row;
    }

    // ---- Render Messages
    function renderMessages(msgs) {
      const win = $('chat-window');
      if (!win) return;
      win.innerHTML = '';
      if (msgs.length > 0) hideWelcome();

      (msgs || []).forEach((m, idx) => {
        const ts = m.timestamp ? new Date(m.timestamp).toLocaleTimeString('tr-TR', {
          hour: '2-digit', minute: '2-digit'
        }) : '';
        const isBookmarked = bookmarks.includes(currentChatId + '-' + idx);
        const tokenEst = typeof m.content === 'string' ? Math.ceil(m.content.length / 4) : 0;

        if (m.role === 'user') {
          const div = document.createElement('div');
          div.className = 'flex flex-col items-end animate-in msg-wrap';

          div.innerHTML = `<div class="msg-user-bubble px-5 py-3 text-sm text-white max-w-[80%] leading-relaxed" >${escapeHtml(m.content)
            }

          </div> <div class="msg-actions justify-end mt-1" > ${ts ? `< span class="msg-timestamp" > ${ts
              }

            </span > ` : ''
            }

          <span class="token-count" >${tokenEst
            }

          t</span> <button class="msg-action-btn msg-bookmark ${isBookmarked ? 'active' : ''}" onclick="toggleBookmark(${idx})" title="Yer Imi" ><svg viewBox="0 0 24 24" fill="${isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" ><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" /></svg></button> <button class="msg-action-btn" onclick="copyMessage(${idx})" title="Kopyala" ><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ><rect x="9" y="9" width="13" height="13" rx="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></svg>Kopyala</button> <button class="msg-action-btn" onclick="openEditModal(${idx})" title="Duzenle" ><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>Duzenle</button> </div>`;
          win.appendChild(div);
        }

        else if (m.role === 'assistant' && typeof m.content === 'string' && m.content.startsWith('__PPTX_DOWNLOAD__')) {
          const parts = m.content.match(/__PPTX_DOWNLOAD__(blob:.*?)__FILENAME__(.*?)__TITLE__(.*?)__SLIDES__(\d+)/);
          if (parts) {
            const [, blobUrl, fileName, titleText, slidesCount] = parts;
            const card = document.createElement('div');
            card.className = 'flex justify-start animate-in msg-wrap';
            card.innerHTML = `<div style="max-width:420px;background:linear-gradient(135deg,#0f2027,#1a3a4a);border:1px solid rgba(56,189,248,0.25);border-radius:20px;padding:20px 24px;box-shadow:0 8px 32px rgba(0,0,0,0.4)">
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
    <div style="width:44px;height:44px;background:linear-gradient(135deg,#0ea5e9,#38bdf8);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
    </div>
    <div>
      <div style="font-size:15px;font-weight:700;color:#f1f5f9">Sunum hazr! </div>
      <div style="font-size:12px;color:#64748b;margin-top:2px">${slidesCount} slayt  PowerPoint (.pptx)</div>
    </div>
  </div>
  <div style="background:rgba(255,255,255,0.04);border-radius:12px;padding:10px 14px;margin-bottom:14px;border:1px solid rgba(255,255,255,0.06)">
    <div style="font-size:13px;color:#94a3b8;margin-bottom:2px">Dosya ad</div>
    <div style="font-size:14px;font-weight:600;color:#e2e8f0;word-break:break-all">${fileName}</div>
  </div>
  <div style="font-size:13px;color:#94a3b8;margin-bottom:12px">te yaptm! Buradan indirebilirsin </div>
  <a href="${blobUrl}" download="${fileName}" style="display:flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,#0ea5e9,#0284c7);color:white;text-decoration:none;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:700;transition:opacity 0.2s" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    PowerPoint ndir
  </a>
</div>`;
            win.appendChild(card);
          }
        }

        else if (m.role === 'assistant') {
          let contentHtml = m.content || '';
          let thinkingHtml = '';

          // Extract thinking/reasoning seamlessly (handles unclosed tags during streaming too)
          if (typeof contentHtml === 'string' && contentHtml.length > 0) {
            const thinkRegex = /<(?:thinking|thought|think)>([\s\S]*?)(?:<\/(?:thinking|thought|think)>|$)/i;
            const thinkMatch = contentHtml.match(thinkRegex);
            const reasonMatch = contentHtml.match(/<reasoning>([\s\S]*?)(?:<\/reasoning>|$)/i);
            const reflectMatch = contentHtml.match(/<reflection>([\s\S]*?)(?:<\/reflection>|$)/i);

            let thinkText = '';
            let isThinkingStreaming = false;

            if (thinkMatch) {
              thinkText = thinkMatch[1].trim();
              contentHtml = contentHtml.replace(thinkMatch[0], '');
              if (!thinkMatch[0].match(/<\/(?:thinking|thought|think)>/i)) isThinkingStreaming = true;
            }

            if (reasonMatch) {
              thinkText += (thinkText ? '\n\n' : '') + reasonMatch[1].trim();
              contentHtml = contentHtml.replace(reasonMatch[0], '');
              if (!reasonMatch[0].match(/<\/reasoning>/i)) isThinkingStreaming = true;
            }

            if (reflectMatch) {
              thinkText += (thinkText ? '\n\n' : '') + reflectMatch[1].trim();
              contentHtml = contentHtml.replace(reflectMatch[0], '');
              if (!reflectMatch[0].match(/<\/reflection>/i)) isThinkingStreaming = true;
            }

            // Estimate thinking duration from text length
            const thinkDuration = thinkText ? Math.max(1, Math.ceil(thinkText.length / 200)) : 0;

            const thinkDurationLabel = thinkDuration >= 60 ? `${Math.floor(thinkDuration / 60)
              }

            m ${thinkDuration % 60
              }

            s` : `${thinkDuration
            }

            s`;

            const headerText = isThinkingStreaming ? 'Dusunuyor...' : `Dusundu  ${thinkDurationLabel
              }

            `;
            const spinIcon = isThinkingStreaming ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-400 shrink-0 animate-spin" ><circle cx="12" cy="12" r="10" /><path d="M12 6v6l4 2" /></svg>` : `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-400 shrink-0" ><circle cx="12" cy="12" r="10" /><path d="M12 6v6l4 2" /></svg>`;

            if (thinkText) {
              thinkingHtml = ` <details class="thinking-block mb-4"${isThinkingStreaming ? 'open' : ''
                }

              > <summary class="px-4 py-2.5 flex items-center gap-2 text-[12px] font-medium text-neutral-400 hover:text-neutral-300 transition-colors" > ${spinIcon
                }

              <span>${headerText
                }

              </span> <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="ml-auto transition-transform" ><path d="M6 9l6 6 6-6" /></svg> </summary> <div class="px-4 py-3 text-[12px] text-neutral-500 leading-relaxed border-t border-[#222] max-h-60 overflow-y-auto" > ${escapeHtml(thinkText).replace(/\n/g, '<br>')
                }

              </div> </details>`;
            }
          }

          // Markdown (contentHtml must be string at this point)
          if (typeof contentHtml !== 'string') contentHtml = String(contentHtml || '');

          if (typeof marked !== 'undefined') {
            try {
              contentHtml = marked.parse(contentHtml);
            }

            catch (e) {
              contentHtml = escapeHtml(contentHtml).replace(/\n/g, '<br>');
            }
          }

          else {
            contentHtml = escapeHtml(contentHtml).replace(/\n/g, '<br>');
          }

          // Code blocks: replace pre>code with clean code containers
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = contentHtml;

          tempDiv.querySelectorAll('pre code').forEach(codeEl => {
            const lang = (Array.from(codeEl.classList).find(c => c.startsWith('language-')) || '').replace('language-', '') || 'code';
            const code = codeEl.textContent;
            const codeId = 'c-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);

            const container = document.createElement('div');
            container.className = 'code-container mt-2 mb-2 p-3 bg-[#111] border border-[#222] rounded-xl text-neutral-400 text-[12px] flex items-center justify-between';
            container.id = codeId;

            container.innerHTML = ` <div class="flex items-center gap-2" > <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2" ><polyline points="16 18 22 12 16 6" /><polyline points="8 6 2 12 8 18" /></svg> <span><b>${escapeHtml(lang).toUpperCase()
              }

              </b> dosyasina kod yazildi (${(code.split('\\n').length)
              }

                satir). Yan panelden (Canvas) gorebilirsiniz.</span> </div> <textarea class="hidden code-raw" >${escapeHtml(code)
              }

              </textarea>`;

            const pre = codeEl.closest('pre');
            if (pre) pre.replaceWith(container);
          });

          tempDiv.querySelectorAll('table').forEach(table => {
            const wrapper = document.createElement('div');
            wrapper.className = 'table-wrapper my-4 border border-[#222] rounded-xl overflow-hidden bg-[#0a0a0a]';

            const header = document.createElement('div');
            header.className = 'bg-[#111] px-4 py-2 flex items-center justify-between border-b border-[#222]';
            header.innerHTML = ` <div class="flex items-center gap-2 text-xs font-bold text-neutral-400" > <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ><rect x="3" y="3" width="18" height="18" rx="2" /><path d="M3 9h18" /><path d="M3 15h18" /><path d="M9 3v18" /><path d="M15 3v18" /></svg> Veri Tablosu </div> <button onclick="renderTableChart(this)" class="text-[11px] bg-purple-600/20 text-purple-400 hover:bg-purple-600 hover:text-white px-2 py-1 rounded transition-all flex items-center gap-1" > <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ><path d="M3 3v18h18" /><path d="m19 9-5 5-4-4-3 3" /></svg> Grafie evir </button> `;

            const tableContainer = document.createElement('div');
            tableContainer.className = 'overflow-x-auto p-2';
            const clone = table.cloneNode(true);
            tableContainer.appendChild(clone);

            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container hidden p-4 border-t border-[#222] bg-[#111]';
            chartContainer.innerHTML = '<canvas></canvas>';

            wrapper.appendChild(header);
            wrapper.appendChild(tableContainer);
            wrapper.appendChild(chartContainer);
            table.replaceWith(wrapper);
          });

          contentHtml = tempDiv.innerHTML;

          // Images & videos
          const hasImage = / !\[.*?\]\(.*?\)|(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp|svg))/i.test(m.content);
          const hasVideo = / !\[video\]\(.*?\)|(https?:\/\/.*\.(?:mp4|webm|ogg|mov))/i.test(m.content);

          if (hasImage) {
            contentHtml = contentHtml.replace(/ !\[.*?\]\((.*?)\)/g, '<br><img src="$1" class="mt-3 rounded-xl max-h-80 w-auto object-cover border border-[#222]">');
            contentHtml = contentHtml.replace(/(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp|svg)(?:\?.*)?)/gi, '<br><img src="$1" class="mt-3 rounded-xl max-h-80 w-auto object-cover border border-[#222]">');
          }

          if (hasVideo) {
            contentHtml = contentHtml.replace(/ !\[video\]\((.*?)\)/g, '<br><video src="$1" controls class="mt-3 rounded-xl max-h-80 w-full border border-[#222]"></video>');
          }

          const div = document.createElement('div');
          div.className = 'flex flex-col gap-2 w-full animate-in msg-wrap';

          div.innerHTML = ` <div class="flex items-center gap-2.5 px-1" > <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-[9px] font-bold text-white" >AI</div> <span class="text-[11px] text-neutral-500 font-semibold" >${escapeHtml(m.model || 'Assistant')
            }

          </span> </div> <div class="msg-ai-block text-sm leading-relaxed prose max-w-none pl-[34px]" > ${prefs.showThinking ? thinkingHtml : ''
            }

          ${contentHtml
            }

          </div> <div class="msg-actions pl-[34px]" > ${m.branches && m.branches.length > 0 ? ` < div class="flex items-center gap-1 mr-2" > <button class="msg-action-btn px-1" onclick="switchBranch(${idx},-1)" title="Onceki varyant" ><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" ><path d="M15 18l-6-6 6-6" /></svg></button> <span class="text-[9px] text-neutral-500 font-mono" >${m.activeBranch || (m.branches.length + 1)
              }

            /${m.branches.length + 1
              }

            </span> <button class="msg-action-btn px-1" onclick="switchBranch(${idx},1)" title="Sonraki varyant" ><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" ><path d="M9 18l6-6-6-6" /></svg></button> </div > ` : ''
            }

          ${ts ? `< span class="msg-timestamp" > ${ts
              }

            </span > ` : ''
            }

          <span class="token-count" >${tokenEst
            }

          t</span> <button class="msg-action-btn msg-bookmark ${isBookmarked ? 'active' : ''}" onclick="toggleBookmark(${idx})" title="Yer Imi" ><svg viewBox="0 0 24 24" fill="${isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" ><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" /></svg></button> <button class="msg-action-btn" onclick="copyMessage(${idx})" title="Kopyala" ><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ><rect x="9" y="9" width="13" height="13" rx="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></svg>Kopyala</button> <button class="msg-action-btn" onclick="regenerateMessage(${idx})" title="Yeniden Olustur" ><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ><polyline points="23 4 23 10 17 10" /><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" /></svg>Yeniden</button> <button class="msg-action-btn" onclick="speakMessage(${idx})" title="Sesli Oku" ><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /></svg>Sesli</button> <button class="msg-action-btn" onclick="addMsgToNote(${idx})" title="Not Defterine Ekle" ><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>Not</button> </div>`;
          win.appendChild(div);
        }
      });
      win.scrollTop = win.scrollHeight;
      // Attach lightbox to new images
      requestAnimationFrame(() => attachLightbox());
    }

    function copyCode(id) {
      const code = document.querySelector('#' + id + ' .code-raw').value;

      navigator.clipboard.writeText(code).then(() => {
        const btn = document.querySelector('#' + id + ' .code-btn');

        if (btn) {
          const orig = btn.innerHTML; btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg> Kopyalandi'; setTimeout(() => btn.innerHTML = orig, 1500);
        }
      });
    }

    function downloadCode(id, lang) {
      const code = document.querySelector('#' + id + ' .code-raw').value;

      const blob = new Blob([code], {
        type: 'text/plain'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');

      a.href = url; a.download = `code.${lang || 'txt'
        }

    `; a.click();
      URL.revokeObjectURL(url);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => setStatus('Kopyalandi.'));
    }

    // ---- File Handling
    async function handleFileSelect(e) {
      const files = Array.from(e.target.files);

      if (selectedFiles.length + files.length > 20) {
        alert("Max 20 dosya."); return;
      }

      for (const file of files) {
        const fd = {
          id: Date.now() + Math.random(), name: file.name, type: file.type, file, size: (file.size / 1024 / 1024).toFixed(2) + ' MB'
        }

          ;
        if (file.type.startsWith('image/')) fd.preview = await readFileAsDataURL(file);
        else if (file.type.startsWith('video/')) fd.preview = URL.createObjectURL(file);
        else fd.preview = null;
        selectedFiles.push(fd);
        if (ocrMode && file.type.startsWith('image/')) {
          performOCR(file);
        }
      }

      renderFilePreviews();
      e.target.value = '';
    }

    // ---- OCR Mode
    let ocrMode = false;

    function toggleOcr() {
      ocrMode = !ocrMode;
      const btn = $('ocr-btn');
      if (!btn) return;
      if (ocrMode) {
        btn.classList.add('ocr-active');
        btn.title = 'OCR Modu Aktif - Resim yukleyince metin cikarilir';
        setStatus('OCR modu aktif. Resim yukleyince metin otomatik cikarilir.');
      } else {
        btn.classList.remove('ocr-active');
        btn.title = 'OCR Modu - Resimden Metin Cikar';
        setStatus('OCR modu kapandi.');
      }
    }

    async function performOCR(file) {
      const btn = $('ocr-btn');
      try {
        btn && btn.classList.add('ocr-processing');
        setStatus('OCR: Resimden metin cikartiliyor...');
        const result = await Tesseract.recognize(file, 'tur+eng', {
          logger: m => {
            if (m.status === 'recognizing text') {
              const pct = Math.round((m.progress || 0) * 100);
              setStatus(`OCR isleniyor... %${pct}`);
            }
          }
        });
        const text = result.data.text.trim();
        if (!text) { setStatus('OCR: Metin bulunamadi.'); return; }
        const inp = $('user-input');
        const prefix = inp.value ? inp.value + '\n\n' : '';
        inp.value = prefix + '[Resimden cikarilan metin]:\n' + text;
        inp.dispatchEvent(new Event('input'));
        setStatus(`OCR tamamlandi. ${text.length} karakter cikartildi.`);
      } catch (err) {
        setStatus('OCR hatasi: ' + (err.message || err));
      } finally {
        btn && btn.classList.remove('ocr-processing');
      }
    }

    let liveScreenStream = null;
    let liveScreenTrack = null;

    async function handleScreenCapture() {
      if (liveScreenStream) { stopLiveScreen(); return; }
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: 'always' }, audio: false });
        liveScreenStream = stream;
        liveScreenTrack = stream.getVideoTracks()[0];
        liveScreenTrack.onended = () => stopLiveScreen();
        updateScreenBtn(true);
        showLiveScreenPreview(stream);
        setStatus('Ekran paylasimi aktif. Mesaj yazinca ekran otomatik eklenir.');
      } catch (err) {
        console.warn('Ekran yakalama basarisiz:', err);
      }
    }

    function stopLiveScreen() {
      if (liveScreenTrack) liveScreenTrack.stop();
      if (liveScreenStream) liveScreenStream.getTracks().forEach(t => t.stop());
      liveScreenStream = null;
      liveScreenTrack = null;
      updateScreenBtn(false);
      hideLiveScreenPreview();
      setStatus('Ekran paylasimi durduruldu.');
    }

    function updateScreenBtn(active) {
      const btn = $('screen-capture-btn');
      if (!btn) return;
      if (active) {
        btn.classList.add('text-emerald-400', 'bg-emerald-500/10');
        btn.classList.remove('text-neutral-500');
        btn.title = 'Ekran Paylasimini Durdur';
      } else {
        btn.classList.remove('text-emerald-400', 'bg-emerald-500/10');
        btn.classList.add('text-neutral-500');
        btn.title = 'Canli Ekran Paylasimi Baslat';
      }
    }

    function showLiveScreenPreview(stream) {
      const preview = $('live-screen-preview');
      if (!preview) return;
      const video = $('live-screen-video');
      if (video) video.srcObject = stream;
      preview.classList.remove('hidden');
    }

    function hideLiveScreenPreview() {
      const preview = $('live-screen-preview');
      if (preview) preview.classList.add('hidden');
      const video = $('live-screen-video');
      if (video) video.srcObject = null;
    }

    async function captureLiveScreenFrame() {
      if (!liveScreenStream || !liveScreenTrack || liveScreenTrack.readyState !== 'live') return null;
      try {
        const imageCapture = new ImageCapture(liveScreenTrack);
        const bitmap = await imageCapture.grabFrame();
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        const bCtx = canvas.getContext('bitmaprenderer');
        if (bCtx) { bCtx.transferFromImageBitmap(bitmap); }
        else { canvas.getContext('2d').drawImage(bitmap, 0, 0); }
        return canvas.toDataURL('image/jpeg', 0.82);
      } catch (e) { return null; }
    }

    function readFileAsDataURL(file) {
      return new Promise(r => {
        const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(file);
      });
    }

    async function extractPdfText(file) {
      try {
        const ab = await file.arrayBuffer();

        const pdf = await pdfjsLib.getDocument({
          data: ab
        }).promise;
        let t = "";

        for (let i = 1; i <= pdf.numPages; i++) {
          const p = await pdf.getPage(i); const tc = await p.getTextContent(); t += tc.items.map(x => x.str).join(" ") + "\n";
        }

        return t;
      }

      catch (e) {
        return "[PDF metni cikarilamadi]";
      }
    }

    function miniRAG(docText, query, maxTokens = 8000) {
      if (docText.length < maxTokens * 4) return docText;
      const chunks = docText.split(/\n\s*\n/).filter(c => c.trim().length > 10);
      const keywords = query.toLowerCase().split(/\s+/).filter(k => k.length > 3);
      if (keywords.length === 0) return docText.substring(0, maxTokens * 4);

      const scored = chunks.map(chunk => {
        let score = 0; const cLow = chunk.toLowerCase();

        keywords.forEach(kw => {
          if (cLow.includes(kw)) score++;
        });

        return {
          chunk, score
        }

          ;
      });
      scored.sort((a, b) => b.score - a.score);
      let out = "";

      for (const s of scored) {
        if (out.length + s.chunk.length > maxTokens * 4) break;

        if (s.score > 0 || out.length < (maxTokens * 2)) {
          out += s.chunk + "\n\n";
        }
      }

      return out.trim() || docText.substring(0, maxTokens * 4);
    }

    function renderFilePreviews() {
      const c = $('file-preview-container');
      if (!c) return;

      if (selectedFiles.length === 0) {
        c.classList.add('hidden'); return;
      }

      c.classList.remove('hidden');

      c.innerHTML = selectedFiles.map(f => {
        let preview = '';
        if (f.type.startsWith('image/') && f.preview) preview = `<img src="${f.preview}" class="w-full h-full object-cover rounded-lg" />`;
        else if (f.type.startsWith('video/') && f.preview) preview = `<video src="${f.preview}" class="w-full h-full object-cover rounded-lg" ></video>`;

        else preview = `<span class="text-xs text-neutral-500 truncate px-1" >${escapeHtml(f.name)
          }

          </span>`;

        return `<div class="relative group w-16 h-16 rounded-lg overflow-hidden border border-[#222] bg-[#0a0a0a] flex items-center justify-center" > ${preview
          }

          <button onclick="removeFile(${f.id})" class="absolute -top-1 -right-1 bg-red-500 text-white w-4 h-4 rounded-full text-[9px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity" >&times; </button> </div>`;
      }).join('');
    }

    function removeFile(id) {
      const f = selectedFiles.find(x => x.id === id);
      if (f && f.type.startsWith('video/') && f.preview) URL.revokeObjectURL(f.preview);
      selectedFiles = selectedFiles.filter(x => x.id !== id);
      renderFilePreviews();
    }

    // ---- Prompt Injection
    function injectPrompt(type) {
      const input = $('user-input');
      const modA = $('model-a')?.value;
      const prov = providerSettings.active || 'puter';
      let prefix = "";

      if (type === 'web-search') {
        prefix = "Bu web sitesini oku ve analiz et: "; setStatus('URL girin.');
      }

      else if (type === 'deep-research') {
        prefix = "Derin arastirma modu: "; setStatus('Arastirma konusu girin.');
      }

      else if (type === 'image-gen') {
        if (prov === 'puter' && !IMAGE_MODELS.includes(modA)) {
          alert('Lutfen bir gorsel modeli secin.'); return;
        }

        prefix = "Resim uret: ";
      }

      else if (type === 'video-gen') {
        if (!VIDEO_MODELS.includes(modA)) {
          alert('Lutfen bir video modeli secin.'); return;
        }

        prefix = "Video uret: ";
      }

      input.value = input.value ? prefix + input.value : prefix;
      input.focus();
      input.style.height = 'auto';
      input.style.height = input.scrollHeight + 'px';
    }

    // ---- Web Content Fetching
    function withTimeout(promise, ms, label) {
      let t;
      const timeout = new Promise((_, rej) => t = setTimeout(() => rej(new Error(label + ' timeout')), ms));
      return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
    }

    // Smart fetch: Directly uses puter.net.fetch for remote APIs to bypass CORS
    async function smartFetch(url, options, timeoutMs) {
      const isLocal = url.includes('localhost') || url.includes('127.0.0.1') || url.includes('0.0.0.0');

      if (isLocal) {
        // Local: only window.fetch works (puter proxy can't reach user's localhost)
        return await withTimeout(window.fetch(url, options), timeoutMs || 15000, 'local-fetch');
      }

      // Remote: use puter.net.fetch directly for CORS-free requests
      try {
        const resp = await withTimeout(puter.net.fetch(url, options), timeoutMs || 300000, 'puter-fetch');
        return resp;
      }

      catch (puterErr) {
        throw new Error(`Baglanti Hatasi (Puter CORS-Free Fetch): ${puterErr.message
          }

          `);
      }
    }

    async function fetchWebContent(url) {
      try {
        let cleanUrl = url.trim();
        if (!cleanUrl.startsWith('http://') && !cleanUrl.startsWith('https://')) cleanUrl = 'https://' + cleanUrl;

        const resp = await withTimeout(puter.net.fetch(cleanUrl, {
          method: 'GET', headers: {
            'User-Agent': 'Mozilla/5.0', 'Accept': 'text/html,application/xhtml+xml,*/*'
          }
        }), 30000, 'web-fetch');

        if (!resp.ok) throw new Error(`HTTP ${resp.status
          }

        `);
        const ct = resp.headers.get('content-type') || '';

        if (ct.includes('application/json')) {
          const j = await resp.json(); return {
            success: true, type: 'json', content: JSON.stringify(j, null, 2), url: cleanUrl
          }

            ;
        }

        const html = await resp.text();

        return {
          success: true, type: 'html', content: extractTextFromHtml(html), url: cleanUrl
        }

          ;
      }

      catch (e) {
        return {
          success: false, error: e.message, url
        }

          ;
      }
    }

    function extractTextFromHtml(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      ['script', 'style', 'nav', 'footer', 'aside', 'header', 'noscript', 'iframe', 'svg', 'form', 'button'].forEach(s => doc.querySelectorAll(s).forEach(el => el.remove()));
      const title = doc.querySelector('title')?.textContent?.trim() || '';
      const metaDesc = doc.querySelector('meta[name="description"]')?.getAttribute('content') || '';
      const main = doc.querySelector('main, article, .content, .post, #content, #main') || doc.body;
      let parts = [];

      if (title) parts.push(`# ${title
        }

        \n`);

      if (metaDesc) parts.push(`> ${metaDesc
        }

        \n`);

      main.querySelectorAll('h1,h2,h3,h4,h5,h6').forEach(h => {
        const t = h.textContent.trim(); if (t) parts.push(`${'#'.repeat(parseInt(h.tagName[1]))
          }

            ${t
          }

            `);
      });

      main.querySelectorAll('p').forEach(p => {
        const t = p.textContent.trim(); if (t && t.length > 20) parts.push(t);
      });

      main.querySelectorAll('li').forEach(li => {
        const t = li.textContent.trim(); if (t && t.length > 10) parts.push(`- ${t
          }

            `);
      });
      let result = parts.join('\n\n');
      if (result.length > 15000) result = result.substring(0, 15000) + '\n\n[... kisaltildi ...]';

      return result.replace(/\n{3,}/g, '\n\n').trim() || doc.body?.textContent?.trim()?.substring(0, 10000) || '[Icerik cikarilamadi]';
    }

    function extractUrlsFromText(text) {
      const matches = text.match(/(?:https?:\/\/|www\.)[^\s<>"']+/gi) || [];
      return [...new Set(matches.map(u => u.replace(/[., ; : !?)]+$/, '')))];
    }

    async function processUrlsInMessage(text) {
      const urls = extractUrlsFromText(text);

      if (urls.length === 0) return {
        originalText: text, webContents: [], hasUrls: false
      }

        ;

      setStatus(`${urls.length
        }

        site aliniyor...`);
      const wc = [];
      for (const url of urls.slice(0, 3)) wc.push(await fetchWebContent(url));

      return {
        originalText: text, webContents: wc, hasUrls: true
      }

        ;
    }

    // ---- API Calls
    async function callPuterStream(modelId, history, onToken) {
      try {
        const streamOpts = {
          model: modelId, stream: true
        }

          ;

        // Enable thinking/reasoning for supported models if user enabled it
        if (prefs.showThinking) {
          const thinkingModels = /claude-3|claude-4|deepseek|qwq|o1|o3|o4|gemini|r1/i;

          if (thinkingModels.test(modelId)) {
            try {
              streamOpts.thinking = true;
            }

            catch (e) { }
          }
        }

        const it = await puter.ai.chat(history, streamOpts);
        let inThinkingStructured = false;

        for await (const part of it) {
          if (part?.type === 'thinking' || part?.thinking) {
            let chunk = String(part?.thinking || part?.text || part?.content || '');

            if (!inThinkingStructured) {
              chunk = '<thinking>\n' + chunk;
              inThinkingStructured = true;
            }

            if (onToken) onToken(chunk);
            continue;
          }

          if (inThinkingStructured) {
            if (onToken) onToken('\n</thinking>\n');
            inThinkingStructured = false;
          }

          let chunk = (part?.text ?? part?.message?.content ?? part?.content ?? '');
          if (Array.isArray(chunk)) chunk = chunk.map(c => c.text || '').join('');
          chunk = String(chunk);
          if (onToken) onToken(chunk);
        }

        if (inThinkingStructured) {
          if (onToken) onToken('\n</thinking>\n');
        }
      }

      catch (e) {
        if (e.message && e.message.includes('multimodal')) {
          if (onToken) onToken("\n[Bu model dosya analizi ile stream desteklemiyor.]");
        }

        else {
          if (onToken) onToken("\n[Baglanti hatasi: " + e.message + "]");
        }
      }
    }

    async function callPuterOnce(modelId, history) {
      const callOpts = {
        model: modelId
      }

        ;

      // Enable thinking for supported models if user enabled it
      if (prefs.showThinking) {
        const thinkingModels = /claude-3|claude-4|deepseek|qwq|o1|o3|o4|gemini.*think|r1/i;

        if (thinkingModels.test(modelId)) {
          try {
            callOpts.thinking = true;
          }

          catch (e) { }
        }
      }

      const r = await withTimeout(puter.ai.chat(history, callOpts), 300000, 'puter.ai.chat');
      if (typeof r === 'string') return r;

      // Extract thinking from structured response
      let thinkingText = '';
      let responseText = '';

      // Handle thinking content blocks (Anthropic/Claude style)
      if (r?.message?.content && Array.isArray(r.message.content)) {
        for (const block of r.message.content) {
          if (block.type === 'thinking' && block.thinking) thinkingText += block.thinking;
          else if (block.type === 'text' && block.text) responseText += block.text;
        }

        if (thinkingText && responseText) return `<thinking>${thinkingText
          }

        </thinking>\n${responseText
          }

        `;
        if (responseText) return responseText;
      }

      // Handle thinking field directly
      if (r?.thinking || r?.message?.thinking) {
        thinkingText = r?.thinking || r?.message?.thinking;
      }

      // Handle image responses from puter
      const rMsg = r?.message || r;

      if (rMsg?.images && rMsg.images.length > 0) {
        const parts = [];
        if (rMsg.content) parts.push(typeof rMsg.content === 'string' ? rMsg.content : rMsg.content.map(c => c.text || '').join(''));

        rMsg.images.forEach(img => {
          const u = img?.image_url?.url || img?.url || '';

          if (u) parts.push(` ![Gorsel](${u
            })`);
        });

        if (parts.length > 0) {
          const content = parts.join('\n\n');

          return thinkingText ? `<thinking>${thinkingText
            }

          </thinking>\n${content
            }

          ` : content;
        }
      }

      let content = '';
      if (r?.message?.content) content = typeof r.message.content === 'string' ? r.message.content : r.message.content.map(c => c.text || '').join('');
      else if (r?.content) content = typeof r.content === 'string' ? r.content : r.content.map(c => c.text || '').join('');
      else if (r?.choices?.[0]?.message?.content) content = r.choices[0].message.content;

      else {
        // Check choices for images too
        const choiceMsg = r?.choices?.[0]?.message;

        if (choiceMsg?.images && choiceMsg.images.length > 0) {
          const parts = [];
          if (choiceMsg.content) parts.push(choiceMsg.content);

          choiceMsg.images.forEach(img => {
            const u = img?.image_url?.url || img?.url || '';

            if (u) parts.push(` ![Gorsel](${u
              })`);
          });
          if (parts.length > 0) content = parts.join('\n\n');
        }

        // Check choices for thinking
        if (r?.choices?.[0]?.message?.thinking) thinkingText = r.choices[0].message.thinking;
        if (!content) content = JSON.stringify(r);
      }

      return thinkingText ? `<thinking>${thinkingText
        }

      </thinking>\n${content
        }

      ` : content;
    }

    async function callCustomRouter(modelId, history) {
      const {
        token, baseUrl
      }

        = providerSettings.custom;
      if (!baseUrl || !modelId) return 'Custom Provider ayarlari eksik.';
      let url = baseUrl.trim();
      if (!url.toLowerCase().startsWith('http')) url = 'http://' + url;
      if (!url.toLowerCase().includes('/chat/completions')) url = url.endsWith('/') ? url + 'chat/completions' : url + '/chat/completions';

      const cleanHistory = history.map(m => ({
        role: m.role, content: Array.isArray(m.content) ? m.content.map(c => c.text || '').join('\n').trim() : m.content
      }));

      try {
        const resp = await smartFetch(url, {
          method: 'POST', headers: {
            'Authorization': `Bearer ${token
              }

          `, 'Content-Type': 'application/json'
          }

          , body: JSON.stringify({
            model: modelId, messages: cleanHistory, stream: false
          })
        }

          , 300000);

        if (!resp.ok) {
          const t = await resp.text(); throw new Error(`HTTP ${resp.status
            }

        : ${t || resp.statusText
            }

        `);
        }

        const data = await resp.json();
        const msg = data?.choices?.[0]?.message;

        // Extract thinking/reasoning from response
        let thinkingText = '';
        if (msg?.reasoning_content) thinkingText = msg.reasoning_content;
        else if (msg?.thinking) thinkingText = msg.thinking;
        else if (data?.choices?.[0]?.reasoning_content) thinkingText = data.choices[0].reasoning_content;

        // Handle image responses (e.g. gemini-3-pro-image, gpt-image models)
        if (msg?.images && msg.images.length > 0) {
          const parts = [];
          if (msg.content) parts.push(msg.content);

          msg.images.forEach(img => {
            const imgUrl = img?.image_url?.url || img?.url || '';

            if (imgUrl) parts.push(` ![Gorsel](${imgUrl
              })`);
          });
          const content = parts.join('\n\n') || JSON.stringify(data);

          return thinkingText ? `<thinking>${thinkingText
            }

      </thinking>\n${content
            }

      ` : content;
        }

        const content = msg?.content || JSON.stringify(data);

        return thinkingText ? `<thinking>${thinkingText
          }

    </thinking>\n${content
          }

    ` : content;
      }

      catch (e) {
        throw new Error(`Custom Provider Hatasi: ${e.message
          }

        `);
      }
    }

    async function fetchCustomModels() {
      const {
        token, baseUrl
      }

        = providerSettings.custom;
      if (!baseUrl) return;
      let url = baseUrl.trim();
      if (!url.toLowerCase().startsWith('http')) url = 'http://' + url;
      url = url.replace(/\/chat\/completions\/?$/i, '');
      url = url.endsWith('/') ? url + 'models' : url + '/models';

      try {
        const resp = await smartFetch(url, {
          method: 'GET', headers: {
            'Authorization': `Bearer ${token
              }

            `, 'Content-Type': 'application/json'
          }
        }

          , 10000);

        if (!resp.ok) throw new Error(`HTTP ${resp.status
          }

        `);
        const data = await resp.json();

        if (data && Array.isArray(data.data)) customModels = data.data.map(m => ({
          id: m.id, name: m.id
        }));

        else if (data && Array.isArray(data.models)) customModels = data.models.map(m => ({
          id: m.id || m.name, name: m.id || m.name
        }));

        else if (Array.isArray(data)) customModels = data.map(m => ({
          id: m.id || m.name || m, name: m.id || m.name || m
        }));
      }

      catch (e) {
        console.error("[Custom Models]", e); setStatus('Model listesi alinamadi: ' + (e.message || '').substring(0, 40));
      }
    }

    async function manualFetchCustomModels(btn) {
      if (btn) {
        btn.textContent = '...'; btn.disabled = true;
      }

      providerSettings.custom.baseUrl = $('custom-url').value.trim();
      providerSettings.custom.token = $('custom-token').value.trim();
      await fetchCustomModels();
      const list = $('custom-models-list');

      if (list) list.innerHTML = customModels.map(m => `<option value="${m.id}" >${m.id
        }

        </option>`).join('');

      if (btn) {
        btn.textContent = customModels.length > 0 ? 'OK' : 'Hata';
        if (customModels.length > 0 && !$('custom-model-id').value) $('custom-model-id').value = customModels[0].id;

        setTimeout(() => {
          btn.textContent = 'Yenile'; btn.disabled = false;
        }

          , 1500);
      }
    }

    async function callAnthropicRouter(modelId, history) {
      const {
        token, baseUrl
      }

        = providerSettings.anthropic;
      if (!baseUrl || !modelId) return 'Anthropic ayarlari eksik.';
      let url = baseUrl.trim();
      if (!url.toLowerCase().startsWith('http')) url = 'http://' + url;
      if (!url.toLowerCase().includes('/v1/messages')) url = url.endsWith('/') ? url + 'v1/messages' : url + '/v1/messages';

      const cleanHistory = history.filter(m => m.role !== 'system').map(m => ({
        role: m.role, content: Array.isArray(m.content) ? m.content.map(c => c.text || '').join('\n').trim() : String(m.content)
      }));
      const sysMsg = history.find(m => m.role === 'system');
      const sysPrompt = sysMsg ? (Array.isArray(sysMsg.content) ? sysMsg.content.map(c => c.text || '').join('\n') : sysMsg.content) : buildSystemPrompt();

      const headers = {
        'Content-Type': 'application/json', 'anthropic-version': '2023-06-01'
      }

        ;
      if (token) headers['x-api-key'] = token;

      // Build request body - enable thinking for extended thinking models
      const reqBody = {
        model: modelId, messages: cleanHistory, system: sysPrompt, max_tokens: prefs.maxTokens || 4096, stream: false
      }

        ;

      // Extended thinking for Claude 3.5/4 models that support it
      if (prefs.showThinking) {
        const thinkingCapable = /claude-3-5-sonnet|claude-3\.5|claude-3-opus|claude-4|claude-sonnet-4|claude-opus-4/i.test(modelId);

        if (thinkingCapable) {
          try {
            reqBody.thinking = {
              type: 'enabled', budget_tokens: Math.min(prefs.maxTokens || 4096, 8192)
            }

              ;
          }

          catch (e) { }
        }
      }

      try {
        const resp = await smartFetch(url, {
          method: 'POST', headers, body: JSON.stringify(reqBody)
        }

          , 300000);

        if (!resp.ok) {
          const t = await resp.text(); throw new Error(`HTTP ${resp.status
            }

        : ${t || resp.statusText
            }

        `);
        }

        const data = await resp.json();

        // Parse thinking + text content blocks
        let thinkingText = '';
        let responseText = '';

        if (data.content && Array.isArray(data.content)) {
          for (const block of data.content) {
            if (block.type === 'thinking' && block.thinking) thinkingText += block.thinking;
            else if (block.type === 'text' && block.text) responseText += block.text;
          }

          if (thinkingText && responseText) return `<thinking>${thinkingText
            }

      </thinking>\n${responseText
            }

      `;
          if (responseText) return responseText;
          return data.content.map(c => c.text || '').join('\n');
        }

        return JSON.stringify(data);
      }

      catch (e) {
        throw new Error(`Anthropic Hatasi: ${e.message
          }

        `);
      }
    }

    async function checkAnthropicHealth(btn) {
      const base = $('anthropic-url').value.trim(); if (!base) return;
      const orig = btn.textContent; btn.textContent = '...';

      try {
        let root = base.split('/v1/')[0];
        const url = root.endsWith('/') ? root + 'health' : root + '/health';
        const isLocal = url.includes('localhost') || url.includes('127.0.0.1');

        const resp = await smartFetch(url, {}

          , 10000);

        if (resp.ok) {
          const d = await resp.json(); alert("OK\n" + JSON.stringify(d, null, 2));
        }

        else alert("Hata " + resp.status);
      }

      catch (e) {
        alert("Erisim Hatasi: " + e.message);
      }

      finally {
        btn.textContent = orig;
      }
    }

    async function checkAnthropicLimits(btn) {
      const base = $('anthropic-url').value.trim(); if (!base) return;
      const orig = btn.textContent; btn.textContent = '...';

      try {
        let root = base.split('/v1/')[0];
        const url = root.endsWith('/') ? root + 'account-limits' : root + '/account-limits';

        const resp = await smartFetch(url, {}

          , 10000);

        if (resp.ok) {
          const d = await resp.json(); alert("Limitler:\n" + JSON.stringify(d, null, 2));
        }

        else alert("Hata " + resp.status);
      }

      catch (e) {
        alert("Hata: " + e.message);
      }

      finally {
        btn.textContent = orig;
      }
    }

    async function manualFetchAnthropicModels(btn) {
      const base = $('anthropic-url').value.trim(); if (!base) return;
      const orig = btn.textContent; btn.textContent = '...';

      try {
        let root = base.split('/v1/')[0];
        const url = root.endsWith('/') ? root + 'v1/models' : root + '/v1/models';

        const resp = await smartFetch(url, {}

          , 10000);

        if (resp.ok) {
          const data = await resp.json();
          const models = data.data || data.models || [];

          $('anthropic-models-list').innerHTML = models.map(m => `<option value="${m.id || m.name || m}" >${m.id || m.name || m
            }

          </option>`).join('');

          alert(`${models.length
            }

          model yuklendi.`);
        }

        else alert("Hata " + resp.status);
      }

      catch (e) {
        alert("Hata: " + e.message);
      }

      finally {
        btn.textContent = orig;
      }
    }

    async function refreshTokenAnthropic(btn) {
      const base = $('anthropic-url').value.trim(); if (!base) return;
      const orig = btn.textContent; btn.textContent = '...';

      try {
        let root = base.split('/v1/')[0];
        const url = root.endsWith('/') ? root + 'refresh-token' : root + '/refresh-token';

        const resp = await smartFetch(url, {
          method: 'POST'
        }

          , 10000);
        if (resp.ok) alert("Token yenilendi."); else alert("Basarisiz: " + resp.status);
      }

      catch (e) {
        alert("Hata: " + e.message);
      }

      finally {
        btn.textContent = orig;
      }
    }

    function buildHistoryForModel(chat) {
      const sys = buildSystemPrompt() || "Sen yardimci bir yapay zeka asistanisin.";

      const history = [{
        role: 'system', content: sys
      }

      ];

      (chat.messages || []).forEach(m => {
        if (m.role === 'user' || m.role === 'assistant') {
          const has = Array.isArray(m.content) ? m.content.length > 0 : (m.content && String(m.content).trim() !== '');

          if (has) history.push({
            role: m.role, content: m.content
          });
        }
      });
      return history;
    }

    // ---- Main Send
    let lastSendTime = 0;
    const SEND_COOLDOWN = 1000;

    async function handleSend() {
      const now = Date.now();

      if (now - lastSendTime < SEND_COOLDOWN) {
        setStatus('Bekleyin...'); return;
      }

      lastSendTime = now;

      const input = $('user-input'), sendBtn = $('send-btn'), stopBtn = $('stop-btn');
      const text = input ? input.value.trim() : '';
      if (!text) return;

      if (!puterReady && providerSettings.active === 'puter') {
        setStatus('Puter yukleniyor, lutfen bekleyin...');

        // Try waiting up to 5 seconds
        for (let i = 0; i < 10; i++) {
          await new Promise(r => setTimeout(r, 500));
          if (puterReady) break;
        }

        if (!puterReady) {
          puterReady = true; setStatus('Fallback ile devam ediliyor...');
        }
      }

      // Compare mode: send to both panels
      if (compareActive) {
        input.value = '';
        input.style.height = 'auto';
        await handleCompareSend(text);
        return;
      }

      if (!currentChatId) createNewChat();
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;
      if (chat.messages.length === 0) chat.title = text.slice(0, 30);

      chat.messages.push({
        role: 'user', content: text, timestamp: Date.now()
      });
      saveAll();
      input.value = '';
      hideWelcome();
      renderMessages(chat.messages);

      // Show stop button, hide send
      isGenerating = true;
      currentAbortController = new AbortController();
      sendBtn.style.display = 'none';
      stopBtn.style.display = 'flex';

      const win = $('chat-window');
      const loader = document.createElement('div');
      loader.className = "flex flex-col gap-2 w-full animate-in";
      loader.id = "thinking-loader";
      let thinkingStartTime = Date.now();
      loader.innerHTML = ` <div class="flex items-center gap-2.5 px-1" > <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-[9px] font-bold text-white" >AI</div> <span class="text-[11px] text-neutral-500 font-semibold" >Yanit olusturuluyor...</span> </div> <div id="thinking-dots" class="pl-[34px] flex gap-1.5 py-2" > <div class="w-1.5 h-1.5 bg-blue-500 rounded-full dot-pulse" ></div> <div class="w-1.5 h-1.5 bg-blue-500 rounded-full dot-pulse" ></div> <div class="w-1.5 h-1.5 bg-blue-500 rounded-full dot-pulse" ></div> </div>`;
      win.appendChild(loader);
      win.scrollTop = win.scrollHeight;
      sendBtn.disabled = true;

      const modA = $('model-a')?.value || 'gpt-4o-mini';
      prefs.modelA = modA;
      saveAll();

      try {
        let history = buildHistoryForModel(chat);
        const activeProv = providerSettings.active || 'puter';

        // Web content
        const urls = extractUrlsFromText(text);
        let enhancedText = text;

        if (urls.length > 0) {
          setStatus('Web icerigi aliniyor...');
          const urlResult = await processUrlsInMessage(text);

          if (urlResult.hasUrls && urlResult.webContents.length > 0) {
            let webCtx = '\n\n--- WEB ICERIGI ---\n';

            urlResult.webContents.forEach(wc => {
              if (wc.success) webCtx += `\nKaynak: ${wc.url
                }

              \n${wc.content
                }

              \n---\n`;

              else webCtx += `\n${wc.url
                }

              - Erisilemedi: ${wc.error
                }

              \n`;
            });
            enhancedText = text + webCtx;

            for (let i = history.length - 1; i >= 0; i--) {
              if (history[i].role === 'user') {
                if (typeof history[i].content === 'string') history[i].content = enhancedText;

                else if (Array.isArray(history[i].content)) {
                  const tp = history[i].content.find(c => c.type === 'text'); if (tp) tp.text = enhancedText;
                }

                break;
              }
            }
          }
        }

        // Live screen auto-capture
        if (liveScreenStream) {
          const frameUrl = await captureLiveScreenFrame();
          if (frameUrl) {
            selectedFiles.unshift({ id: Date.now() + Math.random(), name: 'ekran-canli.jpg', type: 'image/jpeg', preview: frameUrl, _liveCapture: true });
          }
        }

        // Files
        if (selectedFiles.length > 0) {
          setStatus('Dosyalar isleniyor...');

          let userContent = [{
            type: 'text', text: enhancedText
          }

          ];

          for (const f of selectedFiles) {
            if (f.type.startsWith('image/')) userContent.push({
              type: 'image_url', image_url: {
                url: f.preview
              }
            });

            else if (f.type === 'application/pdf') {
              const pt = await extractPdfText(f.file); const ragText = miniRAG(pt, text, 8000); userContent[0].text += `\n\n[PDF: ${f.name
                }

          ]\n${ragText
                }

          `;
            }

            else if (f.type.startsWith('video/')) userContent[0].text += `\n\n[Video: ${f.name
              }

        ]`;
          }

          for (let i = history.length - 1; i >= 0; i--) {
            if (history[i].role === 'user') {
              history[i].content = userContent; break;
            }
          }

          chat.messages[chat.messages.length - 1].content = text + ` (${selectedFiles.length
            }

        dosya)`;
        }

        selectedFiles.forEach(f => {
          if (f.type.startsWith('video/') && f.preview) URL.revokeObjectURL(f.preview);
        });
        selectedFiles = [];
        renderFilePreviews();

        // Deep Research mode
        if (text.startsWith("Derin arastirma modu: ")) {
          const query = text.replace("Derin arastirma modu: ", "").trim();
          if (loader?.parentNode) loader.parentNode.removeChild(loader);
          sendBtn.disabled = false;
          await deepResearch(query);
          return;
        }

        // Agent mode
        if (text.startsWith("Ajan modu: ")) {
          const query = text.replace("Ajan modu: ", "").trim();
          if (!query) return;
          if (loader?.parentNode) loader.parentNode.removeChild(loader);
          sendBtn.disabled = false;
          isGenerating = false;
          sendBtn.style.display = 'flex';
          stopBtn.style.display = 'none';
          await runAgent(query);
          return;
        }

        setStatus('Yanit olusturuluyor...');

        const assistantMsg = {
          role: 'assistant', model: modA, content: '', timestamp: Date.now()
        }

          ;
        chat.messages.push(assistantMsg);

        // Detect if user is asking for code -> show canvas building
        const _skipCanvasThisTime = _noCanvas; _noCanvas = false;
        const isCodeRequest = !_skipCanvasThisTime && /\b(kod|code|uygulama|app|html|css|javascript|react|game|oyun|hesap|calculator|website|site|sayfa|program|yaz|olustur|create|build|make|python|py|c\+\+|cpp|java|rust|golang|script|fonksiyon|function|class|algoritma|algorithm)\b/i.test(text);
        if (isCodeRequest) showCanvasBuilding();

        // Image gen
        if (text.startsWith("Resim uret: ")) {
          const imgPrompt = text.replace("Resim uret: ", "").trim();

          if (activeProv === 'puter') {
            if (!IMAGE_MODELS.includes(modA)) throw new Error('Gorsel modeli secin.');
            setStatus('Gorsel uretiliyor...');

            try {
              const img = await puter.ai.txt2img(imgPrompt, {
                model: modA
              });
              const imgSrc = img?.src || img?.url || (typeof img === 'string' ? img : null);
              if (!imgSrc) throw new Error('Gorsel verisi alinamadi.');

              assistantMsg.content = ` ![Gorsel](${imgSrc
                })`;
            }

            catch (imgErr) {

              // Fallback: try via puter.ai.chat for image-capable models
              try {
                const r = await withTimeout(puter.ai.chat([{
                  role: 'user', content: imgPrompt
                }

                ], {
                  model: modA
                }), 60000, 'puter-image-chat');
                const rMsg = r?.message || r;

                if (rMsg?.images && rMsg.images.length > 0) {
                  const parts = [];
                  if (rMsg.content) parts.push(rMsg.content);

                  rMsg.images.forEach(im => {
                    const u = im?.image_url?.url || im?.url || '';

                    if (u) parts.push(` ![Gorsel](${u
                      })`);
                  });
                  assistantMsg.content = parts.join('\n\n');
                }

                else if (typeof rMsg?.content === 'string' && rMsg.content) {
                  assistantMsg.content = rMsg.content;
                }

                else {
                  throw imgErr;
                }
              }

              catch (e2) {
                throw new Error(imgErr.message || 'Gorsel uretilemedi.');
              }
            }

            closeCanvas();
            saveAll(); renderMessages(chat.messages); return;
          }

          else if (activeProv === 'custom') {
            setStatus('Gorsel uretiliyor...');
            assistantMsg.content = await callCustomRouter(modA, history) || 'Gorsel uretilemedi.';
            closeCanvas();
            saveAll(); renderMessages(chat.messages); return;
          }
        }

        // Video gen
        if (text.startsWith("Video uret: ")) {
          const vidPrompt = text.replace("Video uret: ", "").trim();

          if (activeProv === 'puter') {
            if (!VIDEO_MODELS.includes(modA)) throw new Error('Video modeli secin.');
            setStatus('Video uretiliyor...');

            try {
              const vid = await puter.ai.txt2vid(vidPrompt, {
                model: modA
              });
              const vidSrc = vid?.src || vid?.url || (typeof vid === 'string' ? vid : null);
              if (!vidSrc) throw new Error('Video verisi alinamadi.');

              assistantMsg.content = ` ![video](${vidSrc
                })`;
            }

            catch (vidErr) {
              try {
                const r = await withTimeout(puter.ai.chat([{
                  role: 'user', content: vidPrompt
                }

                ], {
                  model: modA
                }), 120000, 'puter-video-chat');
                const rMsg = r?.message || r;

                if (rMsg?.images && rMsg.images.length > 0) {
                  const parts = [];
                  if (rMsg.content) parts.push(rMsg.content);

                  rMsg.images.forEach(im => {
                    const u = im?.image_url?.url || im?.url || '';

                    if (u) parts.push(` ![video](${u
                      })`);
                  });
                  assistantMsg.content = parts.join('\n\n');
                }

                else if (typeof rMsg?.content === 'string' && rMsg.content) {
                  assistantMsg.content = rMsg.content;
                }

                else {
                  throw vidErr;
                }
              }

              catch (e2) {
                throw new Error(vidErr.message || 'Video uretilemedi.');
              }
            }

            closeCanvas();
            saveAll(); renderMessages(chat.messages); return;
          }

          else if (activeProv === 'custom') {
            setStatus('Video uretiliyor...');
            assistantMsg.content = await callCustomRouter(modA, history) || 'Video uretilemedi.';
            closeCanvas();
            saveAll(); renderMessages(chat.messages); return;
          }
        }

        if (activeProv === 'custom') {
          assistantMsg.content = await callCustomRouter(modA, history) || 'Bos yanit.';
        }

        else if (activeProv === 'anthropic') {
          assistantMsg.content = await callAnthropicRouter(modA, history) || 'Bos yanit.';
        }

        else if (prefs.stream) {
          setStatus('Stream...');
          assistantMsg.content = '';

          // Thinking timer updater (only if thinking is enabled)
          let thinkTimerInterval = null;

          if (prefs.showThinking) {
            thinkTimerInterval = setInterval(() => {
              const el = document.getElementById('live-thinking-timer');

              if (el && streamThinkingText) {
                const secs = Math.floor((Date.now() - thinkingStartTime) / 1000);

                el.textContent = `Dusunuyor... ${secs
                  }

              s`;
              }
            }

              , 1000);
          }

          await callPuterStream(modA, history, tok => {
            const dots = document.getElementById('thinking-dots');
            if (dots) dots.style.display = 'none';
            assistantMsg.content += tok;
            throttledRenderMessages(chat.messages);
            if (voiceConvMode) queueVoiceStreamChunk(tok);
          });
        }

        else {
          assistantMsg.content = await callPuterOnce(modA, history) || 'Bos yanit.';
        }

        saveAll();
        renderMessages(chat.messages);

        if (voiceConvMode && assistantMsg.content) {
          if (stylePrefs.streamMode && voiceStreamBuffer.trim()) {
            flushVoiceStreamBuffer();
          } else if (!stylePrefs.streamMode) {
            voiceConvSpeak(assistantMsg.content);
          }
          const waitForSpeech = () => {
            if (speechSynthesis.speaking) {
              setTimeout(waitForSpeech, 300);
            } else {
              voiceStreamBuffer = '';
              setVoiceOverlayState('listening');
              setTimeout(() => { try { recognition && recognition.start(); } catch(e) {} }, 600);
            }
          };
          if (stylePrefs.streamMode) setTimeout(waitForSpeech, 400);
        }

        // Finalize canvas if code was detected
        if (_pptxMode && assistantMsg.content) { generatePptxFromContent(assistantMsg.content); _pptxMode = false; }
        else if (isCodeRequest && assistantMsg.content) finalizeCanvas(assistantMsg.content);
        else if (canvasOpen && !isCodeRequest) closeCanvas();
      }

      catch (e) {
        if (canvasOpen) closeCanvas();
        let errText = e.message || String(e);
        const last = chat.messages[chat.messages.length - 1];

        if (last && last.role === 'assistant' && !last.content) {
          last.model = 'System'; last.content = `Hata: ${errText
            }

        `;
        }

        else {
          chat.messages.push({
            role: 'assistant', model: 'System', content: `Hata: ${errText
              }

          `
          });
        }

        saveAll(); renderMessages(chat.messages);
        setStatus('Hata: ' + errText.substring(0, 40));
      }

      finally {
        if (loader?.parentNode) loader.parentNode.removeChild(loader);
        sendBtn.disabled = false;
        isGenerating = false;
        currentAbortController = null;
        sendBtn.style.display = 'flex';
        stopBtn.style.display = 'none';
        $('user-input')?.focus();
        playNotificationSound();

        // Auto-title after first exchange
        if (chat && chat.messages.length === 2 && chat.title === text.slice(0, 30)) {
          autoGenerateTitle(chat);
        }
      }
    }

    // ---- Modals
    function openProvider() {
      openSettings();
    }

    function closeProvider() {
      closeSettings();
    }

    function updateProviderFields() {
      const val = $('provider-select').value;
      document.querySelectorAll('.provider-fields').forEach(el => el.classList.add('hidden'));
      const target = $('fields-' + val);
      if (target) target.classList.remove('hidden');
    }

    async function saveProviderSettings() {
      await saveSettings();
    }

    function openSettings() {
      const m = $('settings-modal'), c = m.querySelector('div');
      m.classList.remove('hidden');

      setTimeout(() => {
        m.classList.remove('opacity-0'); c.classList.remove('scale-95');
      }

        , 10);
      $('pref-stream').checked = ! !prefs.stream;
      $('pref-theme').checked = document.body.classList.contains('light-mode');
      if ($('pref-auto-theme')) $('pref-auto-theme').checked = ! !prefs.autoTheme;

      // Font size buttons
      ['sm', 'md', 'lg'].forEach(s => {
        const btn = $('font-' + s + '-btn');

        if (btn) {
          btn.style.borderColor = s === (prefs.fontSize || 'md') ? '#2563eb' : ''; btn.style.color = s === (prefs.fontSize || 'md') ? '#fff' : '';
        }
      });

      // Max tokens
      if ($('pref-max-tokens')) {
        $('pref-max-tokens').value = prefs.maxTokens || 4096; $('max-token-val').textContent = prefs.maxTokens || 4096;
      }

      if ($('pref-notify-sound')) $('pref-notify-sound').checked = ! !prefs.notifySound;
      if ($('pref-show-thinking')) $('pref-show-thinking').checked = ! !prefs.showThinking;
      updateAccentButtons(prefs.accent || 'blue');
      $('pref-short').checked = ! !stylePrefs.short;
      $('pref-no-lecture').checked = ! !stylePrefs.noLecture;
      $('pref-turkish').checked = ! !stylePrefs.turkish;
      selectVoiceStyle(stylePrefs.voiceStyle || 'samimi');
      $('pref-auth-mode').value = providerSettings.authMode || 'local';
      $('pref-custom').value = stylePrefs.custom || '';
      // Provider fields
      $('provider-select').value = providerSettings.active || 'puter';
      $('custom-url').value = providerSettings.custom?.baseUrl || '';
      $('custom-token').value = providerSettings.custom?.token || '';
      $('custom-model-id').value = providerSettings.custom?.modelId || '';
      $('anthropic-url').value = providerSettings.anthropic?.baseUrl || 'http://localhost:8080';
      $('anthropic-token').value = providerSettings.anthropic?.token || '';
      $('anthropic-model-id').value = providerSettings.anthropic?.modelId || 'claude-3-5-sonnet-20241022';
      updateProviderFields();
      renderPromptLibrary();
    }

    function closeSettings() {
      const m = $('settings-modal'), c = m.querySelector('div');
      m.classList.add('opacity-0'); c.classList.add('scale-95');
      setTimeout(() => m.classList.add('hidden'), 200);
    }

    async function saveSettings() {
      // Stream
      prefs.stream = $('pref-stream').checked;
      prefs.autoTheme = $('pref-auto-theme')?.checked || false;
      // Max tokens
      prefs.maxTokens = parseInt($('pref-max-tokens')?.value || 4096);
      prefs.notifySound = $('pref-notify-sound')?.checked || false;
      prefs.showThinking = ! !$('pref-show-thinking')?.checked;
      document.body.classList.toggle('hide-thinking', !prefs.showThinking);
      // Theme
      if (prefs.autoTheme) {
        applyAutoTheme();
      } else {
        const wantLight = $('pref-theme').checked;
        const isLight = document.body.classList.contains('light-mode');
        if (wantLight !== isLight) toggleTheme();
      }

      // Style prefs
      stylePrefs = {
        short: $('pref-short').checked, noLecture: $('pref-no-lecture').checked, turkish: $('pref-turkish').checked, custom: $('pref-custom').value || '',
        voiceStyle: $('pref-voice-style').value || 'samimi'
      }

        ;
      // Auth mode
      const newAuth = $('pref-auth-mode').value;

      if (newAuth !== providerSettings.authMode) {
        if (newAuth === 'puter' && !puter.auth.isSignedIn()) {
          try {
            await puter.auth.signIn();
          }

          catch (e) {
            alert('Puter girisi basarisiz.'); $('pref-auth-mode').value = 'local'; return;
          }
        }

        providerSettings.authMode = newAuth;
        saveAll();
        if (confirm('Oturum modu degisti. Sayfa yenilensin mi?')) location.reload();
      }

      // Provider
      const active = $('provider-select').value;
      providerSettings.active = active;

      if (!providerSettings.custom) providerSettings.custom = {}

        ;

      if (!providerSettings.anthropic) providerSettings.anthropic = {}

        ;
      providerSettings.custom.baseUrl = $('custom-url')?.value.trim() || '';
      providerSettings.custom.token = $('custom-token')?.value.trim() || '';
      providerSettings.custom.modelId = $('custom-model-id')?.value.trim() || '';
      providerSettings.anthropic.baseUrl = $('anthropic-url')?.value.trim() || 'http://localhost:8080';
      providerSettings.anthropic.token = $('anthropic-token')?.value.trim() || '';
      providerSettings.anthropic.modelId = $('anthropic-model-id')?.value.trim() || 'claude-3-5-sonnet-20241022';
      if (active === 'custom' && providerSettings.custom.modelId) prefs.modelA = providerSettings.custom.modelId;
      if (active === 'anthropic' && providerSettings.anthropic.modelId) prefs.modelA = providerSettings.anthropic.modelId;
      customModels = [];
      saveAll();
      closeSettings();
      await refreshModelDropdowns();
      setStatus('Ayarlar kaydedildi.');
    }

    function clearAllData() { openResetModal(); }

    function openResetModal() {
      const m = document.getElementById('reset-modal');
      if (!m) return;
      m.classList.remove('hidden');
      requestAnimationFrame(() => { m.classList.remove('opacity-0'); m.querySelector('div').classList.remove('scale-95'); });
    }

    function closeResetModal() {
      const m = document.getElementById('reset-modal');
      if (!m) return;
      m.classList.add('opacity-0');
      m.querySelector('div').classList.add('scale-95');
      setTimeout(() => m.classList.add('hidden'), 200);
    }

    function resetLocalOnly() {
      closeResetModal();
      const keysToKeep = [KEY_PROVIDERS, KEY_PREFS, KEY_STYLE];
      const saved = {};
      keysToKeep.forEach(k => { const v = localStorage.getItem(k); if (v) saved[k] = v; });
      localStorage.clear();
      keysToKeep.forEach(k => { if (saved[k]) localStorage.setItem(k, saved[k]); });
      chats = [];
      currentChatId = null;
      renderChatList();
      renderMessages([]);
      showWelcome();
    }

    async function resetEverything() {
      if (!confirm('Tum sohbetler kalici olarak silinecek. Emin misin?')) return;
      closeResetModal();
      await deleteAllChatsFromSupabase();
      localStorage.clear();
      location.reload();
    }

    let savedSystemPrompts = [];
    function loadSavedPrompts() {
      try { savedSystemPrompts = JSON.parse(localStorage.getItem('saved_sys_prompts') || '[]'); } catch(e) { savedSystemPrompts = []; }
    }
    function saveSavedPrompts() {
      localStorage.setItem('saved_sys_prompts', JSON.stringify(savedSystemPrompts));
    }
    function saveSystemPromptToLibrary() {
      const text = ($('pref-custom')?.value || '').trim();
      if (!text) { setStatus('Once bir sistem promptu yazin.'); return; }
      const name = prompt('Bu promptun adi:', text.substring(0, 40));
      if (!name) return;
      savedSystemPrompts.push({ id: Date.now(), name: name.trim(), prompt: text });
      saveSavedPrompts();
      renderPromptLibrary();
      setStatus('Prompt kaydedildi: ' + name.trim());
    }
    function applySystemPromptFromLibrary(id) {
      const p = savedSystemPrompts.find(x => x.id === id);
      if (!p) return;
      const ta = $('pref-custom');
      if (ta) ta.value = p.prompt;
      setStatus('Prompt yuklendi: ' + p.name);
    }
    function deleteSystemPromptFromLibrary(id) {
      savedSystemPrompts = savedSystemPrompts.filter(x => x.id !== id);
      saveSavedPrompts();
      renderPromptLibrary();
    }
    function renderPromptLibrary() {
      const list = $('prompt-library-list');
      const count = $('prompt-library-count');
      if (!list) return;
      if (count) count.textContent = savedSystemPrompts.length + ' prompt';
      if (savedSystemPrompts.length === 0) {
        list.innerHTML = '<div style="font-size:11px;color:#555;text-align:center;padding:12px 0">Henuz kaydedilmis prompt yok.<br>Yukardaki alana yaz ve &quot;+ Kutuphanye Kaydet&quot;e bas.</div>';
        return;
      }
      list.innerHTML = savedSystemPrompts.map(p => `
        <div style="display:flex;align-items:center;gap:6px;padding:7px 8px;background:rgba(255,255,255,0.03);border:1px solid #1e1e1e;border-radius:8px">
          <div style="flex:1;min-width:0;cursor:pointer" onclick="applySystemPromptFromLibrary(${p.id})">
            <div style="font-size:12px;font-weight:600;color:#d4d4d8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name.replace(/</g,'&lt;')}</div>
            <div style="font-size:10px;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.prompt.substring(0,60).replace(/</g,'&lt;')}${p.prompt.length>60?'...':''}</div>
          </div>
          <button onclick="applySystemPromptFromLibrary(${p.id})" title="Uygula" style="padding:4px 8px;background:rgba(37,99,235,0.15);border:1px solid rgba(37,99,235,0.3);border-radius:6px;color:#60a5fa;font-size:10px;font-weight:700;cursor:pointer;white-space:nowrap">Sec</button>
          <button onclick="deleteSystemPromptFromLibrary(${p.id})" title="Sil" style="padding:4px 6px;background:rgba(220,38,38,0.1);border:1px solid rgba(220,38,38,0.2);border-radius:6px;color:#f87171;font-size:11px;cursor:pointer">&#xd7;</button>
        </div>
      `).join('');
    }

    // ---- Stop Generation
    function stopGeneration() {
      if (currentAbortController) currentAbortController.abort();
      isGenerating = false;
      $('send-btn').style.display = 'flex';
      $('stop-btn').style.display = 'none';
      setStatus('Durduruldu.');
    }

    // ---- Message Actions
    function copyMessage(idx) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat || !chat.messages[idx]) return;
      const text = chat.messages[idx].content;
      navigator.clipboard.writeText(typeof text === 'string' ? text : JSON.stringify(text)).then(() => setStatus('Kopyalandi.'));
    }

    function editMessage(idx) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat || !chat.messages[idx]) return;
      const oldText = chat.messages[idx].content;
      const newText = prompt('Mesaji duzenle:', typeof oldText === 'string' ? oldText : '');
      if (newText === null || newText === oldText) return;
      // Remove this and all messages after it
      chat.messages = chat.messages.slice(0, idx);
      saveAll();
      // Set input and re-send
      $('user-input').value = newText;
      renderMessages(chat.messages);
      if (chat.messages.length === 0) showWelcome();
      handleSend();
    }

    function regenerateMessage(idx) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat || !chat.messages[idx]) return;
      // Find the user message before this assistant message
      let userIdx = idx - 1;
      while (userIdx >= 0 && chat.messages[userIdx].role !== 'user') userIdx--;
      if (userIdx < 0) return;
      const userText = chat.messages[userIdx].content;

      // Branch: save current response as a branch variant
      const assistantMsg = chat.messages[idx];
      if (!assistantMsg.branches) assistantMsg.branches = [];

      // Only store if there's real content to branch
      if (assistantMsg.content && assistantMsg.content.trim()) {
        assistantMsg.branches.push({
          content: assistantMsg.content,
          model: assistantMsg.model,
          timestamp: assistantMsg.timestamp || Date.now()
        });
        if (!assistantMsg.activeBranch) assistantMsg.activeBranch = assistantMsg.branches.length; // 1-indexed, current is "next"
      }

      // Remove from the user message onward
      chat.messages = chat.messages.slice(0, userIdx);
      saveAll();
      $('user-input').value = typeof userText === 'string' ? userText : '';
      renderMessages(chat.messages);
      handleSend();
    }

    function switchBranch(msgIdx, direction) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat || !chat.messages[msgIdx]) return;
      const msg = chat.messages[msgIdx];
      if (!msg.branches || msg.branches.length === 0) return;

      // Total variants = branches + current
      const totalVariants = msg.branches.length + 1;
      let currentIdx = msg.activeBranch || totalVariants; // default to latest (current content)

      currentIdx += direction;
      if (currentIdx < 1) currentIdx = totalVariants;
      if (currentIdx > totalVariants) currentIdx = 1;

      msg.activeBranch = currentIdx;

      if (currentIdx <= msg.branches.length) {
        // Swap: save current content to last branch slot, load selected branch
        const currentContent = msg.content;
        const currentModel = msg.model;
        const currentTimestamp = msg.timestamp;

        // Replace current with selected branch
        const branch = msg.branches[currentIdx - 1];
        msg.content = branch.content;
        msg.model = branch.model;
        msg.timestamp = branch.timestamp;

        // Save old current into branches at the same position
        msg.branches[currentIdx - 1] = {
          content: currentContent, model: currentModel, timestamp: currentTimestamp
        }

          ;
      }

      saveAll();
      renderMessages(chat.messages);
    }

    // ---- TTS
    let currentUtterance = null;

    function cleanTextForSpeech(raw) {
      return raw
        .replace(/<[^>]*>/g, '')
        .replace(/```[\s\S]*?```/g, ' kod blogu ')
        .replace(/`[^`]+`/g, '')
        .replace(/https?:\/\/\S+/g, '')
        .replace(/[\u{1F000}-\u{1FFFF}]|[\u{2600}-\u{27BF}]|\u{FE0F}|\u{20E3}|[\u{1F900}-\u{1F9FF}]|[\u{1FA00}-\u{1FAFF}]/gu, '')
        .replace(/[#*_~]/g, '')
        .replace(/\|/g, ' ')
        .replace(/---+/g, ' ')
        .replace(/^\s*[-]\s+/gm, '')
        .replace(/^\s*\d+\.\s+/gm, '')
        .replace(/\n{2,}/g, '. ')
        .replace(/\n/g, ', ')
        .replace(/:\s*,/g, ':')
        .replace(/\s{2,}/g, ' ')
        .replace(/([.!?])\s*\1+/g, '$1')
        .trim();
    }

    const VOICE_STYLE_PARAMS = {
      samimi:      { rate: 0.92, pitch: 1.10, volume: 1.0,  femaleHints: ['zeynep','yelda','dilek','ayse','samantha','ava','karen','alice','victoria','moira','tessa','fiona','sara','anna','zira','hazel','heera'], maleHints: [] },
      profesyonel: { rate: 0.80, pitch: 0.90, volume: 0.95, femaleHints: [], maleHints: ['ali','daniel','alex','david','mark','jorge','diego','luca','thomas','james','arthur','eddy','google uk english male','microsoft david'] },
      zkusagi:     { rate: 1.15, pitch: 1.15, volume: 1.0,  femaleHints: ['samantha','ava','karen','alice','zeynep','yelda','zira','hazel'], maleHints: [] },
    };

    function getBestVoice(lang, style) {
      const voices = speechSynthesis.getVoices();
      const langCode = lang.toLowerCase();
      const candidates = voices.filter(v => v.lang.toLowerCase().startsWith(langCode.split('-')[0]));
      if (!candidates.length) return null;
      const params = VOICE_STYLE_PARAMS[style || 'samimi'] || VOICE_STYLE_PARAMS.samimi;
      const hints = [...(params.femaleHints || []), ...(params.maleHints || [])];
      for (const hint of hints) {
        const match = candidates.find(v => v.name.toLowerCase().includes(hint));
        if (match) return match;
      }
      const quality = ['google', 'microsoft', 'natural', 'premium', 'enhanced', 'neural'];
      for (const kw of quality) {
        const match = candidates.find(v => v.name.toLowerCase().includes(kw));
        if (match) return match;
      }
      return candidates[0];
    }

    function makeUtterance(text, lang, onEnd, onError) {
      const utter = new SpeechSynthesisUtterance(text.substring(0, 3000));
      utter.lang = lang;
      const style = stylePrefs.voiceStyle || 'samimi';
      const params = VOICE_STYLE_PARAMS[style] || VOICE_STYLE_PARAMS.samimi;
      utter.rate = params.rate;
      utter.pitch = params.pitch;
      utter.volume = params.volume !== undefined ? params.volume : 1.0;
      const voice = getBestVoice(lang, style);
      if (voice) utter.voice = voice;
      utter.onend = onEnd;
      utter.onerror = onError;
      return utter;
    }

    function selectVoiceStyle(style) {
      stylePrefs.voiceStyle = style;
      document.querySelectorAll('.voice-style-btn').forEach(btn => {
        const active = btn.dataset.style === style;
        btn.classList.toggle('border-blue-500', active);
        btn.classList.toggle('text-white', active);
        btn.classList.toggle('bg-blue-600/20', active);
        btn.classList.toggle('border-[#333]', !active);
        btn.classList.toggle('text-neutral-400', !active);
      });
      $('pref-voice-style').value = style;
    }

    function voiceConvSpeak(rawText) {
      if (currentUtterance) { speechSynthesis.cancel(); currentUtterance = null; }
      const text = cleanTextForSpeech(rawText);
      if (!text) {
        if (voiceConvMode) {
          setVoiceOverlayState('listening');
          setTimeout(() => { try { recognition && recognition.start(); } catch(e) {} }, 500);
        }
        return;
      }
      const lang = stylePrefs.turkish ? 'tr-TR' : 'en-US';
      const resume = () => {
        currentUtterance = null;
        setStatus('Yanit okundu. Konusmaya devam edin...');
        if (voiceConvMode) {
          setVoiceOverlayState('listening');
          const interimEl = $('voice-interim');
          if (interimEl) interimEl.textContent = '';
          setTimeout(() => { try { recognition && recognition.start(); } catch(e) {} }, 600);
        }
      };
      const doSpeak = () => {
        currentUtterance = makeUtterance(text, lang, resume, resume);
        speechSynthesis.speak(currentUtterance);
        setStatus('Yapay zeka yanit veriyor...');
        if (voiceConvMode) setVoiceOverlayState('speaking');
      };
      if (speechSynthesis.getVoices().length) {
        doSpeak();
      } else {
        speechSynthesis.addEventListener('voiceschanged', doSpeak, { once: true });
      }
    }

    let voiceStreamBuffer = '';
    let voiceStreamTimer = null;

    function flushVoiceStreamBuffer() {
      if (!voiceStreamBuffer.trim() || !voiceConvMode) { voiceStreamBuffer = ''; return; }
      const text = cleanTextForSpeech(voiceStreamBuffer);
      voiceStreamBuffer = '';
      if (!text) return;
      const lang = stylePrefs.turkish ? 'tr-TR' : 'en-US';
      const utter = makeUtterance(text, lang, () => {}, () => {});
      speechSynthesis.speak(utter);
    }

    function queueVoiceStreamChunk(chunk) {
      if (!voiceConvMode) return;
      voiceStreamBuffer += chunk;
      const sentenceEnd = /[.!?]\s/.exec(voiceStreamBuffer);
      if (sentenceEnd) {
        const sentence = voiceStreamBuffer.substring(0, sentenceEnd.index + 1);
        voiceStreamBuffer = voiceStreamBuffer.substring(sentenceEnd.index + 2);
        const text = cleanTextForSpeech(sentence);
        if (text) {
          const lang = stylePrefs.turkish ? 'tr-TR' : 'en-US';
          const utter = makeUtterance(text, lang, () => {}, () => {});
          speechSynthesis.speak(utter);
          setVoiceOverlayState('speaking');
        }
      }
    }

    function speakMessage(idx) {
      if (currentUtterance) {
        speechSynthesis.cancel(); currentUtterance = null; setStatus('Sesli okuma durduruldu.'); return;
      }
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat || !chat.messages[idx]) return;
      const text = cleanTextForSpeech(chat.messages[idx].content);
      if (!text) return;
      const lang = stylePrefs.turkish ? 'tr-TR' : 'en-US';
      const doSpeak = () => {
        currentUtterance = makeUtterance(text, lang,
          () => { currentUtterance = null; setStatus('Sesli okuma tamamlandi.'); },
          () => { currentUtterance = null; }
        );
        speechSynthesis.speak(currentUtterance);
        setStatus('Sesli okunuyor...');
      };
      if (speechSynthesis.getVoices().length) {
        doSpeak();
      } else {
        speechSynthesis.addEventListener('voiceschanged', doSpeak, { once: true });
      }
    }

    // ---- Pin/Folder
    function togglePin(id) {
      const c = chats.find(x => x.id === id);

      if (c) {
        c.pinned = !c.pinned; saveAll(); renderChatList();
      }
    }

    function promptFolder(id) {
      const c = chats.find(x => x.id === id);
      if (!c) return;
      const folders = [...new Set(chats.filter(x => x.folder).map(x => x.folder))];

      const hint = folders.length > 0 ? `Mevcut: ${folders.join(', ')
        }

      \n` : '';
      const name = prompt(hint + 'Klasor adi (bos birakirsan klasorden cikar):', c.folder || '');
      if (name === null) return;
      c.folder = name.trim() || undefined;
      saveAll(); renderChatList();
    }

    // ---- Auto Title
    async function autoGenerateTitle(chat) {
      try {
        const userMsg = chat.messages.find(m => m.role === 'user');
        if (!userMsg) return;
        const prompt = `Bu mesaj icin 3-5 kelimelik kisa bir baslik uret. Sadece basligi yaz, baska bir sey yazma: "${typeof userMsg.content === 'string' ? userMsg.content.substring(0, 200) : ''}" `;

        const r = await puter.ai.chat([{
          role: 'user', content: prompt
        }

        ], {
          model: 'gpt-4o-mini'
        });

        const title = (r?.message?.content || r?.content || '').trim().replace(/["" "]/g, '').substring(0, 40);
        if (title && title.length > 2) {
          chat.title = title; saveAll(); renderChatList();
        }
      }

      catch (e) {
        /* silent fail */
      }
    }

    // ---- Export
    function openExportModal() {
      const chat = chats.find(c => c.id === currentChatId);

      if (!chat || chat.messages.length === 0) {
        alert('Aktif sohbet yok.'); return;
      }

      const m = $('export-modal'), c = m.querySelector('div');
      m.classList.remove('hidden');

      setTimeout(() => {
        m.classList.remove('opacity-0'); c.classList.remove('scale-95');
      }

        , 10);
    }

    function closeExportModal() {
      const m = $('export-modal'), c = m.querySelector('div');
      m.classList.add('opacity-0'); c.classList.add('scale-95');
      setTimeout(() => m.classList.add('hidden'), 200);
    }

    function shareChat() {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;
      const payload = JSON.stringify({ title: chat.title, messages: chat.messages.map(m => ({ role: m.role, content: typeof m.content === 'string' ? m.content : m.content })) });
      const encoded = btoa(unescape(encodeURIComponent(payload)));
      const url = location.origin + location.pathname + '#share=' + encoded;
      navigator.clipboard.writeText(url).then(() => {
        setStatus('Paylasim linki kopyalandi!');
      }).catch(() => {
        prompt('Linki kopyala:', url);
      });
      closeExportModal();
    }

    function loadSharedChat() {
      const hash = location.hash;
      if (!hash.startsWith('#share=')) return;
      try {
        const encoded = hash.slice(7);
        const payload = JSON.parse(decodeURIComponent(escape(atob(encoded))));
        if (!payload.messages) return;
        const id = 'shared-' + Date.now();
        const sharedChat = { id, title: (payload.title || 'Paylasim') + ' (Paylasim)', messages: payload.messages, createdAt: Date.now() };
        chats.unshift(sharedChat);
        currentChatId = id;
        saveAll();
        renderChatList();
        renderMessages(sharedChat.messages);
        history.replaceState(null, '', location.pathname);
        setStatus('Paylasilan sohbet yuklendi.');
      } catch (e) { console.warn('Paylasim yuklenemedi:', e); }
    }

    function exportChat(format) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;
      let content = '', filename = '', type = 'text/plain';

      if (format === 'md') {
        content = `# ${chat.title
          }

        \n\n`;

        chat.messages.forEach(m => {
          if (m.role === 'user') content += `## Kullanici\n${m.content
            }

            \n\n`;

          else content += `## ${m.model || 'AI'
            }

            \n${m.content
            }

            \n\n`;
        });

        filename = `${chat.title.replace(/[^a-zA-Z0-9]/g, '_')
          }

        .md`;
      }

      else if (format === 'json') {
        content = JSON.stringify(chat, null, 2);

        filename = `${chat.title.replace(/[^a-zA-Z0-9]/g, '_')
          }

        .json`;
        type = 'application/json';
      }

      else {
        chat.messages.forEach(m => {
          if (m.role === 'user') content += `[Kullanici]: ${m.content
            }

            \n\n`;

          else content += `[${m.model || 'AI'
            }

            ]: ${m.content
            }

            \n\n`;
        });

        filename = `${chat.title.replace(/[^a-zA-Z0-9]/g, '_')
          }

        .txt`;
      }

      const blob = new Blob([content], {
        type
      });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      URL.revokeObjectURL(a.href);
      closeExportModal();
      setStatus('Indirildi: ' + filename);
    }

    function exportChatPDF() {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;
      closeExportModal();
      const isLight = document.body.classList.contains('light-mode');
      const bg = isLight ? '#ffffff' : '#0a0a0a';
      const fg = isLight ? '#1a1a2e' : '#e2e8f0';
      const border = isLight ? '#e5e5e5' : '#1e1e1e';
      const userBg = '#2563eb';
      const aiBg = isLight ? '#f7f7f8' : '#111111';

      let rows = '';
      chat.messages.forEach(m => {
        if (m.role === 'system') return;
        if (typeof m.content === 'string' && m.content.startsWith('__PPTX_DOWNLOAD__')) return;
        const role = m.role === 'user' ? 'Kullanici' : (m.model || 'AI');
        const isUser = m.role === 'user';
        const text = (typeof m.content === 'string' ? m.content : JSON.stringify(m.content)).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
        const ts = m.ts ? new Date(m.ts).toLocaleString('tr-TR') : '';
        rows += `<div class="msg ${isUser ? 'user-msg' : 'ai-msg'}">
          <div class="msg-header"><span class="role">${role}</span><span class="ts">${ts}</span></div>
          <div class="msg-body">${text}</div>
        </div>`;
      });

      const html = `<!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"><title>${chat.title}</title><style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:${bg};color:${fg};padding:24px;font-size:13px;line-height:1.6}
        h1{font-size:18px;font-weight:700;margin-bottom:4px;padding-bottom:12px;border-bottom:1px solid ${border}}
        .meta{font-size:11px;color:#888;margin-bottom:20px;padding-top:6px}
        .msg{margin-bottom:16px;padding:14px 16px;border-radius:12px;border:1px solid ${border};background:${aiBg};break-inside:avoid}
        .user-msg{background:#1d3557;border-color:#2563eb33}
        .msg-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .role{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:#60a5fa}
        .user-msg .role{color:#93c5fd}
        .ts{font-size:10px;color:#666}
        .msg-body{white-space:pre-wrap;word-break:break-word}
        @media print{body{padding:16px}@page{margin:16mm}}
      </style></head><body>
        <h1>${chat.title}</h1>
        <div class="meta">${chat.messages.filter(m=>m.role!=='system').length} mesaj &bull; ${new Date().toLocaleDateString('tr-TR')}</div>
        ${rows}
      </body></html>`;

      const win = window.open('', '_blank');
      if (!win) { setStatus('Popup engellendi. Lutfen izin verin.'); return; }
      win.document.write(html);
      win.document.close();
      win.onload = () => { win.focus(); win.print(); };
      setStatus('PDF penceresi acildi.');
    }

    // ---- Persona Gallery
    function openPersonaGallery() {
      const g = $('persona-grid');

      g.innerHTML = PERSONAS.map(p => ` <button onclick="setPersona('${escapeJs(p.prompt)}')" class="p-4 bg-white/[0.02] hover:bg-white/[0.06] border border-[#222] rounded-xl text-left transition-all" > <div class="flex items-center gap-2 mb-2" > <span class="text-xl" >${p.icon
        }

        </span> <span class="text-sm font-bold text-white" >${escapeHtml(p.title)
        }

        </span> </div> <div class="text-xs text-neutral-500 line-clamp-3 leading-relaxed" >${escapeHtml(p.prompt)
        }

        </div> </button>`).join('');
      const m = $('persona-modal');
      m.classList.remove('hidden');
      setTimeout(() => m.classList.remove('opacity-0'), 10);
    }

    function setPersona(promptText) {
      stylePrefs.custom = promptText;
      saveAll();
      closePersonaGallery();
      setStatus('Aktif rol degistirildi.');
    }

    function clearPersona() {
      stylePrefs.custom = '';
      saveAll();
      closePersonaGallery();
      setStatus('Rol sifirlandi.');
    }

    function closePersonaGallery() {
      const m = $('persona-modal');
      m.classList.add('opacity-0');
      setTimeout(() => m.classList.add('hidden'), 200);
    }

    // ---- Prompt Templates
    function openPromptTemplates() {
      const m = $('prompt-templates-modal'), c = m.querySelector('div');
      m.classList.remove('hidden');

      setTimeout(() => {
        m.classList.remove('opacity-0'); c.classList.remove('scale-95');
      }

        , 10);
      const grid = $('prompt-templates-grid');

      grid.innerHTML = PROMPT_TEMPLATES.map((t, i) => ` <button onclick="useTemplate(${i})" class="p-4 bg-white/[0.02] hover:bg-white/[0.06] border border-[#222] rounded-xl text-left transition-all" > <div class="flex items-center gap-2 mb-2" > <span class="text-lg" >${t.icon
        }

        </span> <span class="${t.color} font-bold text-[11px] uppercase tracking-wider" >${escapeHtml(t.title)
        }

        </span> </div> <div class="text-neutral-500 text-[11px] truncate" >${escapeHtml(t.prompt)
        }

        </div> </button> `).join('');
    }

    function closePromptTemplates() {
      const m = $('prompt-templates-modal'), c = m.querySelector('div');
      m.classList.add('opacity-0'); c.classList.add('scale-95');
      setTimeout(() => m.classList.add('hidden'), 200);
    }

    function useTemplate(idx) {
      const t = PROMPT_TEMPLATES[idx];
      if (!t) return;
      $('user-input').value = t.prompt;
      $('user-input').focus();
      closePromptTemplates();
    }

    // ---- Memory System
    function saveMemory(key, value) {
      memory[key] = value; localStorage.setItem('ai_memory', JSON.stringify(memory));
    }

    function getMemory(key) {
      return memory[key];
    }

    function buildMemoryContext() {
      const keys = Object.keys(memory);
      if (keys.length === 0) return '';

      return '\n[Hafiza: ' + keys.map(k => `${k
        }

        : ${memory[k]
        }

        `).join(', ') + ']';
    }

    // ---- Font Size
    function setFontSize(size) {
      document.body.classList.remove('font-sm', 'font-md', 'font-lg');
      document.body.classList.add('font-' + size);

      // Also set on html element for rem-based sizing
      const sizes = {
        sm: '12px', md: '14px', lg: '16px'
      }

        ;
      document.documentElement.style.fontSize = sizes[size] || '14px';
      prefs.fontSize = size;
      saveAll();

      // Update button states
      ['sm', 'md', 'lg'].forEach(s => {
        const btn = $('font-' + s + '-btn');

        if (btn) {
          btn.style.borderColor = s === size ? '#2563eb' : ''; btn.style.color = s === size ? '#fff' : '';
        }
      });
    }

    // ---- Drag & Drop
    function initDragDrop() {
      let dragCounter = 0;

      document.addEventListener('dragenter', e => {
        e.preventDefault(); dragCounter++; $('drag-overlay')?.classList.remove('hidden');
      });

      document.addEventListener('dragleave', e => {
        e.preventDefault(); dragCounter--; if (dragCounter <= 0) {
          dragCounter = 0; $('drag-overlay')?.classList.add('hidden');
        }
      });
      document.addEventListener('dragover', e => e.preventDefault());

      document.addEventListener('drop', e => {
        e.preventDefault(); dragCounter = 0; $('drag-overlay')?.classList.add('hidden');
        const files = Array.from(e.dataTransfer.files);
        if (files.length === 0) return;

        // Reuse file handling
        const fakeEvent = {
          target: {
            files, value: ''
          }
        }

          ;
        handleFileSelect(fakeEvent);
      });
    }

    // ---- Keyboard Shortcuts
    function initKeyboardShortcuts() {
      document.addEventListener('keydown', e => {
        // Don't intercept when typing in inputs (except special combos)
        const tag = e.target.tagName;
        const isInput = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';

        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
          e.preventDefault(); createNewChat();
        }

        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault(); $('search-input')?.focus();
        }

        if ((e.ctrlKey || e.metaKey) && e.key === ',') {
          e.preventDefault(); openSettings();
        }

        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
          e.preventDefault(); openExportModal();
        }

        if ((e.ctrlKey || e.metaKey) && e.key === 't') {
          e.preventDefault(); openPromptTemplates();
        }

        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault(); toggleChatSearch();
        }

        if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
          e.preventDefault(); openGlobalSearch();
        }

        if ((e.ctrlKey || e.metaKey) && e.key === 'j') {
          e.preventDefault(); toggleNotepad();
        }

        if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
          e.preventDefault(); openCompareMode();
        }

        if ((e.ctrlKey || e.metaKey) && e.key === '/') {
          e.preventDefault(); $('user-input')?.focus();
        }

        if ((e.ctrlKey || e.metaKey) && e.key === '?') {
          e.preventDefault(); openShortcutsHelp();
        }

        if (e.key === 'Escape') {
          // Close lightbox first
          const lb = $('lightbox-modal');

          if (lb && !lb.classList.contains('hidden')) {
            closeLightbox(); return;
          }

          // Close shortcuts help
          const sh = $('shortcuts-modal');

          if (sh && !sh.classList.contains('hidden')) {
            closeShortcutsHelp(); return;
          }

          closeSettings(); closeExportModal(); closePromptTemplates(); closeCompareModal(); closeCompareResults(); closeStatsModal();
          closeGlobalSearch(); closeSlideModal(); closeReportModal(); closeEditModal();
          if (notepadOpen) toggleNotepad();
          const sb = $('chat-search-bar'); if (sb && !sb.classList.contains('hidden')) toggleChatSearch();
          if (isGenerating) stopGeneration();
          hideSelectionMenu();
          // Close mobile sidebar
          const sidebar = $('sidebar');
          if (sidebar && sidebar.classList.contains('mobile-open')) toggleMobileSidebar();
        }

        // Focus chat input with / when not typing
        if (e.key === '/' && !isInput && !e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          $('user-input')?.focus();
        }
      });
    }

    // ---- Shortcuts Help Modal
    function openShortcutsHelp() {
      const m = $('shortcuts-modal');
      if (!m) return;
      m.classList.remove('hidden');

      setTimeout(() => {
        m.classList.remove('opacity-0'); m.querySelector('div')?.classList.remove('scale-95');
      }

        , 10);
    }

    function closeShortcutsHelp() {
      const m = $('shortcuts-modal');
      if (!m) return;
      m.classList.add('opacity-0'); m.querySelector('div')?.classList.add('scale-95');
      setTimeout(() => m.classList.add('hidden'), 200);
    }

    // ---- Image Lightbox
    function openLightbox(src) {
      const m = $('lightbox-modal'), img = $('lightbox-img');
      if (!m || !img) return;
      img.src = src;
      img.style.transform = 'scale(1)';
      m.classList.remove('hidden');
      // Zoom with scroll
      img._zoom = 1;

      img.onwheel = (e) => {
        e.preventDefault();
        img._zoom = Math.max(0.5, Math.min(5, img._zoom + (e.deltaY > 0 ? -0.2 : 0.2)));

        img.style.transform = `scale(${img._zoom
          })`;
      }

        ;
    }

    function closeLightbox() {
      const m = $('lightbox-modal');
      if (m) m.classList.add('hidden');
    }

    function downloadLightboxImage() {
      const img = $('lightbox-img');
      if (!img?.src) return;
      const a = document.createElement('a');
      a.href = img.src;
      a.download = 'image-' + Date.now() + '.png';
      a.click();
    }

    // Attach lightbox to all chat images (called after render)
    function attachLightbox() {
      document.querySelectorAll('#chat-window .prose img').forEach(img => {
        if (img.dataset.lightbox) return;
        img.dataset.lightbox = '1';
        img.style.cursor = 'zoom-in';

        img.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          openLightbox(img.src);
        });
      });
    }

    // ---- xterm.js Terminal
    function initCanvasTerminal() {
      if (canvasTerminal) return;

      if (typeof Terminal === 'undefined') {
        console.warn('xterm.js not loaded'); return;
      }

      const container = $('terminal-container');
      if (!container) return;

      canvasTerminal = new Terminal({

        cursorBlink: true, fontSize: 13, fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
        theme: {
          background: '#0d0d0d', foreground: '#c9d1d9', cursor: '#58a6ff', selectionBackground: '#264f78',
          black: '#0d1117', red: '#ff7b72', green: '#7ee787', yellow: '#d29922',
          blue: '#58a6ff', magenta: '#bc8cff', cyan: '#39c5cf', white: '#c9d1d9'
        }

        ,
        scrollback: 5000
      });

      if (typeof FitAddon !== 'undefined') {
        canvasTerminalFit = new FitAddon.FitAddon();
        canvasTerminal.loadAddon(canvasTerminalFit);
      }

      canvasTerminal.open(container);
      if (canvasTerminalFit) setTimeout(() => canvasTerminalFit.fit(), 100);
      // Shell emulation
      let cmdBuffer = '';
      const cwd = '/project';
      canvasTerminal.writeln('\x1b[1;34m=== AI Project Terminal ===\x1b[0m');
      canvasTerminal.writeln('\x1b[33mJavaScript, Node.js ve Python kodlarini calistirabilirsiniz.\x1b[0m');
      canvasTerminal.writeln('\x1b[90mKomutlar: node <dosya|kod>, run <file>, js <code>, python <code>, ls, cat, npm, clear, help\x1b[0m');
      termPrompt();

      canvasTerminal.onKey(({
        key, domEvent

      }) => {
        const code = domEvent.keyCode;

        if (code === 13) {
          // Enter
          canvasTerminal.writeln('');
          processTerminalCommand(cmdBuffer.trim());
          cmdBuffer = '';
          termPrompt();
        }

        else if (code === 8) {

          // Backspace
          if (cmdBuffer.length > 0) {
            cmdBuffer = cmdBuffer.slice(0, -1); canvasTerminal.write('\b \b');
          }
        }

        else if (code === 12) {
          // Ctrl+L
          canvasTerminal.clear(); termPrompt();
        }

        else if (!domEvent.ctrlKey && !domEvent.altKey && key.length === 1) {
          cmdBuffer += key; canvasTerminal.write(key);
        }
      });

      window.addEventListener('resize', () => {
        if (canvasTerminalFit) canvasTerminalFit.fit();
      });
    }

    function termPrompt() {
      canvasTerminal.write('\x1b[32m$ \x1b[0m');
    }

    function processTerminalCommand(cmd) {
      if (!cmd) return;
      const parts = cmd.split(/\s+/);
      const command = parts[0].toLowerCase();
      const args = parts.slice(1).join(' ');

      if (command === 'help') {
        canvasTerminal.writeln('\x1b[1mKullanilabilir Komutlar:\x1b[0m');
        canvasTerminal.writeln('  \x1b[36mls\x1b[0m              - Dosyalari listele');
        canvasTerminal.writeln('  \x1b[36mcat <dosya>\x1b[0m     - Dosya icerigini goster');
        canvasTerminal.writeln('  \x1b[36mrun <dosya>\x1b[0m     - JS/PY dosyasini calistir');
        canvasTerminal.writeln('  \x1b[36mnode <dosya|kod>\x1b[0m - Node.js dosyasi veya kodu calistir');
        canvasTerminal.writeln('  \x1b[36mjs <kod>\x1b[0m        - JavaScript kodu calistir');
        canvasTerminal.writeln('  \x1b[36mpython <kod>\x1b[0m    - Python kodu calistir (AI ile)');
        canvasTerminal.writeln('  \x1b[36mnpm <komut>\x1b[0m     - npm komutu calistir (AI ile)');
        canvasTerminal.writeln('  \x1b[36mclear\x1b[0m           - Terminali temizle');
      }

      else if (command === 'clear') {
        canvasTerminal.clear();
      }

      else if (command === 'ls') {
        const files = Object.keys(canvasFiles);
        if (files.length === 0) canvasTerminal.writeln('\x1b[90m(bos)\x1b[0m');

        else files.forEach(f => canvasTerminal.writeln(` \x1b[36m${f
          }

            \x1b[0m`));
      }

      else if (command === 'cat') {
        if (!args) {
          canvasTerminal.writeln('\x1b[31mKullanim: cat <dosya>\x1b[0m'); return;
        }

        const content = canvasFiles[args];
        if (content) canvasTerminal.writeln(content);

        else canvasTerminal.writeln(`\x1b[31mDosya bulunamadi: ${args
          }

          \x1b[0m`);
      }

      else if (command === 'run') {
        if (!args) {
          canvasTerminal.writeln('\x1b[31mKullanim: run <dosya>\x1b[0m'); return;
        }

        const content = canvasFiles[args];

        if (!content) {
          canvasTerminal.writeln(`\x1b[31mDosya bulunamadi: ${args
            }

            \x1b[0m`);
          const files = Object.keys(canvasFiles);

          if (files.length > 0) {
            canvasTerminal.writeln('\x1b[90mMevcut dosyalar:\x1b[0m'); files.forEach(f => canvasTerminal.writeln(` \x1b[36m${f
              }

                \x1b[0m`));
          }

          else canvasTerminal.writeln('\x1b[90m(henuz dosya yok - once AI ile kod olusturun)\x1b[0m');
          return;
        }

        if (args.endsWith('.js') || args.endsWith('.mjs')) executeJsInTerminal(content);
        else if (args.endsWith('.py')) executePythonInTerminal(content);
        else canvasTerminal.writeln('\x1b[31mSadece .js ve .py dosyalari calistirilabilir.\x1b[0m');
      }

      else if (command === 'js' || command === 'javascript') {
        executeJsInTerminal(args);
      }

      else if (command === 'python' || command === 'py') {
        executePythonViaAI(args);
      }

      else if (command === 'node') {
        if (!args) {
          canvasTerminal.writeln('\x1b[31mKullanim: node <dosya.js> veya node <kod>\x1b[0m'); return;
        }

        // Check if it's a file reference
        const fileContent = canvasFiles[args] || canvasFiles[args.trim()];

        if (fileContent) {
          canvasTerminal.writeln(`\x1b[33mnode ${args
            }

            calistiriliyor...\x1b[0m`);

          // Try local execution first for simple JS
          try {
            const origLog = console.log;
            const origError = console.error;
            const logs = [];

            console.log = (...a) => {
              logs.push(a.map(x => typeof x === 'object' ? JSON.stringify(x, null, 2) : String(x)).join(' '));
            }

              ;

            console.error = (...a) => {
              logs.push('\x1b[31m' + a.map(x => String(x)).join(' ') + '\x1b[0m');
            }

              ;
            // Check if code uses Node-only features
            const hasNodeFeatures = /\b(require|process\.|fs\.|path\.|http\.|https\.|child_process|__dirname|__filename|Buffer\.|module\.exports|import\s+.*from)\b/.test(fileContent);

            if (hasNodeFeatures) {
              console.log = origLog;
              console.error = origError;

              executeNodeViaAI(`Dosya: ${args
                }

                \n${fileContent
                }

                `);
            }

            else {
              const result = eval(fileContent);
              console.log = origLog;
              console.error = origError;
              logs.forEach(l => canvasTerminal.writeln(l));
              if (result !== undefined && logs.length === 0) canvasTerminal.writeln(String(result));
            }
          }

          catch (e) {
            canvasTerminal.writeln(`\x1b[31mError: ${e.message
              }

              \x1b[0m`);
            canvasTerminal.writeln('\x1b[33mAI ile yeniden deneniyor...\x1b[0m');

            executeNodeViaAI(`Dosya: ${args
              }

              \n${fileContent
              }

              `);
          }
        }

        else if (args.endsWith('.js') || args.endsWith('.mjs') || args.endsWith('.cjs')) {

          // User typed a filename but it doesn't exist
          canvasTerminal.writeln(`\x1b[31mDosya bulunamadi: ${args
            }

            \x1b[0m`);
          canvasTerminal.writeln('\x1b[90mMevcut dosyalar:\x1b[0m');
          const files = Object.keys(canvasFiles);
          if (files.length === 0) canvasTerminal.writeln('  \x1b[90m(bos - once kod olusturun)\x1b[0m');

          else files.forEach(f => canvasTerminal.writeln(` \x1b[36m${f
            }

              \x1b[0m`));
        }

        else {
          // Treat as inline code
          executeNodeViaAI(args);
        }
      }

      else if (command === 'npm') {
        executeNpmViaAI(args);
      }

      else {

        // Check similar commands
        const suggestions = {
          'nd': 'node', 'nod': 'node', 'nodejs': 'node', 'py': 'python', 'pip': 'npm', 'exec': 'run', 'execute': 'run', 'start': 'run'
        }

          ;
        const suggestion = suggestions[command];

        if (suggestion) canvasTerminal.writeln(`\x1b[33mBelki su komutu denemek istersiniz: \x1b[36m${suggestion
          }

          ${args
          }

          \x1b[0m`);

        else canvasTerminal.writeln(`\x1b[31mBilinmeyen komut: ${command
          }

          \x1b[0m \x1b[90m(help yazin)\x1b[0m`);
      }
    }

    function executeJsInTerminal(code) {
      try {
        const origLog = console.log;
        const logs = [];

        console.log = (...a) => {
          logs.push(a.map(x => typeof x === 'object' ? JSON.stringify(x, null, 2) : String(x)).join(' '));
        }

          ;
        const result = eval(code);
        console.log = origLog;
        logs.forEach(l => canvasTerminal.writeln(l));
        if (result !== undefined && logs.length === 0) canvasTerminal.writeln(String(result));
      }

      catch (e) {
        canvasTerminal.writeln(`\x1b[31mError: ${e.message
          }

          \x1b[0m`);
      }
    }

    function executePythonInTerminal(code) {
      executePythonViaAI(code);
    }

    async function executePythonViaAI(code) {
      canvasTerminal.writeln('\x1b[33mPython AI ile calistiriliyor...\x1b[0m');

      try {
        const r = await puter.ai.chat([{
          role: 'system', content: 'Sen bir Python yorumlayicisisin. Verilen kodu calistir ve sadece ciktiyi ver. Aciklama yapma.'
        }

          ,
        {
          role: 'user', content: `Bu Python kodunu calistir ve ciktiyi ver:\n\`\`\`python\n${code
            }

          \n\`\`\``
        }

        ], {
          model: 'gpt-4o-mini'
        });
        const out = r?.message?.content || r?.content || '';
        canvasTerminal.writeln(out.replace(/```[\s\S]*?```/g, '').trim());
      }

      catch (e) {
        canvasTerminal.writeln(`\x1b[31mHata: ${e.message
          }

        \x1b[0m`);
      }
    }

    async function executeNodeViaAI(code) {
      canvasTerminal.writeln('\x1b[33mNode.js AI ile calistiriliyor...\x1b[0m');

      try {
        const r = await puter.ai.chat([{
          role: 'system', content: 'Sen bir Node.js yorumlayicisisin. Verilen kodu calistir ve sadece ciktisini (output) ver. Aciklama yapma, sadece kodun uretecegi ciktiyi goster. Eger kod bir sunucu olusturuyorsa, baslatma mesajini goster. Eger hata varsa hata mesajini goster.'
        }

          ,
        {
          role: 'user', content: `Bu Node.js kodunu calistir ve ciktisini ver:\n\`\`\`javascript\n${code
            }

          \n\`\`\``
        }

        ], {
          model: 'gpt-4o-mini'
        });
        const out = (r?.message?.content || r?.content || '').replace(/```[\s\S]*?```/g, '').trim();
        if (out) canvasTerminal.writeln(out);
        else canvasTerminal.writeln('\x1b[90m(cikti yok)\x1b[0m');
      }

      catch (e) {
        canvasTerminal.writeln(`\x1b[31mHata: ${e.message
          }

        \x1b[0m`);
      }
    }

    async function executeNpmViaAI(cmd) {
      canvasTerminal.writeln(`\x1b[33mnpm ${cmd
        }

        - AI ile simule ediliyor...\x1b[0m`);

      try {
        const r = await puter.ai.chat([{
          role: 'system', content: 'npm komutlarinin ciktisini simule et. Gercekci terminal ciktisi ver.'
        }

          ,
        {
          role: 'user', content: `npm ${cmd
            }

          `
        }

        ], {
          model: 'gpt-4o-mini'
        });
        canvasTerminal.writeln((r?.message?.content || '').replace(/```[\s\S]*?```/g, '').trim());
      }

      catch (e) {
        canvasTerminal.writeln(`\x1b[31mHata: ${e.message
          }

        \x1b[0m`);
      }
    }

    // ---- Multi-Model Comparison
    function getCompareModelsHtml() {
      const prov = providerSettings.active || 'puter';
      let models = [];

      if (prov === 'puter') {
        models = availableModels.length > 0 ? availableModels : [{
          id: 'gpt-4o-mini'
        }

          , {
          id: 'gpt-4o'
        }

          , {
          id: 'claude-3-5-sonnet'
        }

        ];
      }

      else if (prov === 'custom') {
        if (customModels.length > 0) models = customModels;

        else {
          const mId = providerSettings.custom?.modelId || 'gpt-4o'; models = [{
            id: mId, name: mId
          }

          ];
        }
      }

      else if (prov === 'anthropic') {
        const mId = providerSettings.anthropic?.modelId || 'claude-3-5-sonnet-20241022';

        models = [{
          id: mId
        }

          , {
          id: 'claude-3-5-sonnet-20241022', name: 'claude-3-5-sonnet'
        }

          , {
          id: 'claude-3-opus-20240229', name: 'claude-3-opus'
        }

          , {
          id: 'claude-3-haiku-20240307', name: 'claude-3-haiku'
        }

        ];
      }

      // Remove duplicates
      const seen = new Set();

      models = models.filter(m => {
        if (seen.has(m.id)) return false; seen.add(m.id); return true;
      });

      return models.map(m => `<option value="${escapeHtml(m.id)}" >${escapeHtml(m.name || m.id)
        }

      </option>`).join('');
    }

    function openCompareMode() {
      if (compareActive) {
        exitCompareMode(); return;
      }

      compareActive = true;
      compareMessagesA = [];
      compareMessagesB = [];
      // Hide normal chat, show compare panels
      $('chat-window').classList.add('hidden');
      $('compare-live').classList.remove('hidden');
      $('compare-live-chat-a').innerHTML = '';
      $('compare-live-chat-b').innerHTML = '';
      // Populate model selects with correct provider models
      const modelsHtml = getCompareModelsHtml();
      $('compare-live-model-a').innerHTML = modelsHtml;
      $('compare-live-model-b').innerHTML = modelsHtml;
      // Set B to second model if available
      const optsB = $('compare-live-model-b').options;
      if (optsB.length > 1) optsB[1].selected = true;
      // Show welcome in both panels
      const welcomeHtml = '<div class="flex flex-col items-center justify-center h-full text-center opacity-50"><div class="text-2xl mb-2"></div><div class="text-xs text-neutral-500">Karsilastirma modu aktif<br>Prompt gonderdiginizde iki model ayni anda yanitlayacak</div></div>';
      $('compare-live-chat-a').innerHTML = welcomeHtml;
      $('compare-live-chat-b').innerHTML = welcomeHtml;

      // Update button style
      document.querySelectorAll('[onclick="openCompareMode()"]').forEach(btn => {
        btn.classList.add('text-orange-400');
        btn.classList.remove('text-neutral-500');
      });
      setStatus('Karsilastirma modu aktif');
    }

    function exitCompareMode() {
      compareActive = false;
      compareMessagesA = [];
      compareMessagesB = [];
      $('chat-window').classList.remove('hidden');
      $('compare-live').classList.add('hidden');

      // Reset button style
      document.querySelectorAll('[onclick="openCompareMode()"]').forEach(btn => {
        btn.classList.remove('text-orange-400');
        btn.classList.add('text-neutral-500');
      });
      setStatus('Normal mod');
    }

    function renderCompareMessage(panelId, role, content) {
      const panel = $(panelId);
      // Remove welcome message on first real message
      if (panel.querySelector('.opacity-50')) panel.innerHTML = '';

      if (role === 'user') {
        const div = document.createElement('div');
        div.className = 'compare-live-msg-user animate-in';

        div.innerHTML = `<div>${escapeHtml(content)
          }

        </div>`;
        panel.appendChild(div);
      }

      else {
        const div = document.createElement('div');
        div.className = 'compare-live-msg-ai animate-in';
        let html = content;

        try {
          if (typeof marked !== 'undefined') html = marked.parse(content);
        }

        catch (e) { }

        div.innerHTML = `<div class="prose text-neutral-300" >${html
          }

        </div>`;
        panel.appendChild(div);
      }

      panel.scrollTop = panel.scrollHeight;
    }

    function showCompareTyping(panelId) {
      const panel = $(panelId);
      if (panel.querySelector('.opacity-50')) panel.innerHTML = '';
      const div = document.createElement('div');
      div.className = 'compare-live-typing animate-in';
      div.id = panelId + '-typing';
      div.innerHTML = '<div class="w-1.5 h-1.5 bg-blue-500 rounded-full dot-pulse"></div><div class="w-1.5 h-1.5 bg-blue-500 rounded-full dot-pulse"></div><div class="w-1.5 h-1.5 bg-blue-500 rounded-full dot-pulse"></div>';
      panel.appendChild(div);
      panel.scrollTop = panel.scrollHeight;
    }

    function removeCompareTyping(panelId) {
      const el = $(panelId + '-typing');
      if (el) el.remove();
    }

    async function handleCompareSend(text) {
      const modelA = $('compare-live-model-a').value;
      const modelB = $('compare-live-model-b').value;
      const activeProv = providerSettings.active || 'puter';
      // Show user message in both panels
      renderCompareMessage('compare-live-chat-a', 'user', text);
      renderCompareMessage('compare-live-chat-b', 'user', text);

      // Add to history
      compareMessagesA.push({
        role: 'user', content: text
      });

      compareMessagesB.push({
        role: 'user', content: text
      });
      // Show typing indicators
      showCompareTyping('compare-live-chat-a');
      showCompareTyping('compare-live-chat-b');

      const sys = buildSystemPrompt() || "Sen yardimci bir asistansin.";

      const historyA = [{
        role: 'system', content: sys
      }

        , ...compareMessagesA];

      const historyB = [{
        role: 'system', content: sys
      }

        , ...compareMessagesB];

      // Determine call function based on provider
      const callFn = activeProv === 'custom' ? callCustomRouter : activeProv === 'anthropic' ? callAnthropicRouter : callPuterOnce;

      // Run both in parallel
      const promiseA = callFn(modelA, historyA).then(r => {
        removeCompareTyping('compare-live-chat-a');

        compareMessagesA.push({
          role: 'assistant', content: r
        });
        renderCompareMessage('compare-live-chat-a', 'assistant', r);

      }).catch(e => {
        removeCompareTyping('compare-live-chat-a');

        renderCompareMessage('compare-live-chat-a', 'assistant', `Hata: ${e.message
          }

          `);
      });

      const promiseB = callFn(modelB, historyB).then(r => {
        removeCompareTyping('compare-live-chat-b');

        compareMessagesB.push({
          role: 'assistant', content: r
        });
        renderCompareMessage('compare-live-chat-b', 'assistant', r);

      }).catch(e => {
        removeCompareTyping('compare-live-chat-b');

        renderCompareMessage('compare-live-chat-b', 'assistant', `Hata: ${e.message
          }

          `);
      });

      await Promise.allSettled([promiseA, promiseB]);
      playNotificationSound();
    }

    // Legacy modal functions (kept for backward compat)
    function closeCompareModal() {
      const m = $('compare-modal'), c = m.querySelector('div');
      m.classList.add('opacity-0'); c.classList.add('scale-95');
      setTimeout(() => m.classList.add('hidden'), 200);
    }

    function closeCompareResults() {
      $('compare-results')?.classList.add('hidden');
    }

    async function runComparison() {
      const modelA = $('compare-model-a').value;
      const modelB = $('compare-model-b').value;
      const prompt = $('compare-prompt').value.trim();

      if (!prompt) {
        alert('Prompt gerekli.'); return;
      }

      closeCompareModal();

      const resultsEl = $('compare-results');
      resultsEl.classList.remove('hidden');
      $('compare-label-a').textContent = modelA;
      $('compare-label-b').textContent = modelB;
      $('compare-output-a').innerHTML = '<div class="flex items-center gap-2 text-neutral-600"><div class="w-1.5 h-1.5 bg-blue-500 rounded-full dot-pulse"></div> Uretiliyor...</div>';
      $('compare-output-b').innerHTML = '<div class="flex items-center gap-2 text-neutral-600"><div class="w-1.5 h-1.5 bg-purple-500 rounded-full dot-pulse"></div> Uretiliyor...</div>';
      $('compare-time-a').textContent = '';
      $('compare-time-b').textContent = '';

      const sys = buildSystemPrompt() || "Sen yardimci bir asistansin.";

      const history = [{
        role: 'system', content: sys
      }

        , {
        role: 'user', content: prompt
      }

      ];

      const startA = Date.now();
      const startB = Date.now();

      const promiseA = callPuterOnce(modelA, history).then(r => {
        const elapsed = ((Date.now() - startA) / 1000).toFixed(1);
        $('compare-time-a').textContent = elapsed + 's';
        let html = r;

        try {
          if (typeof marked !== 'undefined') html = marked.parse(r);
        }

        catch (e) { }

        $('compare-output-a').innerHTML = html;

      }).catch(e => {
        $('compare-output-a').innerHTML = `<span class="text-red-400" >Hata: ${escapeHtml(e.message)
          }

        </span>`;
      });

      const promiseB = callPuterOnce(modelB, history).then(r => {
        const elapsed = ((Date.now() - startB) / 1000).toFixed(1);
        $('compare-time-b').textContent = elapsed + 's';
        let html = r;

        try {
          if (typeof marked !== 'undefined') html = marked.parse(r);
        }

        catch (e) { }

        $('compare-output-b').innerHTML = html;

      }).catch(e => {
        $('compare-output-b').innerHTML = `<span class="text-red-400" >Hata: ${escapeHtml(e.message)
          }

        </span>`;
      });

      await Promise.allSettled([promiseA, promiseB]);
      playNotificationSound();
    }

    // ---- Chat Search
    function toggleChatSearch() {
      const bar = $('chat-search-bar');

      if (bar.classList.contains('hidden')) {
        bar.classList.remove('hidden');
        $('chat-search-input')?.focus();
      }

      else {
        bar.classList.add('hidden');
        $('chat-search-input').value = '';
        clearSearchHighlights();
      }
    }

    function searchInChat(query) {
      clearSearchHighlights();

      if (!query || query.length < 2) {
        $('chat-search-count').textContent = ''; return;
      }

      const win = $('chat-window');
      const walker = document.createTreeWalker(win, NodeFilter.SHOW_TEXT);
      let count = 0;
      const q = query.toLowerCase();

      while (walker.nextNode()) {
        const node = walker.currentNode;

        if (node.textContent.toLowerCase().includes(q)) {
          const parent = node.parentElement;

          if (parent && !parent.classList.contains('search-hl')) {
            const html = parent.innerHTML;

            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            parent.innerHTML = html.replace(regex, '<mark class="search-hl" style="background:#f59e0b;color:#000;border-radius:2px;padding:0 2px">$1</mark>');
            count += (parent.innerHTML.match(regex) || []).length;
          }
        }
      }

      $('chat-search-count').textContent = count > 0 ? count + ' sonuc' : 'yok';
      const firstMark = win.querySelector('.search-hl');

      if (firstMark) firstMark.scrollIntoView({
        behavior: 'smooth', block: 'center'
      });
    }

    function clearSearchHighlights() {
      document.querySelectorAll('.search-hl').forEach(m => {
        const parent = m.parentNode;
        parent.replaceChild(document.createTextNode(m.textContent), m);
        parent.normalize();
      });
    }

    // ---- Bookmarks
    function toggleBookmark(idx) {
      const key = currentChatId + '-' + idx;
      const i = bookmarks.indexOf(key);
      if (i >= 0) bookmarks.splice(i, 1); else bookmarks.push(key);
      localStorage.setItem('ai_bookmarks', JSON.stringify(bookmarks));
      const chat = chats.find(c => c.id === currentChatId);
      if (chat) renderMessages(chat.messages);
    }

    // ---- Clipboard Paste
    function initClipboardPaste() {
      document.addEventListener('paste', async e => {
        const items = Array.from(e.clipboardData?.items || []);
        const imageItem = items.find(i => i.type.startsWith('image/'));

        if (imageItem) {
          e.preventDefault();
          const file = imageItem.getAsFile();
          if (!file) return;

          const fd = {
            id: Date.now() + Math.random(), name: 'clipboard-' + Date.now() + '.png', type: file.type, file, size: (file.size / 1024 / 1024).toFixed(2) + ' MB'
          }

            ;
          fd.preview = await readFileAsDataURL(file);
          selectedFiles.push(fd);
          renderFilePreviews();
          setStatus('Resim yapistirild.');
        }
      });
    }

    // ---- Notification Sound
    function playNotificationSound() {
      if (!prefs.notifySound) return;

      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.setValueAtTime(800, ctx.currentTime);
        osc.frequency.setValueAtTime(1000, ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);
      }

      catch (e) { }
    }

    // ---- Import Chat
    function importChatFromFile() {
      const inp = document.createElement('input');
      inp.type = 'file'; inp.accept = '.json';

      inp.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const data = JSON.parse(text);

          if (Array.isArray(data)) {
            data.forEach(c => {
              c.id = Date.now() + Math.random(); chats.push(c);
            });
          }

          else if (data.messages) {
            data.id = Date.now() + Math.random();
            chats.push(data);
          }

          saveAll(); renderChatList();
          setStatus('Sohbet ice aktarildi.');
        }

        catch (err) {
          alert('JSON formati hatali: ' + err.message);
        }
      }

        ;
      inp.click();
    }

    // ---- Stats
    function openStatsModal() {
      const m = $('stats-modal'), c = m.querySelector('div');
      m.classList.remove('hidden');

      setTimeout(() => {
        m.classList.remove('opacity-0'); c.classList.remove('scale-95');
      }

        , 10);
      let totalMsgs = 0, totalWords = 0, totalChats = chats.length, totalTokens = 0;

      chats.forEach(ch => {
        ch.messages.forEach(msg => {
          totalMsgs++;
          const text = typeof msg.content === 'string' ? msg.content : '';
          totalWords += text.split(/\s+/).filter(Boolean).length;
          totalTokens += Math.ceil(text.length / 4);
        });
      });

      $('stats-content').innerHTML = ` <div class="flex justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222]" > <span class="text-sm text-neutral-400" >Toplam Sohbet</span><span class="text-sm font-bold text-white" >${totalChats
        }

      </span> </div> <div class="flex justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222]" > <span class="text-sm text-neutral-400" >Toplam Mesaj</span><span class="text-sm font-bold text-white" >${totalMsgs
        }

      </span> </div> <div class="flex justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222]" > <span class="text-sm text-neutral-400" >Toplam Kelime</span><span class="text-sm font-bold text-white" >${totalWords.toLocaleString()
        }

      </span> </div> <div class="flex justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222]" > <span class="text-sm text-neutral-400" >Tahmini Token</span><span class="text-sm font-bold text-white" >${totalTokens.toLocaleString()
        }

      </span> </div> <div class="flex justify-between p-3 bg-white/[0.02] rounded-xl border border-[#222]" > <span class="text-sm text-neutral-400" >Yer Imleri</span><span class="text-sm font-bold text-white" >${bookmarks.length
        }

      </span> </div> `;
    }

    function closeStatsModal() {
      const m = $('stats-modal'), c = m.querySelector('div');
      m.classList.add('opacity-0'); c.classList.add('scale-95');
      setTimeout(() => m.classList.add('hidden'), 200);
    }

    // ---- Accent Color
    function setAccent(color) {
      document.body.classList.remove('accent-green', 'accent-purple', 'accent-red', 'accent-amber', 'accent-cyan');
      if (color !== 'blue') document.body.classList.add('accent-' + color);
      prefs.accent = color;
      saveAll();
      updateAccentButtons(color);
    }

    function updateAccentButtons(color) {
      document.querySelectorAll('[data-accent-color]').forEach(btn => {
        const c = btn.dataset.accentColor;
        const active = c === color;
        btn.style.outline = active ? '2px solid white' : '';
        btn.style.outlineOffset = active ? '2px' : '';
        btn.style.transform = active ? 'scale(1.2)' : '';
      });
    }

    // ---- Text Selection Context Menu
    function initSelectionMenu() {
      document.addEventListener('mouseup', e => {
        const sel = window.getSelection();
        const text = sel?.toString().trim();

        if (text && text.length > 3 && $('chat-window')?.contains(sel.anchorNode)) {
          const menu = $('selection-menu');
          menu.classList.remove('hidden');
          menu.style.left = Math.min(e.clientX, window.innerWidth - 220) + 'px';
          menu.style.top = (e.clientY - 44) + 'px';
          menu.dataset.text = text;
        }

        else {
          hideSelectionMenu();
        }
      });
    }

    function hideSelectionMenu() {
      $('selection-menu')?.classList.add('hidden');
    }

    function selectionAction(action) {
      const text = $('selection-menu')?.dataset.text;
      hideSelectionMenu();
      if (!text) return;
      const inp = $('user-input');

      if (action === 'copy') {
        navigator.clipboard.writeText(text); setStatus('Kopyalandi.'); return;
      }

      const prompts = {
        translate: 'Bu metni Ingilizceye cevir: ', explain: 'Bu metni acikla: ', summarize: 'Bu metni ozetle: '
      }

        ;
      inp.value = (prompts[action] || '') + '"' + text.substring(0, 500) + '"';
      inp.focus();
      handleSend();
    }

    // ---- Event Listeners
    $('new-chat-btn')?.addEventListener('click', createNewChat);
    $('settings-btn')?.addEventListener('click', openSettings);
    $('reset-btn')?.addEventListener('click', clearAllData);
    $('send-btn')?.addEventListener('click', handleSend);
    $('stop-btn')?.addEventListener('click', stopGeneration);
    $('upload-btn')?.addEventListener('click', () => $('file-input').click());
    $('screen-capture-btn')?.addEventListener('click', handleScreenCapture);
    $('ocr-btn')?.addEventListener('click', toggleOcr);
    $('file-input')?.addEventListener('change', handleFileSelect);
    $('export-chat-btn')?.addEventListener('click', openExportModal);

    $('user-input')?.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); handleSend();
      }
    });

    const tx = $('user-input');

    if (tx) {
      tx.addEventListener('input', function () {
        this.style.height = 'auto';
        const h = Math.min(this.scrollHeight, 192);
        this.style.height = h + 'px';
        this.style.overflowY = this.scrollHeight > 192 ? 'auto' : 'hidden';
      });
    }

    $('provider-select')?.addEventListener('change', updateProviderFields);

    $('preconfigured-urls')?.addEventListener('change', async e => {
      const val = e.target.value;

      if (val && PRECONFIGURED_PROVIDERS[val]) {
        $('custom-url').value = PRECONFIGURED_PROVIDERS[val]; await manualFetchCustomModels(e.target);
      }
    });

    // ---- Canvas / Artifact System
    let canvasFiles = {}

      ;
    let canvasHistory = [];
    let canvasHistoryIndex = -1;
    let canvasActiveFile = null;
    let canvasOpen = false;

    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();

      const map = {
        'html': ['S', 'ft-icon-html'], 'htm': ['S', 'ft-icon-html'],
        'css': ['#', 'ft-icon-css'],
        'js': ['JS', 'ft-icon-js'], 'mjs': ['JS', 'ft-icon-js'],
        'ts': ['TS', 'ft-icon-ts'],
        'tsx': ['TX', 'ft-icon-tsx'], 'jsx': ['TX', 'ft-icon-tsx'],
        'json': ['{}', 'ft-icon-json'],
        'py': ['Py', 'ft-icon-py'],
        'cpp': ['C+', 'ft-icon-cpp'], 'cc': ['C+', 'ft-icon-cpp'], 'cxx': ['C+', 'ft-icon-cpp'],
        'c': ['C', 'ft-icon-c'],
        'h': ['H', 'ft-icon-h'], 'hpp': ['H+', 'ft-icon-hpp'],
        'java': ['Jv', 'ft-icon-java'],
        'rs': ['Rs', 'ft-icon-rs'],
        'go': ['Go', 'ft-icon-go'],
        'rb': ['Rb', 'ft-icon-rb'],
        'php': ['Ph', 'ft-icon-php'],
        'sh': ['Sh', 'ft-icon-sh'], 'bash': ['Sh', 'ft-icon-sh'],
        'md': ['M', 'ft-icon-md'],
        'txt': ['Tx', 'ft-icon-default'],
      }

        ;
      return map[ext] || [ext.substring(0, 2).toUpperCase(), 'ft-icon-default'];
    }

    function updateCanvasToggleBtn() {
      const btn = $('canvas-toggle-btn');
      if (!btn) return;
      const hasFiles = Object.keys(canvasFiles).length > 0;
      btn.classList.toggle('hidden', !hasFiles && !canvasOpen);
      btn.classList.toggle('text-teal-400', canvasOpen);
      btn.classList.toggle('bg-teal-500/10', canvasOpen);
      btn.classList.toggle('text-neutral-500', !canvasOpen);
    }

    function toggleCanvasPanel() {
      if (canvasOpen) {
        closeCanvas();
      } else if (Object.keys(canvasFiles).length > 0) {
        openCanvas();
        renderCanvasFileTree();
        const htmlFile = Object.keys(canvasFiles).find(f => f.endsWith('.html'));
        if (htmlFile) { selectCanvasFile(htmlFile); updateCanvasPreview(canvasFiles[htmlFile]); switchCanvasTab('preview'); }
        else if (canvasActiveFile) selectCanvasFile(canvasActiveFile);
      } else {
        setStatus('Canvas icerigi yok.');
      }
    }

    function openCanvas() {
      const panel = $('canvas-panel');
      const headerTabs = $('header-canvas-tabs');
      const headerActionBtns = $('header-action-btns');
      panel.classList.remove('hidden');

      if (headerTabs) {
        headerTabs.classList.remove('hidden'); headerTabs.style.display = 'flex';
      }

      if (headerActionBtns) {
        headerActionBtns.style.display = 'none';
      }

      canvasOpen = true;
      updateCanvasToggleBtn();
    }

    function closeCanvas() {
      const panel = $('canvas-panel');
      const headerTabs = $('header-canvas-tabs');
      const headerActionBtns = $('header-action-btns');
      panel.classList.add('hidden');

      if (headerTabs) {
        headerTabs.classList.add('hidden'); headerTabs.style.display = '';
      }

      if (headerActionBtns) {
        headerActionBtns.style.display = '';
      }

      canvasOpen = false;
      const curChat = chats.find(x => x.id === currentChatId);
      if (curChat && Object.keys(canvasFiles).length > 0) {
        curChat.canvas = JSON.parse(JSON.stringify(canvasFiles));
        saveAll();
      }
      updateCanvasToggleBtn();
    }

    function switchCanvasTab(tab) {
      const previewTab = $('canvas-tab-preview');
      const codeTab = $('canvas-tab-code');
      const terminalTab = $('canvas-tab-terminal');
      const diffTab = $('canvas-tab-diff');
      const previewView = $('canvas-preview-view');
      const codeView = $('canvas-code-view');
      const terminalView = $('canvas-terminal-view');
      const diffView = $('canvas-diff-view');
      const headerPreview = $('header-canvas-preview');
      const headerCode = $('header-canvas-code');
      const headerTerminal = $('header-canvas-terminal');
      const headerDiff = $('header-canvas-diff');

      [previewTab, codeTab, terminalTab, diffTab, headerPreview, headerCode, headerTerminal, headerDiff].forEach(el => el?.classList.remove('active'));
      [previewView, codeView, terminalView, diffView].forEach(el => el?.classList.add('hidden'));

      if (tab === 'preview') {
        previewTab?.classList.add('active');
        headerPreview?.classList.add('active');
        previewView?.classList.remove('hidden');
      } else if (tab === 'terminal') {
        terminalTab?.classList.add('active');
        headerTerminal?.classList.add('active');
        terminalView?.classList.remove('hidden');
        initCanvasTerminal();
        if (canvasTerminalFit) setTimeout(() => canvasTerminalFit.fit(), 50);
      } else if (tab === 'diff') {
        diffTab?.classList.add('active');
        headerDiff?.classList.add('active');
        diffView?.classList.remove('hidden');
        renderCanvasDiff();
      } else {
        codeTab?.classList.add('active');
        headerCode?.classList.add('active');
        codeView?.classList.remove('hidden');
      }
    }

    function computeLineDiff(oldText, newText) {
      const oldLines = oldText.split('\n');
      const newLines = newText.split('\n');
      const result = [];
      let oi = 0, ni = 0;
      while (oi < oldLines.length || ni < newLines.length) {
        if (oi >= oldLines.length) {
          result.push({ type: 'add', line: newLines[ni++] });
        } else if (ni >= newLines.length) {
          result.push({ type: 'del', line: oldLines[oi++] });
        } else if (oldLines[oi] === newLines[ni]) {
          result.push({ type: 'same', line: oldLines[oi] });
          oi++; ni++;
        } else {
          const lookAhead = 6;
          let found = false;
          for (let d = 1; d <= lookAhead && !found; d++) {
            if (ni + d < newLines.length && oldLines[oi] === newLines[ni + d]) {
              for (let k = 0; k < d; k++) result.push({ type: 'add', line: newLines[ni + k] });
              ni += d; found = true;
            } else if (oi + d < oldLines.length && newLines[ni] === oldLines[oi + d]) {
              for (let k = 0; k < d; k++) result.push({ type: 'del', line: oldLines[oi + k] });
              oi += d; found = true;
            }
          }
          if (!found) {
            result.push({ type: 'del', line: oldLines[oi++] });
            result.push({ type: 'add', line: newLines[ni++] });
          }
        }
      }
      return result;
    }

    function renderCanvasDiff() {
      const container = $('canvas-diff-content');
      if (!container) return;
      if (canvasHistoryIndex <= 0 || canvasHistory.length < 2) {
        container.innerHTML = '<div style="color:#8b949e;text-align:center;padding:40px 0;">Diff gormek icin onceki bir versiyon olmalidir.<br>Kodu degistirdikten sonra Diff tabina gecin.</div>';
        return;
      }
      const prevFiles = canvasHistory[canvasHistoryIndex - 1];
      const currFiles = canvasHistory[canvasHistoryIndex];
      const allFiles = new Set([...Object.keys(prevFiles), ...Object.keys(currFiles)]);
      let html = '';
      allFiles.forEach(fname => {
        const oldText = prevFiles[fname] || '';
        const newText = currFiles[fname] || '';
        if (oldText === newText) return;
        const diff = computeLineDiff(oldText, newText);
        let fileHtml = '';
        let lineOld = 1, lineNew = 1;
        diff.forEach(d => {
          const esc = d.line.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          if (d.type === 'same') {
            fileHtml += `<div style="color:#8b949e;padding:0 4px;white-space:pre;display:flex;gap:4px"><span style="min-width:44px;color:#444;user-select:none;flex-shrink:0;text-align:right;padding-right:4px">${lineOld++}</span><span style="min-width:44px;color:#444;user-select:none;flex-shrink:0;text-align:right;padding-right:8px">${lineNew++}</span><span>${esc}</span></div>`;
          } else if (d.type === 'add') {
            fileHtml += `<div style="background:#0d2818;color:#3fb950;padding:0 4px;white-space:pre;display:flex;gap:4px"><span style="min-width:44px;color:#1e4d32;user-select:none;flex-shrink:0;text-align:right;padding-right:4px"> </span><span style="min-width:44px;color:#1e4d32;user-select:none;flex-shrink:0;text-align:right;padding-right:8px">${lineNew++}</span><span style="color:#3fb950">+ ${esc}</span></div>`;
          } else {
            fileHtml += `<div style="background:#2d1117;color:#f85149;padding:0 4px;white-space:pre;display:flex;gap:4px"><span style="min-width:44px;color:#6b2226;user-select:none;flex-shrink:0;text-align:right;padding-right:4px">${lineOld++}</span><span style="min-width:44px;color:#6b2226;user-select:none;flex-shrink:0;text-align:right;padding-right:8px"> </span><span style="color:#f85149">- ${esc}</span></div>`;
          }
        });
        html += `<div style="margin-bottom:16px;min-width:max-content">
          <div style="background:#161b22;border:1px solid #30363d;border-radius:8px 8px 0 0;padding:7px 12px;font-size:11px;color:#8b949e;display:flex;align-items:center;gap:8px">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#8b949e" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
            <span style="color:#e6edf3;font-weight:600">${fname}</span>
          </div>
          <div style="border:1px solid #30363d;border-top:none;border-radius:0 0 8px 8px;overflow:hidden">${fileHtml || '<div style="padding:8px;color:#8b949e">Fark yok</div>'}</div>
        </div>`;
      });
      container.innerHTML = html || '<div style="color:#8b949e;text-align:center;padding:40px 0;">Bu versiyon ile onceki arasinda fark bulunamadi.</div>';
    }

    function buildCanvasPreviewHtml(htmlContent) {
      const cssFiles = Object.keys(canvasFiles).filter(f => f.endsWith('.css'));
      const jsFiles = Object.keys(canvasFiles).filter(f => f.endsWith('.js'));
      const cssContent = cssFiles.map(f => `\n

        /* ${f} */
        \n${canvasFiles[f] || ''
        }

        `).join('\n');
      const jsContent = jsFiles.map(f => `\n // ${f}\n${canvasFiles[f] || ''}`).join('\n');

      let html = htmlContent || '';

      // Remove external CSS/JS references that point to local project files (won't work in srcdoc)
      if (cssFiles.length > 0) {
        cssFiles.forEach(f => {
          const fname = f.split('/').pop();
          const linkRegex = new RegExp(`<link[^>]*href=["'](?:\\.?\\/?)${fname.replace('.', '\\.')}[" '][^>]*>`, ' gi');
          html = html.replace(linkRegex, '');
        });
      }

      if (jsFiles.length > 0) {
        jsFiles.forEach(f => {
          const fname = f.split('/').pop();
          const scriptRegex = new RegExp(`<script[^>]*src=["'](?:\\.?\\/?)${fname.replace('.', '\\.')}[" '][^>]*>\\s*<\\/script>`, ' gi');
          html = html.replace(scriptRegex, '');
        });
      }

      const hasHtml = /<html[\s>]/i.test(html);
      const hasHead = /<head[\s>]/i.test(html);
      const hasBody = /<body[\s>]/i.test(html);

      const styleTag = cssContent ? `<style>${cssContent
        }
  </style>` : '';
      const scriptTag = jsContent ? `
  <script>${jsContent}<\/script>` : '';

      if (!hasHtml) {
        html = `<!DOCTYPE html><html><head><meta charset="UTF-8">${styleTag}</head><body>${html}${scriptTag}</body></html>`;
        return html;
      }

      if (styleTag) {
        if (hasHead) html = html.replace(/<\/head>/i, `${styleTag}</head>`);
        else html = html.replace(/<html[^>]*>/i, match => `${match}<head>${styleTag}</head>`);
      }

      if (scriptTag) {
        if (hasBody) html = html.replace(/<\/body>/i, `${scriptTag}</body>`);
        else html = html.replace(/<\/html>/i, `${scriptTag}</html>`);
      }

      return html;
    }


    function renderCanvasFileTree() {
      const tree = $('canvas-file-tree');
      if (!tree) return;
      tree.innerHTML = '<div class="ft-title">Files</div>';

      // Group files by folder
      const folders = {};
      const rootFiles = [];
      Object.keys(canvasFiles).forEach(path => {
        if (path.includes('/')) {
          const parts = path.split('/');
          const folder = parts[0];
          if (!folders[folder]) folders[folder] = [];
          folders[folder].push(path);
        } else {
          rootFiles.push(path);
        }
      });

      // Render folders
      Object.keys(folders).sort().forEach(folder => {
        const folderEl = document.createElement('div');
        folderEl.className = 'canvas-file-item folder';
        folderEl.innerHTML = `<span class="canvas-file-icon ft-icon-folder">&#128193;</span><span>${escapeHtml(folder)}</span>`;
        tree.appendChild(folderEl);

        folders[folder].sort().forEach(path => {
          const filename = path.split('/').pop();
          const [iconText, iconClass] = getFileIcon(filename);
          const el = document.createElement('div');
          el.className = `canvas-file-item${path === canvasActiveFile ? ' active' : ''}`;
          el.style.paddingLeft = '32px';
          el.innerHTML = `<span class="canvas-file-icon ${iconClass}">${iconText}</span><span>${escapeHtml(filename)}</span>`;
          el.onclick = () => selectCanvasFile(path);
          tree.appendChild(el);
        });
      });

      // Root files
      rootFiles.sort().forEach(path => {
        const [iconText, iconClass] = getFileIcon(path);
        const el = document.createElement('div');
        el.className = `canvas-file-item${path === canvasActiveFile ? ' active' : ''}`;
        el.innerHTML = `<span class="canvas-file-icon ${iconClass}">${iconText}</span><span>${escapeHtml(path)}</span>`;
        el.onclick = () => selectCanvasFile(path);
        tree.appendChild(el);
      });

      // Quick file buttons
      const quickFiles = $('canvas-quick-files');
      if (quickFiles) {
        const mainFiles = Object.keys(canvasFiles).filter(f => /\.(html|css|js|tsx|jsx|py|cpp|c|java|rs|go|json)$/.test(f)).slice(0, 5);
        quickFiles.innerHTML = mainFiles.map(f => {
          const [iconText, iconClass] = getFileIcon(f);
          return `<button class="canvas-quick-file" onclick="selectCanvasFile('${escapeJs(f)}'); switchCanvasTab('code')"><span class="canvas-file-icon ${iconClass}">${iconText}</span>${escapeHtml(f)}</button>`;
        }).join('');
      }
    }

    function selectCanvasFile(path) {
      canvasActiveFile = path;
      const code = canvasFiles[path] || '';
      const pre = $('canvas-code-pre');
      if (pre) pre.textContent = code;
      renderCanvasFileTree();

      // Update preview when any web file is selected
      const htmlFile = Object.keys(canvasFiles).find(f => f.endsWith('.html'));
      if (htmlFile) {
        updateCanvasPreview(canvasFiles[htmlFile]);
      }
    }

    function updateCanvasPreview(htmlContent) {
      const iframe = $('canvas-iframe');
      const empty = $('canvas-preview-empty');
      if (iframe && empty) {
        empty.classList.add('hidden');
        iframe.classList.remove('hidden');
        iframe.srcdoc = buildCanvasPreviewHtml(htmlContent);
      }
    }


    function openCanvasInNewTab() {
      const htmlFile = Object.keys(canvasFiles).find(f => f.endsWith('.html'));
      if (htmlFile) {
        // Build complete HTML with CSS/JS injected
        const fullHtml = buildCanvasPreviewHtml(canvasFiles[htmlFile]);
        const blob = new Blob([fullHtml], { type: 'text/html' });
        window.open(URL.createObjectURL(blob), '_blank');
      } else {
        // Non-web project: open first file as text
        const first = Object.keys(canvasFiles)[0];
        if (first) {
          const blob = new Blob([canvasFiles[first]], { type: 'text/plain' });
          window.open(URL.createObjectURL(blob), '_blank');
        }
      }
    }

    function downloadCanvasProject() {
      const files = Object.keys(canvasFiles);
      if (files.length === 0) return;
      if (files.length === 1) {
        const blob = new Blob([canvasFiles[files[0]]], { type: 'text/plain' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = files[0]; a.click();
      } else {
        // Download all files as individual downloads
        files.forEach(f => {
          const blob = new Blob([canvasFiles[f]], { type: 'text/plain' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = f; a.click();
        });
      }
    }

    // Extract code blocks from AI response and populate canvas
    function extractCanvasFromResponse(content) {
      const codeBlocks = [];
      const regex = /```(\w+)?\s*\n([\s\S]*?)```/g;
      let match;
      while ((match = regex.exec(content)) !== null) {
        const lang = (match[1] || '').toLowerCase();
        const code = match[2].trim();
        if (code.length > 10) { // Only non-trivial code blocks
          codeBlocks.push({ lang, code });
        }
      }

      if (codeBlocks.length === 0) return false;

      canvasFiles = {};
      let hasHtml = false;

      codeBlocks.forEach((block, idx) => {
        let filename;
        const ext = block.lang || 'txt';
        if (ext === 'html' || ext === 'htm') { filename = 'index.html'; hasHtml = true; }
        else if (ext === 'css') filename = 'index.css';
        else if (ext === 'javascript' || ext === 'js') filename = codeBlocks.length > 3 ? `src/main.js` : 'script.js';
        else if (ext === 'typescript' || ext === 'ts') filename = 'src/main.ts';
        else if (ext === 'tsx') filename = 'src/App.tsx';
        else if (ext === 'jsx') filename = 'src/App.jsx';
        else if (ext === 'python' || ext === 'py') filename = 'main.py';
        else if (ext === 'cpp' || ext === 'c++' || ext === 'cc' || ext === 'cxx') filename = canvasFiles['main.cpp'] ? `file_${idx}.cpp` : 'main.cpp';
        else if (ext === 'c') filename = canvasFiles['main.c'] ? `file_${idx}.c` : 'main.c';
        else if (ext === 'h' || ext === 'hpp') filename = `header${idx > 0 ? idx : ''}.${ext}`;
        else if (ext === 'java') filename = 'Main.java';
        else if (ext === 'rust' || ext === 'rs') filename = 'main.rs';
        else if (ext === 'go' || ext === 'golang') filename = 'main.go';
        else if (ext === 'ruby' || ext === 'rb') filename = 'main.rb';
        else if (ext === 'php') filename = 'index.php';
        else if (ext === 'bash' || ext === 'sh' || ext === 'shell') filename = 'script.sh';
        else if (ext === 'json') filename = idx === 0 ? 'package.json' : 'config.json';
        else filename = `file${idx > 0 ? idx : ''}.${ext}`;

        // Avoid duplicate names
        if (canvasFiles[filename]) filename = `${filename.split('.')[0]}_${idx}.${ext}`;
        canvasFiles[filename] = block.code;
      });

      // If there's a standalone HTML with full content, try to detect project structure
      if (hasHtml && codeBlocks.length >= 3) {
        // Check for React/Vite project patterns
        const hasReactLike = codeBlocks.some(b => b.code.includes('import React') || b.code.includes('createRoot') || b.code.includes('tsx'));
        if (hasReactLike) {
          // Reorganize
          const newFiles = {};
          Object.keys(canvasFiles).forEach(f => {
            if (!f.startsWith('src/') && !f.endsWith('.html') && !f.endsWith('.json')) {
              newFiles['src/' + f] = canvasFiles[f];
            } else {
              newFiles[f] = canvasFiles[f];
            }
          });
          canvasFiles = newFiles;
        }
      }

      if (!hasHtml && canvasFiles['main.py']) {
        hasHtml = true;
        const b64Code = btoa(unescape(encodeURIComponent(canvasFiles['main.py'] || '')));
        canvasFiles['index.html'] = `<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"><\/script>
</head>

<body style="background:#111; color:#fff; font-family:monospace; padding:16px;">
  <h3 style="color:#a855f7; margin-top:0;">Python Runner (Pyodide)</h3>
  <div id="output"
    style="white-space:pre-wrap; background:#000; padding:12px; border-radius:8px; border:1px solid #333;">Pyodide
    yukleniyor... Lutfen bekleyin.</div>
  <script>
    async function main() {
      const out = document.getElementById('output');
      try {
        let pyodide = await loadPyodide();
        out.innerText = "Script calistiriliyor...\\n\\n";
        pyodide.setStdout({ batched: (msg) => { out.innerText += msg + "\\n"; } });
        const code = decodeURIComponent(escape(atob("${b64Code}")));
        await pyodide.runPythonAsync(code);
        out.innerText += "\\n\\n[Bitti]";
      } catch(e) {
        out.innerText += '\\n\\nHATA:\\n' + e;
      }
    }
    main();
  <\/script>
</body>
</html>`;
      }

      if (canvasHistoryIndex < canvasHistory.length - 1) {
        canvasHistory = canvasHistory.slice(0, canvasHistoryIndex + 1);
      }
      canvasHistory.push(JSON.parse(JSON.stringify(canvasFiles)));
      canvasHistoryIndex++;
      updateCanvasHistoryUI();

      syncToLocalFolder();
      return true;
    }

    function updateCanvasHistoryUI() {
      const btnBack = document.getElementById('canvas-hist-back');
      const btnFwd = document.getElementById('canvas-hist-fwd');
      if (btnBack) btnBack.disabled = canvasHistoryIndex <= 0;
      if (btnFwd) btnFwd.disabled = canvasHistoryIndex >= canvasHistory.length - 1;

      if (btnBack) btnBack.style.opacity = canvasHistoryIndex <= 0 ? '0.3' : '1';
      if (btnFwd) btnFwd.style.opacity = canvasHistoryIndex >= canvasHistory.length - 1 ? '0.3' : '1';
    }

    function undoCanvas() {
      if (canvasHistoryIndex > 0) {
        canvasHistoryIndex--;
        canvasFiles = JSON.parse(JSON.stringify(canvasHistory[canvasHistoryIndex]));
        updateCanvasHistoryUI();
        finalizeCanvas('', true);
      }
    }

    function redoCanvas() {
      if (canvasHistoryIndex < canvasHistory.length - 1) {
        canvasHistoryIndex++;
        canvasFiles = JSON.parse(JSON.stringify(canvasHistory[canvasHistoryIndex]));
        updateCanvasHistoryUI();
        finalizeCanvas('', true);
      }
    }

    async function deployCanvasProject() {
      if (!puter.auth.isSignedIn()) {
        alert("Yayina almak icin ayarlardan Puter ile giris yapmalisiniz.");
        return;
      }
      const files = Object.keys(canvasFiles);
      if (files.length === 0) return;

      const btn = document.getElementById('deploy-canvas-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Yayinlaniyor...`;
      btn.disabled = true;

      try {
        const siteName = "app-" + Math.random().toString(36).substr(2, 6);
        const dir = await puter.fs.mkdir(siteName);
        for (const f of files) {
          await puter.fs.write(`${siteName}/${f}`, canvasFiles[f]);
        }
        const site = await puter.hosting.create(siteName, siteName);

        btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Yayinlandi`;
        setTimeout(() => {
          window.open(`https://${site.subdomain}.puter.site`, '_blank');
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 1500);
      } catch (e) {
        console.error("Deploy Hatasi:", e);
        alert("Yayinlama basarisiz: " + e.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    async function connectLocalFolder() {
      try {
        if (!window.showDirectoryPicker) {
          alert('Tarayiciniz File System Access API desteklemiyor (Chrome/Edge kullanin).');
          return;
        }
        window.localDirectoryHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
        setStatus('Klasor baglandi: ' + window.localDirectoryHandle.name);
        syncToLocalFolder(); // sync immediately if there are files
      } catch (e) { setStatus('Klasor secilmedi.'); }
    }

    async function syncToLocalFolder() {
      if (!window.localDirectoryHandle || !canvasFiles) return;
      try {
        let savedItems = 0;
        for (const [name, content] of Object.entries(canvasFiles)) {
          // Basic path sanitizer for flat structure support
          const safeName = name.replace(/\\\//g, '_').replace(/\\\\/g, '_');
          const fh = await window.localDirectoryHandle.getFileHandle(safeName, { create: true });
          const writable = await fh.createWritable();
          await writable.write(content);
          await writable.close();
          savedItems++;
        }
        setStatus('Dosyalar (' + savedItems + ') klasore kaydedildi.');
      } catch (e) { console.error('Senkronizasyon hatasi:', e); setStatus('Senkronizasyon hatasi. Izinleri kontrol edin.'); }
    }

    function showCanvasBuilding() {
      openCanvas();
      const empty = $('canvas-preview-empty');
      const iframe = $('canvas-iframe');
      if (empty) {
        empty.innerHTML = `
<div class="canvas-building">
  <div class="canvas-building-blocks">
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
  </div>
</div>
<div style="margin-top:16px">
  <div class="text-lg font-bold text-neutral-300 mb-1">Building...</div>
  <div class="text-sm text-neutral-600">Preview will appear when agent is done working</div>
</div>`;
        empty.classList.remove('hidden');
      }
      if (iframe) iframe.classList.add('hidden');
    }

    function finalizeCanvas(content) {
      const hasBlocks = extractCanvasFromResponse(content);
      if (!hasBlocks) return;

      openCanvas();
      renderCanvasFileTree();

      // Auto-select and preview HTML file
      const htmlFile = Object.keys(canvasFiles).find(f => f.endsWith('.html'));
      if (htmlFile) {
        selectCanvasFile(htmlFile);
        updateCanvasPreview(canvasFiles[htmlFile]);
        switchCanvasTab('preview');
      } else {
        const first = Object.keys(canvasFiles)[0];
        if (first) selectCanvasFile(first);
        switchCanvasTab('code');
      }

      const curChat = chats.find(x => x.id === currentChatId);
      if (curChat) { curChat.canvas = JSON.parse(JSON.stringify(canvasFiles)); saveAll(); }
    }

    // ---- Deep Research System
    async function deepResearch(query) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;

      const modA = $('model-a')?.value || 'gpt-4o-mini';
      const activeProv = providerSettings.active || 'puter';

      // Create research steps UI
      const win = $('chat-window');
      const researchDiv = document.createElement('div');
      researchDiv.className = 'flex flex-col gap-2 w-full animate-in';
      researchDiv.id = 'research-progress';
      researchDiv.innerHTML = `
        <div class="flex items-center gap-2.5 px-1">
          <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-[9px] font-bold text-white">DR</div>
          <span class="text-[11px] text-purple-400 font-semibold">Deep Research</span>
        </div>
        <div class="pl-[34px]" id="research-steps"></div>`;
      win.appendChild(researchDiv);
      win.scrollTop = win.scrollHeight;

      const stepsEl = $('research-steps');
      function addStep(title, detail, done) {
        const step = document.createElement('div');
        step.className = `research-step ${done ? 'done' : ''}`;
        step.innerHTML = `<div class="step-title">${escapeHtml(title)}</div><div>${escapeHtml(detail)}</div>`;
        stepsEl.appendChild(step);
        win.scrollTop = win.scrollHeight;
        return step;
      }

      try {
        addStep('Sorgu analiz ediliyor', query, true);
        setStatus('Deep Research: Analiz...');

        const subQPrompt = `Kullanici su konuyu derin arastirmak istiyor: "${query}"\nBu konu hakkinda kapsamli bir arastirma yapmak icin 4-5 alt soru/arastirma konusu olustur. Sadece sorulari numarali liste olarak yaz.`;

        let subQs;
        if (activeProv === 'puter') {
          subQs = await callPuterOnce(modA, [{ role: 'system', content: 'Sen bir arastirma asistanis.' }, { role: 'user', content: subQPrompt }]);
        } else if (activeProv === 'custom') {
          subQs = await callCustomRouter(modA, [{ role: 'system', content: 'Sen bir arastirma asistanis.' }, { role: 'user', content: subQPrompt }]);
        } else if (activeProv === 'anthropic') {
          subQs = await callAnthropicRouter(modA, [{ role: 'system', content: 'Sen bir arastirma asistanis.' }, { role: 'user', content: subQPrompt }]);
        }

        addStep('Alt sorular olusturuldu', subQs.substring(0, 200), true);
        setStatus('Deep Research: Alt sorular...');

        const subQuestions = subQs.split('\n').filter(l => l.trim().match(/^\d/)).slice(0, 4);
        const findings = [];

        for (let i = 0; i < subQuestions.length; i++) {
          const sq = subQuestions[i].replace(/^\d+[\.\)]\s*/, '').trim();
          const stepEl = addStep(`Arastiriliyor (${i + 1}/${subQuestions.length})`, sq, false);
          setStatus(`Deep Research: ${i + 1}/${subQuestions.length}...`);
          const researchPrompt = `Su konu hakkinda detayli bilgi ver: "${sq}" . Kisa ama bilgilendirici ol. Turkce yaz.`;
          let finding;

          if (activeProv === 'puter') {
            finding = await callPuterOnce(modA, [{ role: 'system', content: 'Sen bir arastirma asistanis.' }, { role: 'user', content: researchPrompt }]);
          } else if (activeProv === 'custom') {
            finding = await callCustomRouter(modA, [{ role: 'system', content: 'Sen bir arastirma asistanis.' }, { role: 'user', content: researchPrompt }]);
          } else if (activeProv === 'anthropic') {
            finding = await callAnthropicRouter(modA, [{ role: 'system', content: 'Sen bir arastirma asistanis.' }, { role: 'user', content: researchPrompt }]);
          }

          findings.push({ question: sq, answer: finding });
          stepEl.classList.add('done');
        }

        addStep('Bulgular sentezleniyor...', '', false);
        setStatus('Deep Research: Sentez...');

        const synthesisPrompt = `Kullanicinin sorusu: "${query}"\nAsagidaki arastirma bulgularini kapsamli bir rapor halinde sentezle. Markdown formatinda yaz. Turkce yaz. BULGULAR: ${findings.map((f, i) => `\n### Bulgu ${i + 1}: ${f.question}\n${f.answer}`).join('\n\n')}\nKapsamli sentez raporunu olustur.`;

        let synthesis;
        if (activeProv === 'puter') {
          synthesis = await callPuterOnce(modA, [{ role: 'system', content: 'Sen bir arastirma sentez uzmanis.' }, { role: 'user', content: synthesisPrompt }]);
        } else if (activeProv === 'custom') {
          synthesis = await callCustomRouter(modA, [{ role: 'system', content: 'Sen bir arastirma sentez uzmanis.' }, { role: 'user', content: synthesisPrompt }]);
        } else if (activeProv === 'anthropic') {
          synthesis = await callAnthropicRouter(modA, [{ role: 'system', content: 'Sen bir arastirma sentez uzmanis.' }, { role: 'user', content: synthesisPrompt }]);
        }

        researchDiv.remove();

        const assistantMsg = { role: 'assistant', model: modA + ' (DR)', content: synthesis };
        chat.messages.push(assistantMsg);
        saveAll();
        renderMessages(chat.messages);
        setStatus('Deep Research tamamlandi.');

      } catch (e) {
        researchDiv.remove();
        chat.messages.push({ role: 'assistant', model: 'System', content: `DR Hatasi: ${e.message}` });
        saveAll();
        renderMessages(chat.messages);
        setStatus('Deep Research hatasi.');
      }
    }

    // ---- Agent Mode ----
    let agentActive = false;

    function startAgentMode() {
      const input = $('user-input');
      if (input) {
        input.placeholder = ' Ajan Modu: Gorevi yazin...';
        input.value = 'Ajan modu: ';
        input.focus();
        input.setSelectionRange(input.value.length, input.value.length);
      }
    }

    async function runAgent(query) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;
      agentActive = true;

      const modA = $('model-a')?.value || 'gpt-4o-mini';
      const activeProv = providerSettings.active || 'puter';
      const win = $('chat-window');

      const agentDiv = document.createElement('div');
      agentDiv.className = 'flex flex-col gap-2 w-full animate-in msg-wrap';
      agentDiv.innerHTML = `
        <div class="flex items-center gap-2.5 px-1">
          <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-rose-600 to-orange-600 flex items-center justify-center text-[9px] font-bold text-white"></div>
          <span class="text-[11px] text-rose-400 font-semibold">Ajan Modu</span>
        </div>
        <div class="pl-[34px]">
          <div id="agent-steps" class="space-y-2"></div>
          <div id="agent-status" class="text-[11px] text-neutral-500 mt-2 flex items-center gap-2">
            <div class="w-1.5 h-1.5 bg-rose-500 rounded-full dot-pulse"></div>
            <span>Gorev analiz ediliyor...</span>
          </div>
        </div>`;
      win.appendChild(agentDiv);
      win.scrollTop = win.scrollHeight;

      const stepsEl = agentDiv.querySelector('#agent-steps');
      const statusEl = agentDiv.querySelector('#agent-status span');

      function addAgentStep(title, detail, done = false) {
        const step = document.createElement('div');
        step.className = `p-2.5 rounded-lg border text-[12px] ${done ? 'border-green-800/30 bg-green-900/10' : 'border-[#222] bg-white/[0.02]'}`;
        step.innerHTML = `<div class="flex items-center gap-2 ${done ? 'text-green-400' : 'text-neutral-400'}">
          ${done ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12" /></svg>' : '<div class="w-3 h-3 border border-neutral-600 rounded-sm"></div>'}
          <span class="font-medium">${escapeHtml(title)}</span>
        </div>${detail ? `<div class="text-neutral-600 mt-1 pl-5 text-[11px] leading-relaxed">${escapeHtml(detail).substring(0, 300)}</div>` : ''}`;
        stepsEl.appendChild(step);
        win.scrollTop = win.scrollHeight;
        return step;
      }

      function updateStatus(text) { if (statusEl) statusEl.textContent = text; }

      async function callModel(messages) {
        if (activeProv === 'custom') return await callCustomRouter(modA, messages);
        if (activeProv === 'anthropic') return await callAnthropicRouter(modA, messages);
        return await callPuterOnce(modA, messages);
      }

      try {
        updateStatus('Gorev alt adimlara bolunuyor...');
        addAgentStep('Gorev analizi baslatildi', query);

        const planPrompt = `Sen bir AI ajansin. Gorevi uygulanabilir adimlara bol. SADECE numarali liste ver.\nGorev: "${query}"`;
        let planResult = await callModel([{ role: 'system', content: 'Sen bir uzman planlayicisin.' }, { role: 'user', content: planPrompt }]);

        addAgentStep('Plan olusturuldu', planResult, true);

        const stepLines = (planResult || '').split('\n').filter(l => /^\\d+[\\.\\)]\\s/.test(l.trim()));
        const steps = stepLines.map(l => l.replace(/^\\d+[\\.\\)]\\s*/, '').trim()).filter(s => s.length > 0);
        if (steps.length === 0) steps.push(query);

        let allResults = [];
        for (let i = 0; i < steps.length; i++) {
          const step = steps[i];
          updateStatus(`Adim ${i + 1}/${steps.length}: ${step.substring(0, 30)}...`);
          const currentStepEl = addAgentStep(`Adim ${i + 1}: ${step}`, null);

          const stepPrompt = `Gorev: "${query}"\nMevcut adim: ${step}\n${allResults.length > 0 ? 'Onceki sonuclar:\n' + allResults.map((r, j) => `Adim ${j + 1}: ${r.substring(0, 300)}`).join('\n') : ''}\nBu adimi detayli uygula.`;

          let stepResult = await callModel([{ role: 'system', content: 'Gorevi uygula.' }, { role: 'user', content: stepPrompt }]);
          allResults.push(stepResult || '-');

          currentStepEl.className = 'p-2.5 rounded-lg border text-[12px] border-green-800/30 bg-green-900/10';
          const icon = currentStepEl.querySelector('div:first-child');
          if (icon) {
            icon.className = 'flex items-center gap-2 text-green-400';
            const checkbox = icon.querySelector('div');
            if (checkbox) {
              const checkSvg = document.createElement('span');
              checkSvg.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12" /></svg>';
              checkbox.replaceWith(checkSvg.firstElementChild);
            }
          }
          currentStepEl.querySelector('.text-neutral-600')?.remove();
          const detail = document.createElement('div');
          detail.className = 'text-neutral-600 mt-1 pl-5 text-[11px] leading-relaxed';
          detail.textContent = (stepResult || '').substring(0, 150) + '...';
          currentStepEl.appendChild(detail);
        }

        updateStatus('Sonuclar derleniyor...');
        addAgentStep('Sentezleme asamasina gecildi', null);

        const synthesisPrompt = `Gorev: "${query}"\nAdimlar ve Sonuclari:\n${allResults.map((r, i) => `### Adim ${i + 1}: ${steps[i]}\n${r}`).join('\n\n')}\nSimdi butun bunlari birlestirip son ve tam bir cozum raporu/kod sun.`;
        let finalResult = await callModel([{ role: 'system', content: 'Sentez uzmanisin.' }, { role: 'user', content: synthesisPrompt }]);

        addAgentStep('Sentez tamamlandi', null, true);
        agentDiv.remove();

        chat.messages.push({ role: 'assistant', model: `${modA} (Ajan)`, content: finalResult || '-', timestamp: Date.now() });
        saveAll();
        renderMessages(chat.messages);
        setStatus('Ajan gorevi tamamlandi.');
      } catch (e) {
        agentDiv.remove();
        chat.messages.push({ role: 'assistant', model: 'System', content: `Ajan Hatasi: ${e.message}` });
        saveAll();
        renderMessages(chat.messages);
        setStatus('Ajan hatasi.');
      } finally {
        agentActive = false;
        $('user-input').placeholder = 'Mesajinizi buraya yazin...';
      }
    }

    function renderTableChart(btn) {
      const wrapper = btn.closest('.table-wrapper');
      const table = wrapper.querySelector('table');
      const chartContainer = wrapper.querySelector('.chart-container');
      const canvas = chartContainer.querySelector('canvas');

      if (!table) return;

      if (!chartContainer.classList.contains('hidden')) {
        chartContainer.classList.add('hidden');
        wrapper.querySelector('.overflow-x-auto').classList.remove('hidden');
        btn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg> Grafie evir`;
        return;
      }

      const labels = [];
      const datasetsData = [];
      const rows = Array.from(table.rows);
      if (rows.length < 2) return;

      const headers = Array.from(rows[0].cells).map(c => c.textContent.trim());

      for (let i = 1; i < rows.length; i++) {
        const cells = Array.from(rows[i].cells).map(c => c.textContent.trim());
        labels.push(cells[0] || `Sra ${i}`);

        let rowData = [];
        for (let j = 1; j < Math.max(headers.length, cells.length); j++) {
          let val = parseFloat((cells[j] || "").replace(/[^0-9.-]+/g, ''));
          rowData.push(isNaN(val) ? 0 : val);
        }
        datasetsData.push(rowData);
      }

      const datasets = [];
      const colors = ['#a855f7', '#3b82f6', '#ec4899', '#f59e0b', '#10b981'];
      const numCols = Math.max(1, headers.length - 1);

      for (let j = 1; j <= numCols; j++) {
        const data = datasetsData.map(row => row[j - 1]);
        datasets.push({
          label: headers[j] || `Veri ${j}`,
          data: data,
          backgroundColor: colors[(j - 1) % colors.length] + '80',
          borderColor: colors[(j - 1) % colors.length],
          borderWidth: 2,
          borderRadius: 4
        });
      }

      chartContainer.classList.remove('hidden');
      wrapper.querySelector('.overflow-x-auto').classList.add('hidden');
      btn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" /><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></svg> Tabloya Dn`;

      if (canvas.chartInstance) {
        canvas.chartInstance.destroy();
      }

      chartContainer.style.height = '350px';
      chartContainer.style.position = 'relative';

      canvas.chartInstance = new Chart(canvas, {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#a3a3a3', font: { family: 'Inter', size: 11 } } }
          },
          scales: {
            x: { ticks: { color: '#737373', font: { family: 'Inter', size: 10 } }, grid: { color: '#222', drawBorder: false } },
            y: { ticks: { color: '#737373', font: { family: 'Inter', size: 10 } }, grid: { color: '#222', drawBorder: false } }
          }
        }
      });
    }

    // ===== CUSTOM PERSONA BUILDER =====
    function saveCustomPersona() {
      const name = ($('custom-persona-name').value || '').trim();
      const prompt = ($('custom-persona-prompt').value || '').trim();
      if (!name || !prompt) { setStatus('Persona adi ve talimat gerekli.'); return; }
      stylePrefs.custom = prompt;
      saveAll();
      $('custom-persona-name').value = '';
      $('custom-persona-prompt').value = '';
      closePersonaGallery();
      setStatus('"' + name + '" personasi aktif edildi.');
    }

    // ===== NOTEPAD =====
    let notes = JSON.parse(localStorage.getItem('ai_notes') || '[]');
    let notepadOpen = false;

    function toggleNotepad() {
      notepadOpen = !notepadOpen;
      const panel = $('notepad-panel');
      if (notepadOpen) {
        panel.classList.add('open');
        renderNotes();
      } else {
        panel.classList.remove('open');
      }
    }

    function renderNotes() {
      const body = $('notepad-body');
      if (!body) return;
      const inputHtml = `<textarea id="notepad-new-input" class="notepad-textarea" placeholder="Yeni not ekle... (Enter kaydet, Shift+Enter satiratlama)"></textarea><button onclick="addNote()" style="background:rgba(255,255,255,0.05);border:1px solid #333;border-radius:10px;padding:8px;font-size:11px;font-weight:700;color:#aaa;cursor:pointer;width:100%;transition:all .15s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#aaa'">+ Not Ekle</button>`;
      const notesHtml = notes.slice().reverse().map((n, i) => {
        const realIdx = notes.length - 1 - i;
        return `<div class="notepad-item"><span class="note-del" onclick="deleteNote(${realIdx})">&times;</span><div class="note-ts">${new Date(n.ts).toLocaleDateString('tr-TR', {day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})}</div>${escapeHtml(n.text)}</div>`;
      }).join('');
      body.innerHTML = inputHtml + notesHtml;
      const ta = $('notepad-new-input');
      if (ta) ta.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addNote(); } });
    }

    function addNote(text) {
      const input = $('notepad-new-input');
      const txt = text || (input ? input.value.trim() : '');
      if (!txt) return;
      notes.push({ text: txt, ts: Date.now() });
      localStorage.setItem('ai_notes', JSON.stringify(notes));
      if (input) input.value = '';
      renderNotes();
      setStatus('Not kaydedildi.');
    }

    function addMsgToNote(idx) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat || !chat.messages[idx]) return;
      const content = chat.messages[idx].content;
      const text = typeof content === 'string' ? content.slice(0, 1000) : '';
      if (!notepadOpen) toggleNotepad();
      notes.push({ text: text, ts: Date.now() });
      localStorage.setItem('ai_notes', JSON.stringify(notes));
      renderNotes();
      setStatus('Mesaj nota eklendi.');
    }

    function deleteNote(idx) {
      notes.splice(idx, 1);
      localStorage.setItem('ai_notes', JSON.stringify(notes));
      renderNotes();
    }

    // ===== GLOBAL SEARCH =====
    function openGlobalSearch() {
      const m = $('global-search-modal');
      m.classList.remove('hidden');
      setTimeout(() => m.classList.remove('opacity-0'), 10);
      $('global-search-input').focus();
      $('global-search-input').value = '';
      $('global-search-results').innerHTML = '<div style="color:#555;font-size:13px;text-align:center;padding:32px 0;">Aramak istediginiz kelimeyi girin...</div>';
      if ($('global-search-count')) $('global-search-count').textContent = '';
    }

    function closeGlobalSearch() {
      const m = $('global-search-modal');
      m.classList.add('opacity-0');
      setTimeout(() => m.classList.add('hidden'), 200);
    }

    function runGlobalSearch() {
      const q = ($('global-search-input').value || '').trim().toLowerCase();
      const results = $('global-search-results');
      if (!q) {
        results.innerHTML = '<div style="color:#555;font-size:13px;text-align:center;padding:32px 0;">Aramak istediginiz kelimeyi girin...</div>';
        if ($('global-search-count')) $('global-search-count').textContent = '';
        return;
      }
      const hits = [];
      chats.forEach(chat => {
        chat.messages.forEach((msg, msgIdx) => {
          if (typeof msg.content === 'string' && msg.content.toLowerCase().includes(q)) {
            const lo = msg.content.toLowerCase().indexOf(q);
            const preview = msg.content.slice(Math.max(0, lo - 50), lo + 150);
            hits.push({ chatId: chat.id, chatTitle: chat.title || 'Isimsiz', msgIdx, role: msg.role, preview, ts: msg.timestamp });
          }
        });
      });
      if ($('global-search-count')) $('global-search-count').textContent = hits.length + ' sonuc';
      if (hits.length === 0) {
        results.innerHTML = '<div style="color:#555;font-size:13px;text-align:center;padding:32px 0;">"' + escapeHtml(q) + '" icin sonuc bulunamadi.</div>';
        return;
      }
      results.innerHTML = hits.map(h => `<button class="global-search-result-item" onclick="goToSearchResult('${h.chatId}',${h.msgIdx})"><div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;"><span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:${h.role==='user'?'rgba(37,99,235,0.2)':'rgba(34,197,94,0.15)'};color:${h.role==='user'?'#60a5fa':'#4ade80'}">${h.role==='user'?'Sen':'AI'}</span><span style="font-size:10px;color:#666;flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${escapeHtml(h.chatTitle)}</span>${h.ts?`<span style="font-size:9px;color:#555">${new Date(h.ts).toLocaleDateString('tr-TR')}</span>`:''}</div><div style="font-size:12px;color:#aaa;line-height:1.6;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">...${escapeHtml(h.preview)}...</div></button>`).join('');
    }

    function goToSearchResult(chatId, msgIdx) {
      closeGlobalSearch();
      loadChat(chatId);
      setTimeout(() => {
        const msgs = document.querySelectorAll('#chat-window .msg-wrap');
        if (msgs[msgIdx]) msgs[msgIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 350);
    }

    // ===== SLIDE MAKER =====
    function openSlideModal() {
      const m = $('slide-modal');
      m.classList.remove('hidden');
      setTimeout(() => { m.classList.remove('opacity-0'); m.querySelector('div').classList.remove('scale-95'); }, 10);
    }

    function closeSlideModal() {
      const m = $('slide-modal');
      m.classList.add('opacity-0'); m.querySelector('div').classList.add('scale-95');
      setTimeout(() => m.classList.add('hidden'), 200);
    }

    function setSlideResearch(mode) {
      const qb = $('slide-quick-btn'), db = $('slide-deep-btn');
      if (mode === 'quick') {
        qb.className = 'flex items-center gap-2 p-2.5 rounded-xl border border-blue-500/40 bg-blue-600/15 cursor-pointer transition-all';
        db.className = 'flex items-center gap-2 p-2.5 rounded-xl border border-[#333] cursor-pointer transition-all';
      } else {
        db.className = 'flex items-center gap-2 p-2.5 rounded-xl border border-amber-500/40 bg-amber-600/10 cursor-pointer transition-all';
        qb.className = 'flex items-center gap-2 p-2.5 rounded-xl border border-[#333] cursor-pointer transition-all';
      }
    }

    function updateSlideFormatHint(val) {
      const hint = $('slide-format-hint');
      if (!hint) return;
      if (val === 'pptx') hint.textContent = 'PPTX: AI icerik olusturacak, otomatik olarak .pptx dosyasi indirilecek.';
      else hint.textContent = 'HTML: Canvas panelinde canli onizleme ile acilir.';
    }

    function generateSlides() {
      const topic = ($('slide-topic').value || '').trim();
      const count = $('slide-count').value || '8';
      const style = $('slide-style').value || 'modern';
      const lang = $('slide-lang').value || 'tr';
      const format = ($('slide-format') ? $('slide-format').value : 'html');
      const researchMode = document.querySelector('input[name="slide-research"]:checked')?.value || 'quick';
      if (!topic) { setStatus('Lutfen konu girin.'); $('slide-topic').focus(); return; }
      closeSlideModal();

      const langInstr = lang === 'en' ? 'Write all content in English.' : 'Tum icerik Turkce olsun.';
      const researchPrefix = researchMode === 'deep' ? 'Derin arastirma modu: ' : '';

      if (format === 'pptx') {
        _noCanvas = true;
        _pptxMode = true;
        const styleMap = { modern:'sade ve profesyonel', corporate:'kurumsal ve resmi', creative:'yaratici ve dinamik', academic:'akademik ve sade' };
        const pptxPrompt = `${researchPrefix}Asagidaki konu icin ${count} slaytlik bir sunum icerigi hazirla. SADECE JSON ver, hicbir aciklama ekleme:\n\nKonu: ${topic}\nStil: ${styleMap[style] || 'modern'}\n${langInstr}\n\n{"title":"Sunum Basligi","subtitle":"Alt baslik veya tarih","color":"2563eb","slides":[{"title":"Slayt Basligi","icon":"","bullets":["Madde 1","Madde 2","Madde 3","Madde 4"],"notes":"Konusmaci notu","keyword":"Gorselde kullanilacak Pexels anahtar kelime (Ingilizce)"},...]}\n\nKurall:\n- Her slayt icin 3-5 madde noktasi\n- Her slayt icin uygun bir emoji icon sec\n- keyword alani konuyla alakali Pexels gorsel arama terimi olsun (ornek: "technology future", "climate change", "business team")\n- color alani konuya uygun hex renk kodu (# olmadan)\n- Son slayt baslik "Tesekkurler" veya "Sorular" olsun`;
        $('user-input').value = pptxPrompt;
      } else {
        const styleMap = {
          modern: 'sleek dark theme, deep navy/slate background (#0a0f1e), bright accent colors (#38bdf8, #818cf8), bold sans-serif typography, glassmorphism cards',
          corporate: 'clean white/light gray background (#f8fafc), navy/slate text, blue accent (#1e40af), professional grid layout, subtle shadows',
          creative: 'vibrant gradient backgrounds (purple to pink to orange), bold typography, large abstract shapes, energetic and dynamic',
          academic: 'clean white background, serif headings, academic blue (#1e3a5f), structured layout with clear hierarchy'
        };
        const pexelsHint = lang === 'en' ? 'Use Pexels stock photo URLs as background images for slides. Example: https://images.pexels.com/photos/[ID]/pexels-photo-[ID].jpeg?auto=compress&cs=tinysrgb&w=1920' : 'Her slayt icin Pexels stok fotograf URLlerini arka plan olarak kullan. Ornek: https://images.pexels.com/photos/[ID]/pexels-photo-[ID].jpeg?auto=compress&cs=tinysrgb&w=1920';
        const prompt = `${researchPrefix}Asagidaki konu icin ${count} slaytlik, GORSELLI, ANIMASYONLU, son derece sik ve profesyonel bir HTML sunumu olustur:\n\nKonu: ${topic}\nStil: ${styleMap[style] || styleMap.modern}\n${langInstr}\n\nKESINLIKLE UYULMASI GEREKEN TASARIM KURALLARI:\n1. Her slayt tam ekran (100vw x 100vh), overflow:hidden\n2. Her slayta farkli, konuyla alakali Pexels gorsel URL kullan (background-image olarak) + koyu gradient overlay (rgba(0,0,0,0.55) to rgba(10,15,40,0.85))\n3. ${pexelsHint}\n4. Slayt degisim animasyonlari: CSS transitions ile slide/fade efekti\n5. Her slayt icin: buyuk baslik (4-5rem), alt cizgi aksan (gradient), 3-5 madde her biri soldan kayarak gelen animasyonla\n6. Madde noktalari guzel ikonlarla (CSS veya unicode emoji)\n7. Sag alt kose slayt numarasi ve ilerleme cubugu\n8. Klavye oklari + tiklama + swipe ile gecis\n9. Ilk slayt: tam sayfa hero, buyuk baslik, alt baslik, buton\n10. Son slayt: tesekkur/sorular sayfasi\n11. Smooth scroll progress bar en ustte\n12. TUM CSS ve JS inline, sadece tek HTML dosyasi\n13. Mobil responsive\nSadece HTML dosyasini ver, aciklama ekleme.`;
        $('user-input').value = prompt;
      }
      handleSend();
    }

    // ===== REPORT MAKER =====
    function openReportModal() {
      const m = $('report-modal');
      m.classList.remove('hidden');
      setTimeout(() => { m.classList.remove('opacity-0'); m.querySelector('div').classList.remove('scale-95'); }, 10);
    }

    function closeReportModal() {
      const m = $('report-modal');
      m.classList.add('opacity-0'); m.querySelector('div').classList.add('scale-95');
      setTimeout(() => m.classList.add('hidden'), 200);
    }

    function setReportResearch(mode) {
      const qb = $('report-quick-btn'), db = $('report-deep-btn');
      if (mode === 'quick') {
        qb.className = 'flex items-center gap-2 p-2.5 rounded-xl border border-blue-500/40 bg-blue-600/15 cursor-pointer transition-all';
        db.className = 'flex items-center gap-2 p-2.5 rounded-xl border border-[#333] cursor-pointer transition-all';
      } else {
        db.className = 'flex items-center gap-2 p-2.5 rounded-xl border border-amber-500/40 bg-amber-600/10 cursor-pointer transition-all';
        qb.className = 'flex items-center gap-2 p-2.5 rounded-xl border border-[#333] cursor-pointer transition-all';
      }
    }

    function generateReport() {
      const topic = ($('report-topic').value || '').trim();
      const type = $('report-type').value || 'academic';
      const extra = ($('report-sections').value || '').trim();
      const length = $('report-length').value || 'medium';
      const researchMode = document.querySelector('input[name="report-research"]:checked')?.value || 'quick';
      if (!topic) { setStatus('Lutfen konu girin.'); $('report-topic').focus(); return; }
      closeReportModal();
      _noCanvas = true;
      const researchPrefix = researchMode === 'deep' ? 'Derin arastirma modu: ' : '';
      const typeMap = {
        academic: 'Akademik makale: Ozet, Giris, Literatur Taramasi, Yontem, Bulgular, Tartisma, Sonuc, Kaynakca',
        business: 'Is raporu: Yonetici Ozeti, Durum Analizi, Veri ve Metrikler, Oneriler, Eylem Plani, Ekler',
        technical: 'Teknik dokumantasyon: Genel Bakis, Mimari, Gereksinimler, Kurulum, Kullanim, Sorun Giderme, API',
        research: 'Arastirma raporu: Problem Tanimi, Kapsam ve Sinirlamalar, Metodoloji, Bulgular, Analiz, Sonuc ve Oneriler',
        analysis: 'Pazar analizi: Piyasa Genel Bakisi, Hedef Kitle, Rekabet Analizi, SWOT, Firsatlar ve Tehditler, Strateji Onerileri'
      };
      const lengthMap = { short:'~800 kelime', medium:'~1500 kelime', long:'~3000 kelime', comprehensive:'~5000 kelime veya daha fazla' };
      const extraSection = extra ? `\nEk olarak su bolumler de eklensin: ${extra}` : '';
      const prompt = `${researchPrefix}Asagidaki konu icin kapsamli ve profesyonel bir rapor hazirla:\n\nKonu: ${topic}\nFormat: ${typeMap[type]}${extraSection}\nHedef uzunluk: ${lengthMap[length]}\n\nONEMLI GEREKSINIMLER:\n- Markdown formatinda yaz (## basliklar, ### alt basliklar, maddeler, tablolar)\n- Her bolum en az 2-3 paragraf, derinlemesine icerik\n- Somut veriler, istatistikler ve gercekci ornekler kullan\n- Profesyonel Turkce dil kullan\n- Tablolar ve listeler ile verileri organize et\n- Bolumler arasi akis ve baglanti kur\n- Giris paragrafinda raporun amaci ve kapsamini acikla\n- Sonuc bolumunde ana bulgulari ozetle ve oneride bulun`;
      $('user-input').value = prompt;
      handleSend();
    }

    // ===== SLIDE PREVIEW =====
    let _pendingPptxData = null;

    function showSlidePreview(data) {
      _pendingPptxData = data;
      const modal = $('slide-preview-modal');
      if (!modal) return;
      const titleEl = $('slide-preview-title');
      const countEl = $('slide-preview-count');
      const grid = $('slide-preview-grid');
      if (titleEl) titleEl.textContent = data.title || 'Sunum Onizlemesi';
      if (countEl) countEl.textContent = (data.slides ? data.slides.length : 0) + ' slayt';
      if (grid) {
        const accent = '#' + ((data.color || '2563eb').replace('#',''));
        let html = `<div style="grid-column:1/-1;background:#060d1f;border:1px solid #1e293b;border-radius:12px;padding:24px 28px;display:flex;flex-direction:column;justify-content:center;min-height:160px;position:relative;overflow:hidden">
          <div style="position:absolute;top:0;left:0;width:6px;height:100%;background:${accent};border-radius:4px 0 0 4px"></div>
          <div style="font-size:22px;font-weight:700;color:#fff;margin-bottom:8px;padding-left:16px">${(data.title||'').replace(/</g,'&lt;')}</div>
          ${data.subtitle ? `<div style="font-size:14px;color:#94a3b8;padding-left:16px">${data.subtitle.replace(/</g,'&lt;')}</div>` : ''}
          <div style="position:absolute;bottom:12px;right:16px;font-size:11px;color:${accent};font-weight:700">KAPAK</div>
        </div>`;
        (data.slides || []).forEach((slide, i) => {
          const bullets = Array.isArray(slide.bullets) ? slide.bullets : [];
          const bgImg = slide.backgroundImage || slide.bgImage || slide.image || '';
          html += `<div style="background:${i%2===0?'#060d1f':'#0d1a35'};border:1px solid #1e293b;border-radius:12px;overflow:hidden;position:relative;${bgImg?`background-image:url('${bgImg}');background-size:cover;background-position:center`:''};min-height:180px">
            ${bgImg ? `<div style="position:absolute;inset:0;background:rgba(6,13,31,0.82);border-radius:12px"></div>` : ''}
            <div style="position:relative;z-index:1;padding:16px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                ${slide.icon ? `<span style="font-size:18px">${slide.icon}</span>` : ''}
                <div style="font-size:13px;font-weight:700;color:#fff">${(slide.title||'').replace(/</g,'&lt;')}</div>
              </div>
              <div style="width:40px;height:3px;background:${accent};border-radius:2px;margin-bottom:10px"></div>
              <ul style="margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:5px">
                ${bullets.slice(0,4).map(b=>`<li style="font-size:11px;color:#cbd5e1;display:flex;align-items:flex-start;gap:6px"><span style="color:${accent};font-weight:700;margin-top:1px">&#x25B8;</span><span>${b.replace(/</g,'&lt;')}</span></li>`).join('')}
                ${bullets.length>4?`<li style="font-size:10px;color:#475569">+${bullets.length-4} madde daha...</li>`:''}
              </ul>
            </div>
            <div style="position:absolute;bottom:8px;right:10px;font-size:10px;color:#475569;font-weight:600">${i+1}/${data.slides.length}</div>
          </div>`;
        });
        html += `<div style="background:#060d1f;border:1px solid #1e293b;border-radius:12px;padding:24px;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:120px">
          <div style="font-size:24px;font-weight:700;color:#fff;margin-bottom:6px">Tesekkurler</div>
          <div style="width:60px;height:3px;background:${accent};border-radius:2px;margin-bottom:8px"></div>
          <div style="font-size:13px;color:#94a3b8">Sorulariniz?</div>
        </div>`;
        grid.innerHTML = html;
      }
      modal.classList.remove('hidden');
    }

    function closeSlidePreview() {
      const modal = $('slide-preview-modal');
      if (modal) modal.classList.add('hidden');
    }

    async function downloadPptxFromPreview() {
      if (!_pendingPptxData) return;
      const btn = $('slide-preview-dl-btn');
      if (btn) { btn.textContent = 'Hazirlaniyor...'; btn.disabled = true; }
      await buildAndDownloadPptx(_pendingPptxData);
      if (btn) { btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>PPTX Indir'; btn.disabled = false; }
    }

    async function fetchImageAsBase64(url) {
      try {
        const resp = await fetch(url);
        if (!resp.ok) return null;
        const blob = await resp.blob();
        return new Promise(resolve => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch(e) { return null; }
    }

    // ===== PPTX GENERATION =====
    async function generatePptxFromContent(content) {
      let data = null;
      const jsonMatch = content.match(/\{[\s\S]*?"slides"\s*:\s*\[[\s\S]*?\]\s*\}/);
      if (jsonMatch) {
        try { data = JSON.parse(jsonMatch[0]); } catch(e) {
          try { data = JSON.parse(jsonMatch[0].replace(/[\u0000-\u001F\u007F]/g, ' ')); } catch(e2) { data = null; }
        }
      }
      if (!data || !Array.isArray(data.slides) || data.slides.length === 0) {
        setStatus('PPTX: JSON ayristirilamadi.');
        return;
      }
      showSlidePreview(data);
      setStatus('Onizleme hazir. PPTX indirmek icin "PPTX Indir" butonuna basin.');
    }

    async function buildAndDownloadPptx(data) {
      try {
        if (typeof PptxGenJS === 'undefined') { setStatus('PPTX kutuphanesi yukleniyor, tekrar deneyin.'); return; }
        setStatus('PPTX olusturuluyor...');
        const pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_WIDE';

        const accent = (data.color || '2563eb').replace('#', '');
        const darkBg = '060d1f';
        const darkBg2 = '0d1a35';
        const textLight = 'e2e8f0';
        const textMuted = '94a3b8';

        const titleSlide = pptx.addSlide();
        titleSlide.background = { color: darkBg };
        titleSlide.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: '100%', h: '100%', fill: { color: darkBg } });
        titleSlide.addShape(pptx.ShapeType.rect, { x: 0, y: 5.8, w: '100%', h: 1.7, fill: { color: accent, transparency: 85 } });
        titleSlide.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: 0.08, h: '100%', fill: { color: accent } });
        titleSlide.addShape(pptx.ShapeType.rect, { x: 0, y: 3.5, w: 2.5, h: 0.06, fill: { color: accent } });
        titleSlide.addText(data.title || 'Sunum', { x: 0.5, y: 1.2, w: '85%', h: 1.8, fontSize: 42, bold: true, color: 'FFFFFF', align: 'left', fontFace: 'Calibri' });
        if (data.subtitle) titleSlide.addText(data.subtitle, { x: 0.5, y: 3.1, w: '75%', h: 0.5, fontSize: 18, color: textMuted, align: 'left', fontFace: 'Calibri' });
        titleSlide.addText(`${data.slides.length} Slayt`, { x: 0.5, y: 6.1, w: 3, h: 0.4, fontSize: 12, color: accent, align: 'left', fontFace: 'Calibri', bold: true });

        for (let i = 0; i < data.slides.length; i++) {
          const slide = data.slides[i];
          const s = pptx.addSlide();
          const bg = i % 2 === 0 ? darkBg : darkBg2;
          const bgImgUrl = slide.backgroundImage || slide.bgImage || slide.image || '';
          if (bgImgUrl) {
            const b64 = await fetchImageAsBase64(bgImgUrl);
            if (b64) {
              s.background = { data: b64 };
              s.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: '100%', h: '100%', fill: { color: '000000', transparency: 55 } });
            } else { s.background = { color: bg }; }
          } else { s.background = { color: bg }; }
          s.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: 0.06, h: '100%', fill: { color: accent } });
          s.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: '100%', h: 1.2, fill: { color: '000000', transparency: 60 } });
          const icon = slide.icon || '';
          if (icon) s.addText(icon, { x: 0.3, y: 0.22, w: 0.7, h: 0.7, fontSize: 26, align: 'center' });
          s.addText(slide.title || '', { x: icon ? 1.0 : 0.35, y: 0.18, w: '82%', h: 0.85, fontSize: 24, bold: true, color: 'FFFFFF', align: 'left', fontFace: 'Calibri' });
          s.addShape(pptx.ShapeType.rect, { x: 0.35, y: 1.2, w: 3.0, h: 0.04, fill: { color: accent } });
          const bullets = Array.isArray(slide.bullets) ? slide.bullets : [];
          if (bullets.length > 0) {
            const rows = bullets.map((b, bi) => ([
              { text: ['','','','','',''][bi] || '', options: { color: accent, fontSize: 14, bold: true, align: 'center' } },
              { text: b, options: { color: textLight, fontSize: 15, fontFace: 'Calibri' } }
            ]));
            s.addTable(rows, { x: 0.35, y: 1.4, w: 9.2, h: Math.min(4.5, bullets.length * 0.9), colW: [0.45, 8.75], border: { type: 'none' }, fill: { color: bgImgUrl ? '00000000' : bg, transparency: bgImgUrl ? 100 : 0 } });
          }
          const total = data.slides.length;
          const prog = ((i + 1) / total) * 9.14;
          s.addShape(pptx.ShapeType.rect, { x: 0.08, y: 7.35, w: 9.14, h: 0.06, fill: { color: '1e293b' } });
          s.addShape(pptx.ShapeType.rect, { x: 0.08, y: 7.35, w: prog, h: 0.06, fill: { color: accent } });
          s.addText(`${i + 1} / ${total}`, { x: 8.8, y: 7.15, w: 0.6, h: 0.25, fontSize: 9, color: textMuted, align: 'right' });
          if (slide.notes) s.addNotes(slide.notes);
        }

        const lastS = pptx.addSlide();
        lastS.background = { color: darkBg };
        lastS.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: '100%', h: '100%', fill: { color: darkBg } });
        lastS.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: 0.08, h: '100%', fill: { color: accent } });
        lastS.addShape(pptx.ShapeType.rect, { x: 3.0, y: 3.8, w: 4.14, h: 0.06, fill: { color: accent } });
        lastS.addText('Tesekkurler', { x: 0.5, y: 1.8, w: '90%', h: 1.5, fontSize: 46, bold: true, color: 'FFFFFF', align: 'center', fontFace: 'Calibri' });
        lastS.addText('Sorulariniz?', { x: 0.5, y: 3.3, w: '90%', h: 0.6, fontSize: 20, color: textMuted, align: 'center', fontFace: 'Calibri' });
        lastS.addText(data.title || '', { x: 0.5, y: 6.0, w: '90%', h: 0.4, fontSize: 11, color: accent, align: 'center' });

        const filename = (data.title || 'sunum').replace(/[^a-z0-9\s\u00C0-\u024F]/gi, '').trim().replace(/\s+/g, '_') || 'sunum';
        const blob = await pptx.write({ outputType: 'blob' });
        const blobUrl = URL.createObjectURL(blob);

        const chat = chats.find(c => c.id === currentChatId);
        if (chat) {
          for (let i = chat.messages.length - 1; i >= 0; i--) {
            if (chat.messages[i].role === 'assistant' && typeof chat.messages[i].content === 'string' && !chat.messages[i].content.startsWith('__PPTX_DOWNLOAD__')) {
              chat.messages.splice(i, 1);
              break;
            }
          }
          const dlMsg = {
            role: 'assistant',
            content: `__PPTX_DOWNLOAD__${blobUrl}__FILENAME__${filename}.pptx__TITLE__${data.title || 'Sunum'}__SLIDES__${data.slides.length}`,
            model: 'system',
            ts: Date.now()
          };
          chat.messages.push(dlMsg);
          renderMessages(chat.messages);
          hideWelcome();
          const win = $('chat-window');
          if (win) setTimeout(() => { win.scrollTop = win.scrollHeight; }, 100);
        }
        closeSlidePreview();
        setStatus('PPTX hazir!');
      } catch(e) {
        setStatus('PPTX olusturma hatasi: ' + e.message);
        console.error(e);
      }
    }

    // ===== EDIT MESSAGE MODAL =====
    let _editMsgIdx = -1;

    function openEditModal(idx) {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat || !chat.messages[idx]) return;
      _editMsgIdx = idx;
      const ta = $('edit-msg-textarea');
      if (ta) ta.value = typeof chat.messages[idx].content === 'string' ? chat.messages[idx].content : '';
      const m = $('edit-msg-modal');
      m.classList.remove('hidden');
      if (ta) setTimeout(() => { ta.focus(); ta.selectionStart = ta.value.length; }, 50);
    }

    function closeEditModal() {
      $('edit-msg-modal').classList.add('hidden');
      _editMsgIdx = -1;
    }

    function confirmEditMessage() {
      const ta = $('edit-msg-textarea');
      const newText = (ta ? ta.value : '').trim();
      if (!newText || _editMsgIdx < 0) { closeEditModal(); return; }
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) { closeEditModal(); return; }
      closeEditModal();
      chat.messages = chat.messages.slice(0, _editMsgIdx);
      saveAll();
      $('user-input').value = newText;
      renderMessages(chat.messages);
      if (chat.messages.length === 0) showWelcome();
      handleSend();
    }

    boot();
  </script>
</body>

</html>